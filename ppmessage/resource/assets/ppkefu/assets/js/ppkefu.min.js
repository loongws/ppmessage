function $yvUtilService(e){return{uuid:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:7&n|8).toString(16)});return t},is_valid_email:function(e){var t=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return t.test(e)},base64_decode:function(t){return e.decode(t)},base64_encode:function(t){return e.encode(t)},regexp_check:function(e){var t=RegExp("[\\u4E00-\\u9FFF\\dA-z@-_\\s*]+","i");if(!e||!e.match(t))return!1;var n=e.match(t).toString().length;return n==e.length}}}window.ppmessage={version:"1.1.2",developer_mode:!1,api_key:"Yzc3YjRlZGJkYjFmYjEzY2E5MzI1MjI3NzZlMGNiMGYzNmMwMWJmYw==",disableOnbeforeunload:!1};var ppmessageModule=angular.module("ppmessage",["ionic","base64","blockUI","ngCookies","ngSanitize","angularFileUpload","pascalprecht.translate"]);ppmessageModule.config(["$sceProvider","blockUIConfig","$ionicConfigProvider",function(e,t,n){e.enabled(!1),t.autoBlock=!1,t.autoInjectBodyBlock=!0,n.views.maxCache(10),n.views.swipeBackEnabled(!1),n.tabs.position("bottom"),n.tabs.style("standard"),n.backButton.text(""),window.cordova&&ionic.Platform.isAndroid()&&(ionic.Platform.fullScreen(!0,!1),n.scrolling.jsScrolling(!1))}]).run(["$state","$timeout","$rootScope","$ionicPlatform","yvSys","yvMenu","yvLocal","yvMonitor",function(e,t,n,o,i,r,a,s){a.localize(),r.init(),ppmessage.developer_mode&&(ppmessage.monitor=s),i.in_pc_browser()&&(window.onresize=function(){t(function(){n.getAppBodyStyle()})},window.onbeforeunload=function(t){return ppmessage.disableOnbeforeunload?void(ppmessage.disableOnbeforeunload=!1):void(!ppmessage.developer_mode&&e.includes("app.*")&&(t.returnValue=a.translate("app.GLOBAL.ON_BEFORE_UNLOAD_WARNING")))}),n.getAppBodyStyle=function(){return i.get_app_body_style()},n.getDeviceClass=function(){return i.in_mobile_browser()?"in-mobile-browser":i.in_pc_browser()?"in-pc-browser":i.in_electron()?"in-electron":i.in_mobile_app()?"in-mobile-app":void 0},o.ready(function(){window.cordova&&(ionic.Platform.isAndroid()&&(i.hide_statusbar(),angular.element(document).click(function(){i.hide_statusbar()}),window.addEventListener("native.keyboardhide",i.hide_statusbar,!1),window.onresize=i.hide_statusbar),window.cordova&&cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.cordova&&cordova.getAppVersion&&i.set_bundle_info(),window.cordova&&navigator.connection&&(document.addEventListener("online",i.device_online,!1),document.addEventListener("offline",i.device_offline,!1)))})}]).constant("$ionicLoadingConfig",{noBackdrop:!0,hideOnStateChange:!0,template:"<ion-spinner></ion-spinner>"}),ppmessageModule.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("main-with-logo",{cache:!1,controller:"MainWithLogoCtrl",url:"/main-with-logo",templateUrl:"templates/controllers/noapp.main-with-logo.html"}).state("noapp",{"abstract":!0,controller:"NoAppCtrl",url:"/noapp",templateUrl:"templates/controllers/noapp.html"}).state("noapp.login-error",{cache:!1,controller:"LoginErrorCtrl",url:"/login-error",templateUrl:"templates/controllers/noapp.login-error.html"}).state("noapp.auto-login",{cache:!1,controller:"AutoLoginCtrl",url:"/auto-login/:request_body",templateUrl:"templates/controllers/noapp.auto-login.html"}).state("noapp.login-no-user",{controller:"LoginNoUserCtrl",url:"/login-no-user",templateUrl:"templates/controllers/noapp.login-no-user.html"}).state("noapp.login-with-user",{controller:"LoginWithUserCtrl",url:"/login-with-user/",templateUrl:"templates/controllers/noapp.login-with-user.html",params:{email:null,fullname:null,icon:null}}).state("noapp.switch-server",{cache:!1,controller:"SwitchServerCtrl",url:"/switch-server",templateUrl:"templates/controllers/noapp.switch-server.html"}).state("noapp.add-server",{controller:"AddServerCtrl",url:"/add-server",templateUrl:"templates/controllers/noapp.add-server.html"}).state("app",{"abstract":!0,url:"/app",templateUrl:"templates/controllers/app.html",controller:"AppCtrl"}).state("app.conversation-list",{url:"/conversation-list",views:{"app-conversation-list":{templateUrl:"templates/controllers/app.conversation-list.html",controller:"ConversationListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.conversation.html",controller:"ConversationCtrl"}},params:{conv_uuid:null,conv_type:null,conv_name:null}}).state("app.contact-list",{url:"/contact-list",views:{"app-contact-list":{templateUrl:"templates/controllers/app.contact-list.html",controller:"ContactListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.contact.html",controller:"ContactCtrl"}},params:{contact_uuid:null}}).state("app.setting-list",{url:"/setting-list",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.blank-setting.html"}}}).state("app.change-avatar",{url:"/change-avatar",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.change-avatar.html",controller:"ChangeAvatarCtrl"}}}).state("app.change-password",{url:"/change-password",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.change-password.html",controller:"ChangePasswordCtrl"}}}).state("app.change-fullname",{url:"/change-fullname",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.change-fullname.html",controller:"ChangeFullnameCtrl"}}}).state("app.change-signature",{url:"/change-signature",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.change-signature.html",controller:"ChangeSignatureCtrl"}}}).state("app.push-notification",{url:"/push-notification",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.push-notification.html",controller:"PushNotificationCtrl"}}}).state("app.switch-language",{url:"/switch-language",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.switch-language.html",controller:"SwitchLanguageCtrl"}}}).state("app.switch-app",{url:"/switch-app",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.switch-app.html",controller:"SwitchAppCtrl"}}}).state("app.about",{cache:!1,url:"/about",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"},"side-menu-content":{templateUrl:"templates/controllers/app.about.html",controller:"AboutCtrl"}}}).state("app.conversation-list-mobile",{url:"/conversation-list-mobile",views:{"app-conversation-list":{templateUrl:"templates/controllers/app.conversation-list-mobile.html",controller:"ConversationListCtrl"}},params:{conv_uuid:null,conv_type:null,conv_name:null}}).state("app.contact-list-mobile",{url:"/contact-list-mobile",views:{"app-contact-list":{templateUrl:"templates/controllers/app.contact-list-mobile.html",controller:"ContactListCtrl"}},params:{contact_uuid:null}}).state("app.setting-list-mobile",{url:"/setting-list-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.setting-list.html",controller:"SettingListCtrl"}}}).state("app.conversation-mobile",{url:"/conversation-mobile",views:{"app-conversation-list":{templateUrl:"templates/controllers/app.conversation.html",controller:"ConversationCtrl"}},params:{conv_uuid:null,conv_type:null,user_uuid:null}}).state("app.contact-mobile",{url:"/contact-mobile",views:{"app-contact-list":{templateUrl:"templates/controllers/app.contact.html",controller:"ContactCtrl"}},params:{contact_uuid:null}}).state("app.change-avatar-mobile",{url:"/change-avatar-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.change-avatar.html",controller:"ChangeAvatarCtrl"}}}).state("app.change-password-mobile",{url:"/change-password-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.change-password.html",controller:"ChangePasswordCtrl"}}}).state("app.change-fullname-mobile",{url:"/change-fullname-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.change-fullname.html",controller:"ChangeFullnameCtrl"}}}).state("app.change-signature-mobile",{url:"/change-signature-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.change-signature.html",controller:"ChangeSignatureCtrl"}}}).state("app.push-notification-mobile",{url:"/push-notification-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.push-notification.html",controller:"PushNotificationCtrl"}}}).state("app.switch-language-mobile",{url:"/switch-language-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.switch-language.html",controller:"SwitchLanguageCtrl"}}}).state("app.switch-app-mobile",{url:"/switch-app-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.switch-app.html",controller:"SwitchAppCtrl"}}}).state("app.about-mobile",{url:"/about-mobile",views:{"app-setting-list":{templateUrl:"templates/controllers/app.about.html",controller:"AboutCtrl"}}}),t.otherwise("/main-with-logo")}]),ppmessageModule.config(["$translateProvider","yvTransTags",function(e,t){e.useSanitizeValueStrategy("escape"),e.translations("en",t.en),e.translations("zh-CN",t.cn),e.registerAvailableLanguageKeys(["en","zh-CN"],{en:"en","en-US":"en","en-UK":"en","zh-CN":"zh-CN",zh_CN:"zh-CN","zh-cn":"zh-CN","zh-Hans":"zh-CN"}),e.fallbackLanguage("en","zh-CN")}]).constant("yvTransTags",{en:{noapp:{LOGIN_TAG:"Log In",USERNAME_TAG:"Username",USEREMAIL_TAG:"User email",PASSWORD_TAG:"Password",LOGIN_CANCEL_TAG:"Cancel",serverList:{SERVER_LIST:"Servers"},addServer:{ADD_SERVER_TAG:"Add Server",SERVER_NAME:"Name",SERVER_PROTOCOL:"Protocol",SERVER_HOST:"Host",SERVER_PORT:"Port",SERVER_NAME_NOTE:"Any name",SERVER_PROTOCOL_NOTE:"http:// or https://",SERVER_HOST_NOTE:"192.168.0.1, ppmessage.cn",SERVER_PORT_NOTE:"80, 8080",USE_HTTPS_PROTOCOL:"Use https protocol",SET_DEFAULT_SERVER_TAG:"Set as default server"},loginWithUser:{LOGIN_TAG:"Log In",LOGIN_PASSWORD_TAG:"Password",SWITCH_USER_TAG:"Switch User"},switchServer:{DELETE_SERVER_TAG:"Delete"},register:{REGISTER:"Register",REGISTER_BY_MOBILE:"Register by phone number",INPUT_VERIFY_CODE:"Verification Code",INPUT_MOBILE:"Phone Number",INPUT_USER_EMAIL:"Email Account",INPUT_USER_NAME:"Display Name",INPUT_USER_PWD:"Password",INPUT_USER_PWD_CONFIRM:"Confirm Password",BUTTON_GET_VERIFY_CODE:"Get Verification Code",ALERT_ILLEGAL_EMAIL:"Invalid email",ALERT_ILLEGAL_CONFIRM_PWD:"Passwords do not match",ALERT_ILLEGAL_PASSWORD_LENGTH:"Password is too long",ALERT_ILLEGAL_CONTAINS_SPACE:"Password must not contain space",ALERT_ILLEGAL_VERIFY_CODE:"Error verification code",ALERT_ILLEGAL_PHONE_NUMBER:"Invalid phone number",ALERT_REGISTER_SUCCESSFUL:"Registered successful",ALERT_REGISTER_FAILED:"Registered failed",ALERT_REGISTER_FAILED_EMAIL_EXISTED:"Registered failed: This email has already been registered.",ALERT_REGISTER_FAILED_MOBILE_EXISTED:"Registered failed: This phone number has already been registered."}},app:{common:{SAVE_TAG:"Save",RESTORE_TAG:"Restore",CANCEL_TAG:"Cancel",OK_TAG:"OK",BACK_TAG:"Back"},settings:{SETTINGS_TAG:"Settings",LOG_OUT_TAG:"Log Out",APPLICATION_TAG:"App",profile_photo:{LOADING_TAG:"Loading image...",PROFILE_PHOTO_TAG:"Profile Photo",TAKE_PHOTO_TAG:"Take Photo",CHOOSE_FROM_PHOTOS_TAG:"Choose from Photos"},name:{NAME_TAG:"Name",INPUT_NEW_NAME_TAG:"Please input your new name"},signature:{SIGNATURE_TAG:"Signature",WRITE_SOMETHING:"Write something"},password:{PASSWORD_TAG:"Password",INPUT_ORIGIN_PASSWORD_TAG:"Input your original password",INPUT_NEW_PASSWORD_TAG:"Input your new password",INPUT_NEW_PASSWORD_AGAIN_TAG:"Input your new password again"},push_noti:{PUSH_NOTIFICATION_TAG:"Notifications"},language:{LANGUAGE_TAG:"Language",CHINESE_TAG:"中文",ENGLISH_TAG:"English"},app:{APP_TAG:"App"},about:{ABOUT_TAG:"About",CANT_GET_NEWEST_VERSION_TAG:"Can't get application version",IS_NEWEST_VERSION_TAG:"Already at latest version",UPGRADE_TO_VERSION_TAG:"Upgrade to version "},integrate:{INTEGRATE_TAG:"Application Integration"}},messages:{MESSAGE_TAG:"Messages",CONVERSATIONS_TAG:"Conversations",MARK_AS_READ_TAG:"Mark as read",DELETE:"Delete",ALL:"All",UNASSIGNED:"Unassigned",MINE:"Mine"},contact:{CONTACT_TAG:"Contacts",SERVICE_TAG:"Services",SEARCH_TAG:"Search",ORGANIZATION_TAG:"Organizations",DISCUSSION_TAG:"Discussions",NEW_FRIENDS_TAG:"New Friends",SERVANT:"Servants",CUSTOMER:"Customer"},newFriends:{MESSAGE_TAG:"New Friends",NO_NEW_INVITATIONS:"Empty invitations",RECEIVE_INVITE_TAG:"Agree",ADDED_TAG:"Approved",DELETE_TAG:"Delete",REQUEST_JOIN_OG:"I want to join organization: ",APPROVE_JOIN_OG_FAILED:"Can not agree, please try again later"},organization:{ORGANIZATION_TAG:"Organizations",SEARCH_HINT_TAG:"Search"},discussion:{DISCUSSION_TAG:"Discussions",SEARCH_HINT_TAG:"Search"},makeDiscussion:{MAKE_DISCUSSION_TAG:"Create Discussion",ADD_DISCUSSION_MEMBER_TAG:"Add Member",SEARCH_HINT_TAG:"Search contacts by keywords",OK:"OK",ADD_DG_TITLE:"Please fill in the discussion group's name"},addFriends:{ADD_NEW_FRIENDS:"Add Friends",SEARCH_HINT_TAG:"Search friends by keywords"},service:{SERVICE_TAG:"Services",SEARCH_HINT_TAG:"Search"},followService:{FOLLOW_SERVICE_TAG:"Subscribe services",SEARCH_HINT_TAG:"Search"},detailInfo:{DETAIL_INFO_TAG:"Details",FULLNAME_TAG:"Display Name",LOGIN_NAME_TAG:"Login Name",PROFILE_PHOTO_TAG:"Profile Photo",TYPE_TAG:"Type: ",MAIL_TAG:"Email",IDENTITY_TAG:"Identity",BELONG_TO_ORG_TAG:"Superordinate Organizations",MESSAGE_HISTORY_TAG:"Message History",CHAT_WITH_USER_TAG:"Chat",DELETE_USER_TAG:"Remove Contact",INVITE_USER_AS_CONTACT_TAG:"Invite as Contact",USER_EMAIL:"Email",USER_IDENTITY:"Identity",USER_EDUCATION:"Education",USER_CALENDAR:"School Calendar",USER_DEPARTMENT:"Department",USER_MAJOR:"Major",USER_CLASS:"Class",INVITE_CONTACT:"I want to invite you to be my contact."},orgInfo:{DETAIL_INFO_TAG:"Details",DESCRIPTION_TAG:"Descriptions",PROFILE_PHOTO_TAG:"Profile Photo",FULLNAME_TAG:"Group Name",TYPE_TAG:"Type: ",SUB_ORG_TAG:"Subordinate Organization",MAKE_DISCUSSION_TAG:"Make Discussion",ORG_MEMBERS_TAG:"Organization Members",REQUEST_JOIN_OG:"Join",REQUEST_JOIN_OG_COMPLETED:"Send join request successful",REQUEST_JOIN_OG_FAILED:"Send join request failed"},discussionInfo:{DESC:"Descriptions",TYPE:"Type: ",MESSAGE_HISTORY:"Message History",QUIT_DISCUSSION:"Quit",DELETE_DISCUSSION:"Delete",PERSION:"people",DG_FULLNAME:"Dicussion Name",DG_PROFILE_PHOTO:"Profile Photo"},serviceInfo:{DESC:"Descriptions",TYPE:"Type: ",FULLNAME:"Service Name",PROFILE_PHOTO:"Profile Photo",MESSAGE_HISTORY:"Message History",UNFOLLOW:"UnSubscribe",FOLLOW:"Subscribe"},leftPanel:{MESSAGE_TAG:"Messages",CONTACTS_TAG:"Contacts",SETTINGS_TAG:"Settings"},messageThread:{PULL_TO_LOAD_MORE:"Load More",LOGIN_PASSWORD_TAG:"Password",OK_TAG:"OK",CANCEL_TAG:"Cancel",CHOOSE_CONTACTS_TAG:"Choose Contacts",SEARCH_CONTACTS_TAG:"Search contacts by keywords",SEND:"Send",SEND_TIP:"Press Ctrl+Enter to start a new line",TEXTAREA_TIP:"Write something...",ASSIGN:"Assign",TYPE:"Type",SERVICE_USER:"Service User",PORTAL_USER:"Portal User",TOGGLE_FONT_SIZE:"Toggle font size: "},lockPopover:{COPY_TAG:"Copy",ENCRYPTOIN_TAG:"Encryption",DECRYPTION_TAG:"Decryption",DELETE_TAG:"Delete"},myContacts:{SEARCH_HINT_TAG:"Search"},messageHistory:{PULL_TO_LOAD_MORE:"Load More"},slackIntegrate:{TITLE:"Slack",SEND_TAG:"Send"},evernoteIntegrate:{BOOK_TITLE:"Evernote Book",NOTE_TITLE:"Evernote Note",SEND_TAG:"Send",DOWNLOAD_FAILED:"Download Failed"},gpsLocation:{LOCATION_TITLE:"Location",SEND:"Send",POS_SERVICE_NOT_OPEN:"Position service did not open.",DETAIL:"Detail Information",SOLUTION_TO_NOT_OPEN_POS_SERVICE:"You can try the following method to enable location services: ",SOLUTION_ON_DEVICE:"In the equipment",SOLUTION_SETTING:"Settings",SOLUTION_PRIVACY:"Privacy",SOLUTION_LOCATING_SERVICE:"Locating service",SOLUTION_ENABLE:"enable locating service, add allows in the following application list",SOLUTION_USE:"to use locating service."},forgetPassword:{REGISTER_EMAIL:"Registered email address",RESET_PASSWORD:"Reset password"},chatModal:{CHOOSE:"Select",CANCEL:"Cancel"},LOCAL:{SAVE_TO_PHONE:"Save to the phone",SAVE:"Save",CHECK_UPDATE:"Updated to",IS_UPDATED:"It's been the latest version",GET_VERSION_FAIL:"Could not get the latest version",PROMPT_LEAVE:"Are you sure you want to leave?"},COMMON:{ERR_TITLE:"Error",INFO_TITLE:"Prompt",SET_SUCCESS:"Setting successfully",SET_FAILURE:"Setting failed"},changeiconctrl:{SMALL_ICON:"The picture size should not be less than 160 * 160 pixels!"},changefullnamectrl:{FULLNAME_EMPTY:"The name can't be empty",FULLNAME_TOO_LARGE:"No more than 32 characters"},changepwdctrl:{PROMPT_EMPTY:"Both the original password and new password can not be empty",PROMPT_PWD_ERROR:"Incorrect original password",PROMPT_VERIFY_ERROR:"The second input password is different from the first one.",PROMPT_SAME_ERROR:"The new password can't be the same as the original password.",PROMPT_LENGTH:"No more than 16 characters"},conversationsctrl:{NO_MESSAGE:"There is no messages, slide to the right to view the main menu."},GLOBAL:{ERR_TOKEN:"Can't get access token",ERR_NET:"Can't connect to server",ERR_LOGIN:"Can't login",ERR_USERPASS:"Username or password incorrect",ERR_IOSTOKEN:"Failed to get message push identity.",ERR_NO_SERVER:"No server is selected !",ERR_NO_PASSWORD_EMAIL:"No password and email",ERR_NO_ENOUGH_INFO:"Miss parameter to action.",NOTIFICATION_CHANGE_SUCCESS:"Notification changed successfully",NOTIFICATION_CHANGE_FAIL:"Fail to change Notification",NOTIFICATION_TYPE:"Notification Type",ONLINE:"OnLine",OFFLINE:"Offline",NO_AVAILABLE_CONTACT:"No available contacts",NO_AVAILABLE_GROUP:"No available groups",NO_AVAILABLE_SERVANT:"No available service users for this group",CANT_GET_MORE_HISTORY_MESSAGES:"Can't get more history messages",CANT_GET_MORE_CONVERSATIONS:"Can't get more conversations",CANT_REFRESH_CONVERSATIONS:"Can't refresh conversations",TITLE_FILE:"File Message",TITLE_AUDIO:"Audio Message",TITLE_TEXT:"Text Message",TITLE_TXT:"Text Message",TITLE_IMAGE:"Image Message",TITLE_SINGLE_CARD:"Card Message",TITLE_MULTIPLE_CARD:"Card Message",TITLE_GPS_LOCATION:"Location Message",TITLE_ACCEPT_CONTACT:"Accepted Invite Message",TITLE_DG_INVITED:"Joined Discussion Group Message",TITLE_DESKTOP:"Receive new message",TITLE_REQUEST_JOIN_OG:"Request Message",TITLE_APPROVE_JOIN_OG:"Approve Message",TITLE_LOGOUT:"Logout Message",TITLE_UNKNOWN:"Unknown Message",CANT_OPEN_FILE:"Can't open this file",SHOW_BADGE:"Show Badge",SHOW_BADGE_NOTE:"When message arrives, show unread count in App icon",MUTE_NOTIFICATION:"Mute Notification",MUTE_NOTIFICATION_NOTE:"No notification when message arrives",SILENCE_NOTIFICATION:"Silence Notification",SILENCE_NOTIFICATION_NOTE:"Only show text notification, no sound alert when new message arrives ",MUTE_OTHER_MOBILE_DEVICE:"Mute Notificaiton in Mobile",MUTE_OTHER_MOBILE_DEVICE_NOTE:"When login in both Web and mobile device, let mobile device not show notification",IS_DISTRIBUTOR_USER:"Set as Distributor",IS_DISTRIBUTOR_USER_NOTE:"A distributor can receive messages from any portal user and assign conversations to other service user",BODY_REQUEST_JOIN_OG:"request to join organization",BODY_APPROVE_JOIN_OG:"Approve to join organization",BODY_CHAT_MESSAGE_REQUEST_JOIN_OG:"I want to join organization: ",TIMESTAMP_LANGUAGE:"en",TIMESTAMP_FORMAT:"MM-DD HH:mm",MESSAGE_DG_INVITED:"I invite you joined the discussion",MESSAGE_ACCEPT_CONTACT:"I accepted your invitation, and we are friends now.",MESSAGE_INVITE_CONTACT:"I want to make friends with you.",MESSAGE_APPROVE_JOIN_OG:"I approved you to join organization:",ALERT_OK:"Ok",ALERT_CANCEL:"Cancel",CLOSE:"Close",SAVE:"Save",SAVE_PHOTO_SUCCESS:"Successfully save image to albumn",SAVE_PHOTO_FAILURE:"Fail to save image to albumn",DOWNLOAD_FAILURE:"Request to download fails",RECORD_CANCEL:"Slip on your fingers, cancel the send",RECORD_RELEASE:"Release your fingers, cancel the send",CANCEL_REC_TIP:"Slip on your fingers, cancel the send.",LOGIN_IN_ANOTHER_DEVICE:"Your account has logined in another device",FILE:"Files",PICTURE:"Pictures",CAMERA:"Camera",LOCATION:"Location",SLACK:"Slack",EVERNOTE:"Evernote",MESSAGE_CONTENT:"Message Content",ASSIGN_TO:"Conversation is assigned to: ",CANCEL:"Cancel",COPY:"Copy",FORWARD:"Forward",DELETE:"Delete",LOCK:"Lock",UNLOCK:"UnLock",RELOAD:"Reload",SEARCH:"Search",YESTERDAY:"Yesterday",UPDATE_TITLE:"A new version is avaliable!",UPDATE_CONTENT1:"Current version is ",UPDATE_CONTENT2:", do you want to upgrade to the latest version",UPDATE_CONTENT3:" ?",UPDATE_FAILED:"Update failed",UPDATE_SUCCESS:"Update successfully",NO_RECENT_MESSAGE:"No recent message",NO_MORE_HISTORY_MESSAGES:"No more history messages",CHECKING_FILE:"Checking file ...",UPLOADING_FILE:"Uploading file ...",SENDING:"Sending Message ...",CANCELED:"Canceled",TYPING:" is typing ",CONVERSATIONS:"Conversations",CONTACTS:" Contacts",NO_RESULTS:"No results",SELECT_APP:"Select a app",PRECEED:"Preceed",QUIT:"Quit",REMEMBER_MY_CHOICE:"Remember my choice",NO_CONVERSATION_SELECTED:"No conversation selected",NO_CONTACT_SELECTED:"No contact selected",NO_SETTING_SELECTED:"No setting item selected",NO_CONVERSATION:"No conversation",NO_CONTACT:"No contact",YOU_DONT_HAVE_ANY_APP:"You don't have any app",ON_BEFORE_UNLOAD_WARNING:"You will log out if window is closed.",NO_MATCH_RESULTS:"No match results",ADD_MEMBER:"Add Member",ADD_BY_CONTACT:"Add by Contact",ADD_BY_GROUP:"Add by Group",READY:"Ready",BUSY:"Busy",REST:"Rest",USER_STATUS_AFTER_LOGIN:"User status after login"}}},cn:{noapp:{LOGIN_TAG:"登录",USERNAME_TAG:"用户名",USEREMAIL_TAG:"邮箱",PASSWORD_TAG:"密码",LOGIN_CANCEL_TAG:"取消",serverList:{SERVER_LIST:"服务器列表"},addServer:{ADD_SERVER_TAG:"添加服务器",SERVER_NAME:"名称",SERVER_PROTOCOL:"协议",SERVER_HOST:"主机",SERVER_PORT:"端口",SERVER_NAME_NOTE:"任意名称",SERVER_PROTOCOL_NOTE:"http:// 或 https://",SERVER_HOST_NOTE:"192.168.0.1，ppmessage.cn",SERVER_PORT_NOTE:"80，8080",USE_HTTPS_PROTOCOL:"使用 https 协议",SET_DEFAULT_SERVER_TAG:"设为默认服务器"},loginWithUser:{LOGIN_TAG:"登录",LOGIN_PASSWORD_TAG:"密码",SWITCH_USER_TAG:"切换账号"},switchServer:{DELETE_SERVER_TAG:"删除"},register:{REGISTER:"注册",REGISTER_BY_MOBILE:"手机号码注册",INPUT_VERIFY_CODE:"手机验证码",INPUT_MOBILE:"手机号",INPUT_USER_EMAIL:"邮箱",INPUT_USER_NAME:"用户姓名",INPUT_USER_PWD:"密码",INPUT_USER_PWD_CONFIRM:"密码确认",BUTTON_GET_VERIFY_CODE:"获取手机验证码",ALERT_ILLEGAL_EMAIL:"邮箱格式错误",ALERT_ILLEGAL_CONFIRM_PWD:"密码不一致",ALERT_ILLEGAL_PASSWORD_LENGTH:"密码不能大于16个字符",ALERT_ILLEGAL_CONTAINS_SPACE:"密码不能包含空格",ALERT_ILLEGAL_VERIFY_CODE:"验证码错误",ALERT_ILLEGAL_PHONE_NUMBER:"手机格式不正确",ALERT_REGISTER_SUCCESSFUL:"注册成功",ALERT_REGISTER_FAILED:"注册失败",ALERT_REGISTER_FAILED_EMAIL_EXISTED:"注册失败：该邮箱已被注册过",ALERT_REGISTER_FAILED_MOBILE_EXISTED:"注册失败：该手机号已被注册过"}},app:{common:{SAVE_TAG:"保存",RESTORE_TAG:"撤销",CANCEL_TAG:"取消",OK_TAG:"确定",BACK_TAG:"返回"},settings:{SETTINGS_TAG:"设置",LOG_OUT_TAG:"退出登录",APPLICATION_TAG:"应用",profile_photo:{LOADING_TAG:"图片加载中...",PROFILE_PHOTO_TAG:"头像",TAKE_PHOTO_TAG:"拍照",CHOOSE_FROM_PHOTOS_TAG:"选择图片"},name:{NAME_TAG:"姓名",INPUT_NEW_NAME_TAG:"请输入新姓名"},signature:{SIGNATURE_TAG:"签名",WRITE_SOMETHING:"写点什么吧"},password:{PASSWORD_TAG:"密码",INPUT_ORIGIN_PASSWORD_TAG:"请输入原密码",INPUT_NEW_PASSWORD_TAG:"请输入新密码",INPUT_NEW_PASSWORD_AGAIN_TAG:"请再输入一次新密码"},push_noti:{PUSH_NOTIFICATION_TAG:"通知"},language:{LANGUAGE_TAG:"语言",CHINESE_TAG:"中文",ENGLISH_TAG:"English"},app:{APP_TAG:"应用"},about:{ABOUT_TAG:"关于",CANT_GET_NEWEST_VERSION_TAG:"无法获取版本信息",IS_NEWEST_VERSION_TAG:"已是最新版本",UPGRADE_TO_VERSION_TAG:"更新至版本 "},integrate:{INTEGRATE_TAG:"应用集成"}},messages:{MESSAGE_TAG:"消息",CONVERSATIONS_TAG:"对话",MARK_AS_READ_TAG:"已读",DELETE:"删除",ALL:"所有",UNASSIGNED:"未分配",MINE:"我的"},contact:{CONTACT_TAG:"通讯录",SERVICE_TAG:"服务",SEARCH_TAG:"搜索",ORGANIZATION_TAG:"组织",DISCUSSION_TAG:"群聊",NEW_FRIENDS_TAG:"新的朋友",SERVANT:"客服",CUSTOMER:"客户"},newFriends:{MESSAGE_TAG:"新的朋友",NO_NEW_INVITATIONS:"没有新的联系人邀请",RECEIVE_INVITE_TAG:"接受",ADDED_TAG:"已同意",DELETE_TAG:"删除",REQUEST_JOIN_OG:"我想要请求加入组织：",APPROVE_JOIN_OG_FAILED:"同意失败，请稍后重试"},organization:{ORGANIZATION_TAG:"组织",SEARCH_HINT_TAG:"搜索"},discussion:{DISCUSSION_TAG:"群聊",SEARCH_HINT_TAG:"搜索"},makeDiscussion:{MAKE_DISCUSSION_TAG:"添加群聊",ADD_DISCUSSION_MEMBER_TAG:"添加成员",SEARCH_HINT_TAG:"输入关键词搜索联系人",OK:"确定",ADD_DG_TITLE:"填写群聊名"},addFriends:{ADD_NEW_FRIENDS:"添加联系人",SEARCH_HINT_TAG:"输入关键词搜索联系人"},service:{SERVICE_TAG:"服务",SEARCH_HINT_TAG:"搜索"},followService:{FOLLOW_SERVICE_TAG:"添加服务",SEARCH_HINT_TAG:"搜索"},detailInfo:{DETAIL_INFO_TAG:"详细信息",FULLNAME_TAG:"名称",LOGIN_NAME_TAG:"登录名",PROFILE_PHOTO_TAG:"头像",TYPE_TAG:"类型: ",MAIL_TAG:"邮箱",IDENTITY_TAG:"身份",BELONG_TO_ORG_TAG:"所属组织",MESSAGE_HISTORY_TAG:"消息历史",CHAT_WITH_USER_TAG:"对话",DELETE_USER_TAG:"删除联系人",INVITE_USER_AS_CONTACT_TAG:"邀请为联系人",USER_EMAIL:"邮箱",USER_IDENTITY:"身份",USER_EDUCATION:"学历",USER_CALENDAR:"学年制",USER_DEPARTMENT:"院系",USER_MAJOR:"专业",USER_CLASS:"班级",INVITE_CONTACT:"我想要加你为好友."},orgInfo:{DETAIL_INFO_TAG:"详细信息",DESCRIPTION_TAG:"组织描述",PROFILE_PHOTO_TAG:"组织头像",FULLNAME_TAG:"组织名称",TYPE_TAG:"类型: ",SUB_ORG_TAG:"下级组织",MAKE_DISCUSSION_TAG:"建立群聊",ORG_MEMBERS_TAG:"组织成员",REQUEST_JOIN_OG:"请求加入组织",REQUEST_JOIN_OG_COMPLETED:"已发送请求加入组织消息",REQUEST_JOIN_OG_FAILED:"发送请求加入消息失败"},discussionInfo:{DESC:"描述",TYPE:"类型：",MESSAGE_HISTORY:"消息历史",QUIT_DISCUSSION:"退出该群",DELETE_DISCUSSION:"删除该群",PERSION:"人",DG_FULLNAME:"群聊名称",DG_PROFILE_PHOTO:"群聊头像"},serviceInfo:{DESC:"描述",TYPE:"类型: ",PROFILE_PHOTO:"服务头像",FULLNAME:"服务名称",MESSAGE_HISTORY:"消息历史",UNFOLLOW:"取消关注",FOLLOW:"关注"},leftPanel:{MESSAGE_TAG:"消息",CONTACTS_TAG:"通讯录",SETTINGS_TAG:"设置"},messageThread:{PULL_TO_LOAD_MORE:"更多",LOGIN_PASSWORD_TAG:"登录密码",OK_TAG:"确定",CANCEL_TAG:"取消",CHOOSE_CONTACTS_TAG:"选择联系人",SEARCH_CONTACTS_TAG:"根据关键词搜索联系人",SEND:"发送",SEND_TIP:"按Ctrl+Enter换行",TEXTAREA_TIP:"写点什么吧...",FILE:"文件",PICTURE:"图片",CAMERA:"拍照",LOCATION:"位置",SLACK:"Slack",EVERNOTE:"印象笔记",ASSIGN:"分配",TYPE:"类型",SERVICE_USER:"客服",PORTAL_USER:"客户",TOGGLE_FONT_SIZE:"改变字体大小: "},lockPopover:{COPY_TAG:"复制",ENCRYPTOIN_TAG:"加密",DECRYPTION_TAG:"解密",DELETE_TAG:"删除"},myContacts:{SEARCH_HINT_TAG:"搜索"},messageHistory:{PULL_TO_LOAD_MORE:"更多"},slackIntegrate:{TITLE:"Slack",SEND_TAG:"发送"},evernoteIntegrate:{BOOK_TITLE:"Evernote 笔记本",NOTE_TITLE:"Evernote 笔记",SEND_TAG:"发送",DOWNLOAD_FAILED:"下载失败"},gpsLocation:{LOCATION_TITLE:"位置",SEND:"发送",POS_SERVICE_NOT_OPEN:"定位服务没有开启",DETAIL:"查看详情",SOLUTION_TO_NOT_OPEN_POS_SERVICE:"可以尝试以下方法启用位置服务：",SOLUTION_ON_DEVICE:"在设备的",SOLUTION_SETTING:"设置",SOLUTION_PRIVACY:"隐私",SOLUTION_LOCATING_SERVICE:"定位服务",SOLUTION_ENABLE:"中启用定位服务，并在下面的应用列表中允许",SOLUTION_USE:"使用定位服务。"},forgetPassword:{REGISTER_EMAIL:"注册邮箱地址",RESET_PASSWORD:"重置密码"},chatModal:{CHOOSE:"选择",CANCEL:"取消"},LOCAL:{SAVE_TO_PHONE:"保存到手机",SAVE:"保存",CHECK_UPDATE:"更新至",IS_UPDATED:"已是最新版本",GET_VERSION_FAIL:"无法获取最新版本",PROMPT_LEAVE:"确定离开？"},COMMON:{ERR_TITLE:"错误",INFO_TITLE:"提示",SET_SUCCESS:"设置成功",SET_FAILURE:"设置失败"},changeiconctrl:{SMALL_ICON:"图片大小不得小于160x160像素！"},changefullnamectrl:{FULLNAME_EMPTY:"名称不能为空",FULLNAME_TOO_LARGE:"名称最长不超过32个字符"},changepwdctrl:{PROMPT_EMPTY:"原密码和新密码都不能为空",PROMPT_PWD_ERROR:"原密码错误",PROMPT_VERIFY_ERROR:"两次输入的新密码不一致",PROMPT_SAME_ERROR:"新密码不能和原密码相同",PROMPT_LENGTH:"密码长度不能超过16"},conversationsctrl:{NO_MESSAGE:"暂无消息，向右滑动查看主菜单。"},GLOBAL:{ERR_TOKEN:"无法获取token",ERR_NET:"无法连接服务器",ERR_LOGIN:"无法登录",ERR_USERPASS:"用户名称密码不匹配",ERR_IOSTOKEN:"获取推送消息标识出错",ERR_NO_SERVER:"没有选中任何服务器",ERR_NO_PASSWORD_EMAIL:"没有填写邮箱或密码",ERR_NO_ENOUGH_INFO:"提供的参数不够",NOTIFICATION_CHANGE_SUCCESS:"成功变更推送方式",NOTIFICATION_CHANGE_FAIL:"变更推送方式失败",NOTIFICATION_TYPE:"推送方式",ONLINE:"在线",OFFLINE:"离线",NO_AVAILABLE_CONTACT:"没有可添加的联系人",NO_AVAILABLE_GROUP:"没有可用的组",NO_AVAILABLE_SERVANT:"该组没有可用的客服",CANT_GET_MORE_HISTORY_MESSAGES:"无法获取更多历史消息",CANT_GET_MORE_CONVERSATIONS:"无法获取更多对话",CANT_REFRESH_CONVERSATIONS:"无法刷新对话",TITLE_FILE:"文件消息",TITLE_AUDIO:"语音消息",TITLE_TEXT:"文本消息",TITLE_TXT:"文本消息",TITLE_IMAGE:"图片消息",TITLE_SINGLE_CARD:"图文消息",TITLE_MULTIPLE_CARD:"图文消息",TITLE_GPS_LOCATION:"位置消息",TITLE_ACCEPT_CONTACT:"接受邀请消息",TITLE_DG_INVITED:"加入群聊消息",TITLE_DESKTOP:"收到新消息",TITLE_REQUEST_JOIN_OG:"请求消息",TITLE_APPROVE_JOIN_OG:"同意消息",TITLE_LOGOUT:"退出登录消息",TITLE_UNKNOWN:"未知消息",CANT_OPEN_FILE:"不能打开此文件",SHOW_BADGE:"显示未读消息数",SHOW_BADGE_NOTE:"新消息到达时，在应用图标上显示未读消息数",MUTE_NOTIFICATION:"不显示通知",MUTE_NOTIFICATION_NOTE:"新消息到达时，不显示任何通知",SILENCE_NOTIFICATION:"仅显示文字通知",SILENCE_NOTIFICATION_NOTE:"新消息到达时，仅显示文字通知，没有声音提示",MUTE_OTHER_MOBILE_DEVICE:"移动设备不显示通知",MUTE_OTHER_MOBILE_DEVICE_NOTE:"网页和移动设备同时在线时，移动设备不显示消息通知",IS_DISTRIBUTOR_USER:"设为分发者",IS_DISTRIBUTOR_USER_NOTE:"作为分发者，你会收到任何用户发来的消息，并具有分配对话给其他客服的能力",BODY_REQUEST_JOIN_OG:"请求加入组织",BODY_APPROVE_JOIN_OG:"同意加入组织",BODY_CHAT_MESSAGE_REQUEST_JOIN_OG:"我想要请求加入组织：",TIMESTAMP_LANGUAGE:"zh-cn",TIMESTAMP_FORMAT:"MM月DD日 HH:mm",MESSAGE_DG_INVITED:"我邀请你加入了群聊",MESSAGE_ACCEPT_CONTACT:"我接受了你的邀请，现在我们是好友了",MESSAGE_INVITE_CONTACT:"我想要加你为好友.",MESSAGE_APPROVE_JOIN_OG:"我已同意你加入组织：",ALERT_OK:"确定",ALERT_CANCEL:"取消",CLOSE:"关闭",SAVE:"保存",SAVE_PHOTO_SUCCESS:"图片已保存到相册",SAVE_PHOTO_FAILURE:"图片保存失败",DOWNLOAD_FAILURE:"下载失败",RECORD_CANCEL:"手指上滑，取消发送",RECORD_RELEASE:"松开手指，取消发送",CANCEL_REC_TIP:"手指上滑，取消发送",LOGIN_IN_ANOTHER_DEVICE:"你的账户在其他设备上登录",FILE:"文件",PICTURE:"图片",CAMERA:"拍照",LOCATION:"位置",SLACK:"Slack",EVERNOTE:"印象笔记",MESSAGE_CONTENT:"消息内容",ASSIGN_TO:"对话分配给： ",CANCEL:"取消",COPY:"复制",FORWARD:"转发",DELETE:"删除",LOCK:"加锁",UNLOCK:"解锁",RELOAD:"重新加载",SEARCH:"搜索",YESTERDAY:"昨天",UPDATE_TITLE:"有新版本！",UPDATE_CONTENT1:"当前版本为",UPDATE_CONTENT2:", 是否升级到最新版本",UPDATE_CONTENT3:" ？",UPDATE_FAILED:"更新失败",UPDATE_SUCCESS:"更新成功",NO_RECENT_MESSAGE:"没有最近消息",NO_MORE_HISTORY_MESSAGES:"没有更多的历史消息",CHECKING_FILE:"检查文件 ...",UPLOADING_FILE:"上传文件 ...",SENDING:"发送消息 ...",CANCELED:"已取消",TYPING:"正在输入 ",CONVERSATIONS:"对话",CONTACTS:" 联系人",SELECT_APP:"选择应用",PRECEED:"继续",QUIT:"退出",REMEMBER_MY_CHOICE:"记住我的选择",NO_CONVERSATION_SELECTED:"未选中任何对话",NO_CONTACT_SELECTED:"未选中任何联系人",NO_SETTING_SELECTED:"未选中任何设置项",NO_CONVERSATION:"没有对话",NO_CONTACT:"没有联系人",NO_RESULTS:"没有结果",YOU_DONT_HAVE_ANY_APP:"你没有任何应用",ON_BEFORE_UNLOAD_WARNING:"关闭窗口会导致退出登录",NO_MATCH_RESULTS:"没有符合的结果",ADD_MEMBER:"添加成员",ADD_BY_CONTACT:"按联系人添加",ADD_BY_GROUP:"按组添加",READY:"空闲",BUSY:"忙碌",REST:"休息",USER_STATUS_AFTER_LOGIN:"登录后用户状态"}}}}),angular.element(document).ready(function(){function e(){try{angular.bootstrap(document,["ppmessage"],{strictDi:!0})}catch(e){console.error(e)}}window.cordova?document.addEventListener("deviceready",e,!1):e()}),ppmessageModule.factory("yvConstants",[function(){return{DEV_MODE:!0,UPDATE_YVOBJECT_INTERVAL:86400,MESSAGE_MAX_TEXT_LEN:128,PCSOCKET_PORT:8931,PCAPP_PORT:8927,DOWNLOAD_PORT:8924,UPLOAD_PORT:8928,API_PORT:8922,ADMINWEB_PORT:8920,PORTAL_PORT:8080,OAUTH_PORT:8930,ONLINE_STATUS:{ONLINE:"ONLINE",OFFLINE:"OFFLINE",UNCHANGED:"UNCHANGED"},USER_STATUS:{READY:"READY",REST:"REST",BUSY:"BUSY",NULL:"NULL"},ADDING_TYPE:{FILE:"FILE",PICTURE:"PICTURE",CAMERA:"CAMERA",LOCATION:"LOCATION",SLACK:"SLACK",EVERNOTE:"EVERNOTE"},PC_SOCKET_STATUS:{NULL:"NULL",CONNECTING:"CONNECTING",CONNECTED:"CONNECTED",KICKED:"KICKED"},DIS_ERR:{NOERR:0,FORMAT:1,AUTH:2,QUIT:3},CHAT_STATUS:{NULL:"NULL",ADDING:"ADDING",TEXTING:"TEXTING",CAPTURING:"CAPTURING",CAPTURED:"CAPTURED",RECORDING:"RECORDING",RECORDING_PRE:"RECORDING_PRE",RECORDING_CANCEL:"RECORDING_CANCEL"},THUMBNAIL:{WIDTH:120,HEIGHT:160},AVATAR:{WIDTH:140,HEIGHT:140},API_ERR:{NO_ERR:0,NO_JSON:1,NO_UUID:2,NO_ACCESS_TOKEN:3,WRONG_ACCESS_TOKEN:4,NO_VALID:5,
NO_PARA:6,NO_USER:7,NO_DEVICE:8,NO_ENT:9,MIS_ERR:10,NO_TASK:11,NO_PUSH:12,NO_APP:13,NO_FILE:14,NO_MATERIAL:15,MESSAGE:16,SYS_ERR:17,NO_OBJECT:18,ERR_SIG:19,NO_PERM:20,EX_USER:22,ERROR_VERIFY_CODE:24},MESSAGE_TYPE:{NOTI:"NOTI",SYS:"SYS"},MESSAGE_SUBTYPE:{AUDIO:"AUDIO",VIDEO:"VIDEO",DOCUMENT:"DOCUMENT",FILE:"FILE",TEXT:"TEXT",IMAGE:"IMAGE",SINGLE_CARD:"SINGLE_CARD",MULTIPLE_CARD:"MULTIPLE_CARD",TXT:"TXT",MENU:"MENU",EVENT:"EVENT",GPS_LOCATION:"GPS_LOCATION",INVITE_CONTACT:"INVITE_CONTACT",ACCEPT_CONTACT:"ACCEPT_CONTACT",REMOVE_CONTACT:"REMOVE_CONTACT",DG_INVITED:"DG_INVITED",DG_REMOVED:"DG_REMOVED",REQUEST_JOIN_OG:"REQUEST_JOIN_OG",APPROVE_JOIN_OG:"APPROVE_JOIN_OG",LOGOUT:"LOGOUT"},YVOBJECT:{DEVICE_USER:"DU",ORG_GROUP:"OG",APP_GROUP:"AG",DIS_GROUP:"DG",ADMIN_USER:"AU",CONVERSATION:"CV"},PLAY_STATUS:{PLAY_NULL:"PLAY_NULL",PLAY_PLAYING:"PLAY_PLAYING"},SEND_STATUS:{SEND_PENDING:"SEND_PENDING",SEND_CHECKING:"SEND_CHECKING",SEND_UPLOADING:"SEND_UPLOADING",SEND_SENDING:"SEND_SENDING",SEND_CANCELED:"SEND_CANCELED",SEND_SUCCESS:"SEND_SUCCESS",SEND_ERROR:"SEND_ERROR"},RECV_STATUS:{RECV_PLAY:"RECV_PLAY",RECV_OPEN:"RECV_OPEN",RECV_NEW:"RECV_NEW",RECV_UNACK:"RECV_UNACK"},MESSAGE_DIR:{DIR_IN:"DIR_IN",DIR_OUT:"DIR_OUT"},INVITE_STATUS:{INVITE_PENDING:"INVITE_PENDING",INVITE_READ:"INVITE_READ",INVITE_ACCEPTED:"INVITE_ACCEPTED"},MENU_TYPE:{FUNC:"FUNC",WEB:"WEB",MSG:"MSG"},APP_MENU_ARRAY:["messages","contacts","settings"],CONVERSATION_TYPE:{S2S:"S2S",S2P:"S2P",P2S:"P2S"},DEFAULT_BUNDLE_NAME:"PPMessage",OS:{MAC:"MAC",WIN32:"WIN32",WIN64:"WIN64",LINUX:"LINUX",DARWIN:"DARWIN"},PLATFORM:{IOS:"IOS",WIP:"WIP",ANDROID:"AND",IOS_BROWSER:"IOB",WIP_BROWSER:"WPB",ANDROID_BROWSER:"ANB",MAC:"MAC",LINUX:"LIN",WIN:"WIN",WIN32:"W32",WIN64:"W64",MAC_BROWSER:"MAB",LINUX_BROWSER:"LIB",WIN_BROWSER:"WIB"},NOTIFICATION_TYPE:{GCM:"GCM",MQTT:"MQTT"}}}]),$yvUtilService.$inject=["$base64"],ppmessageModule.factory("yvUtil",$yvUtilService),ppmessageModule.factory("yvLog",[function(){function e(e,t){t=["%c%s",e].concat(t),console.log.apply(console,t)}var t={},n=["log","warn","error","green","yellow","red"];return ppmessage.developer_mode?t={log:function(){var e=Array.prototype.slice.call(arguments);console.log.apply(console,e)},warn:function(){var e=Array.prototype.slice.call(arguments);console.warn.apply(console,e)},error:function(){var e=Array.prototype.slice.call(arguments);console.error.apply(console,e)},green:function(){var t=Array.prototype.slice.call(arguments);e("color: green",t)},yellow:function(){var t=Array.prototype.slice.call(arguments);e("background-color: yellow",t)},red:function(){var t=Array.prototype.slice.call(arguments);e("color: red",t)}}:angular.forEach(n,function(e){t[e]=angular.noop}),t}]),ppmessageModule.factory("yvSSL",["yvConstants",function(e){return{ws_protocol:function(e){var t="ws://";return"https:"==location.protocol&&(t="wss://"),t}}}]),ppmessageModule.factory("yvFile",["yvLog","yvSys",function(e,t){function n(t){var n=window.FileError,o="";switch(t.code){case n.QUOTA_EXCEEDED_ERR:o="QUOTA_EXCEEDED_ERR";break;case n.NOT_FOUND_ERR:o="NOT_FOUND_ERR";break;case n.SECURITY_ERR:o="SECURITY_ERR";break;case n.INVALID_MODIFICATION_ERR:o="INVALID_MODIFICATION_ERR";break;case n.INVALID_STATE_ERR:o="INVALID_STATE_ERR";break;default:o="Unknown Error"}e.error(o)}function o(){return t.get_uuid()}function i(e,t,n){var o=_.toURL()+e;window.resolveLocalFileSystemURL(o,function(e){t&&t(e)},function(e){n&&n(e)})}function r(t,n){i(t,function(o){o.remove(function(){n&&n(t)},function(){e.log("===========remove file error",t)})},function(){n&&n(t)})}function a(t,n,o){window.resolveLocalFileSystemURL(t,function(t){t.file(function(t){var i=new FileReader;i.onerror=function(t){e.log(t)},i.onprogress=function(t){e.log()},i.onabort=function(t){e.log(t)},i.onloadend=function(e){o(i.result)},1==n?i.readAsText(t):i.readAsDataURL(t)},function(e){o&&o("")})})}function s(e,t){var i=o();return _.getFile(i,{create:!0},function(t){e&&e(i,t)},function(e){t?t(e):n(e)}),i}function u(e,t,o){return _.getFile(e,{create:!0},function(e){t&&t(e)},function(e){n(e)}),e}function c(e,t,o,i){var r=e;return _.getFile(t,{create:!0},function(a){a.createWriter(function(n){o&&(r=Base64Binary.decodeArrayBuffer(e)),n.onwrite=function(e){i&&i(t)},n.write(r)},function(e){i&&i(null),n(e)})},function(e){i&&i(null),n(e)}),t}function l(e,t,n){var i=o();return c(e,i,t,n),i}var _=null;return{init:function(o){window.requestFileSystem(LocalFileSystem.PERSISTENT,16777216,function(i){t.in_ios_app()?(_=i.root,o&&o(),e.log("iOS root dir : ",_.toURL())):t.in_android_app()&&i.root.getDirectory("YvDoc",{create:!0},function(t){_=t,o&&o(),e.log("Android root dir: ",_.toURL())},n)},n)},copy_random:function(e,t,i){var r=o()+"."+t;return window.resolveLocalFileSystemURL(e,function(e){e.copyTo(_,r,function(e){i&&i(r,e)},n)},n),r},copy:function(e,t,o){window.resolveLocalFileSystemURL(e,function(e){e.copyTo(_,t,function(e){o&&o(e)},n)},n)},read_as_dataurl:function(e,t){return a(e,!1,t)},read_as_text:function(e,t){return a(e,!0,t)},create_random:function(e,t,n){return l(e,t,n)},create_random_nodata:function(e,t){return s(e,t)},create_nodata:function(e,t,n){return u(e,t,n)},create_data:function(e,t,n,o){return c(e,t,n,o)},get_root_dir:function(){return _?_.toURL():null},get_random_file_name:function(){return o()},has_file:function(e,t,n){return i(e,t,n)},remove_file:function(e,t){r(e,t)}}}]),ppmessageModule.factory("yvAlert",["$timeout","$ionicPopup","blockUI","yvConstants","yvSys","yvLocal",function(e,t,n,o,i,r){function a(n,o,i){var a=t.alert({title:n,template:"<p style='font-family: Helvetica; text-align: center;'>"+o+"</p>",okText:r.translate("app.GLOBAL.ALERT_OK")});a.then(function(e){e&&i&&i()}),e(function(){a.close()},1e3)}function s(e,n,o,i){var a=t.confirm({title:e,template:"<p style='font-family: Helvetica;'>"+n+"</p>",cancelText:r.translate("app.GLOBAL.ALERT_CANCEL"),okText:r.translate("app.GLOBAL.ALERT_OK")});a.then(function(e){e&&o?o():i&&i()})}function u(e,n,o){var i=t.prompt({title:e,inputPlaceholder:n,cancelText:r.translate("app.GLOBAL.ALERT_CANCEL"),okText:r.translate("app.GLOBAL.ALERT_OK")});i.then(function(e){return void 0===e?void console.log("canceld."):void(o&&o(e))})}function c(e,n,o,i,a){var s=t.show({title:e,template:"<input type='text' ng-model="+n+">",scope:o,buttons:[{text:r.translate("app.GLOBAL.ALERT_CANCEL"),onTap:function(e){return a&&a(e),"cancel"}},{text:r.translate("app.GLOBAL.ALERT_OK"),type:"button-positive",onTap:function(e){return i&&i(e),"ok"}}]});s.then(function(e){console.log("tapped",e)})}function l(e){window.plugins.toast.showShortCenter(e)}function _(){var t=r.translate("app.COMMON.SET_SUCCESS");i.in_mobile_app()?l(t):(n.start(),n.message(t),e(function(){n.stop()},1e3))}function d(){var t=r.translate("app.COMMON.SET_FAILURE");i.in_mobile_app()?l(t):(n.start(),n.message(t),e(function(){n.stop()},1e3))}function p(t,o){o||(t=r.translate(t)),i.in_mobile_app()?l(t):(n.start(),n.message(t),e(function(){n.stop()},1e3))}return{alert:function(e,t,n){a(e,t,n)},confirm:function(e,t,n,o){s(e,t,n,o)},prompt:function(e,t,n){u(e,t,n)},show:function(e,t,n,o,i){c(e,t,n,o,i)},toast:function(e){l(e)},success:function(){_()},fail:function(){d()},tip:function(e,t){p(e,t)}}}]),ppmessageModule.factory("yvAPI",["$rootScope","$timeout","$http","yvLog","yvSys","yvUser","yvFile","yvConstants",function(e,t,n,o,i,r,a,s){function u(i,a,u,c,l,_){function d(n,r,u,l){var d=n.error_code;if(o.log("POST SUCCESS URL: %s, DATA: %o, RESPONSE: %o.",i,a,n),0===d)return void(c&&c(n));if(_&&_(n,r,u,l),d===s.API_ERR.NO_ACCESS_TOKEN||d===s.API_ERR.WRONG_ACCESS_TOKEN){if(-1!==i.indexOf("LOGOUT"))return;t(function(){e.$broadcast("event:logout")})}}function p(e,t,n,r){o.error("POST ERROR url: %s, data: %o, response:%o.",i,a,e),l&&l(e,t,n,r)}var f=r.get("uuid"),E=r.get("app").uuid,m=r.get("device_uuid"),v=T.api_url+i,g=a||{},S={};g.app_uuid=E,g.user_uuid=f,g.device_uuid=m,S.url=v,S.method="POST",S.data=g,S.headers={"Content-Type":"application/json",Authorization:"OAuth "+r.get("access_token")},angular.forEach(u,function(e,t){S[t]=e}),o.log("API POST url: %s, data: %o.",S.url,S.data);try{return n(S).success(function(e,t,n,o){d(e,t,n,o)}).error(function(e,t,n,o){p(e,t,n,o)})}catch(A){o.error(A)}}function c(e,t,i,a){function s(e,n,i,s){return o.log("_api_token SUCCESS response: %o",e),0!=e.error_code?(o.error("_api_token: %o",e),void(a&&a())):(r.set("access_token",e.access_token),void(t&&t(e)))}function u(e,t,n,r){o.error("_api_token ERROR response:%o.",e),i&&i(e,t,n,r)}var c=T.auth_url+"/token",l="grant_type=password&user_email="+e.user_email+"&user_password="+e.user_password+"&client_id="+window.ppmessage.api_key,_={};_.url=c,_.method="POST",_.data=l,_.headers={"Content-Type":"application/x-www-form-urlencoded"},o.log("AUTH POST url: %s, data: %o.",_.url,_.data);try{return n(_).success(function(e,t,n,o){s(e,t,n,o)}).error(function(e,t,n,o){u(e,t,n,o)})}catch(d){o.error(d)}}function l(e,t,n,i){var r="/PPKEFU_LOGIN",a={timeout:g},s={token:e.device_token,osmodel:e.device_model,terminal:e.device_uuid,ostype:e.device_platform,osversion:e.device_version,device_fullname:e.device_fullname,ios_app_development:e.ios_app_development};return e.user_email?(s.user_email=e.user_email,s.user_password=e.user_password,s.user_status=e.user_status,u(r,s,a,t,n,i)):(o.error("yvAPI._api_login: neither user_email or user_uuid is valid, will return"),void(n&&n()))}function _(e,t,n,o){var r="/SET_DEVICE_INFO",a=i.get_device_info(),s={fullname:i.get_terminal_fullname(),osversion:a.version,ostype:a.platform,iosmodel:a.model};i.in_ios_app()&&(s.iostoken=e),u(r,s,null,t,n,o)}function d(e){var t=e.split("/"),n=t.length;return n?t[n-1]:null}function p(e,t,n,s,u){var c=encodeURI(e),l=new FileTransfer,_=new FileUploadOptions;0!==t.indexOf("file://")&&0!==t.indexOf("cdvfile://")&&(t=a.get_root_dir()+t),_.fileKey="file",_.mimeType=n,_.fileName=d(t),_.params={user_uuid:r.get("uuid")},i.in_android_app()&&"https://"==T.protocol&&(_.chunkedMode=!1),u&&(l.onprogress=u),l.upload(t,c,function(e){o.log("FileTransfer ok: %o",e),s&&s(e.response)},function(e){o.error("FileTransfer _err: %o.",e),s&&s(null)},_,!0)}function f(e,n,r,s){n=encodeURI(n),a.has_file(n,function(e){r&&r(e),o.log("no need to download this file",e.name)},function(){var u=new FileTransfer,c=encodeURI(e),l=a.get_root_dir()+n;i.in_android_app()&&"https://"==T.protocol&&(c=c.replace("http://ppmessage.com:80","https://ppmessage.com"),c=c.replace("http://ppmessage.cn:80","https://ppmessage.cn")),u.download(c,l,function(e){o.log("download file successfully",e.name),t(function(){r&&r(e)})},function(e){s&&s(e)},!0,null)})}function E(){var e={"X-Device-UUID":r.get("device_uuid"),"X-User-UUID":r.get("uuid"),"X-Session-UUID":r.get("session_uuid")};return e}function m(e,t){var o=T.pcapp_url+"/material/"+e+"?file_name="+t,i=E(),r={method:"GET",url:o,headers:i};return n(r)}function v(e){var t=e+".txt";return m(e,t)}var g=15e4,T={id:-1,name:"",host:"",protocol:"",api_url:"",auth_url:"",pcapp_url:"",upload_url:""};return{set_server:function(e){if(!e||-1===e.id)return void(T={id:-1});var t=e.protocol+e.host;e.port&&(t=t+":"+e.port),T.id=e.id,T.name=e.name,T.host=e.host,T.port=e.port,T.protocol=e.protocol,T.api_url=t+"/api",T.auth_url=t+"/ppauth",T.pcapp_url=t+"/ppkefu",T.upload_url=t+"/upload"},get_server:function(){return T},token:function(e,t,n,o){c(e,t,n,o)},login:function(e,t,n,o){l(e,t,n,o)},logout:function(e,t,n){var o="/PPKEFU_LOGOUT";return u(o,null,null,e,t,n)},get_yvobject:function(e,t,n,o,i,r){var a="/GET_YVOBJECT_DETAIL",s={uuid:e,type:t,timestamp:n};u(a,s,null,o,i,r)},get_user_info:function(e,t,n,o){var i="/PP_GET_USER_INFO",r={user_uuid:e};u(i,r,null,t,n,o)},update_device:function(e,t,n,o){_(e,t,n,o)},update_device_info:function(e,t,n,o){var i="/SET_DEVICE_INFO";u(i,e,null,t,n,o)},send_message:function(e,t,n,o){var i="/PP_SEND_MESSAGE";u(i,e,null,t,n,o)},forward_message:function(e,t,n,o){var i="/FORWARD_MESSAGE";u(i,e,null,t,n,o)},ack_message:function(e,t,n,o){var i="/ACK_MESSAGE";u(i,e,null,t,n,o)},update_user:function(e,t,n,o){var i="/PP_UPDATE_USER";e.user_uuid||(e.user_uuid=r.get("uuid")),u(i,e,null,t,n,o)},get_unacked_messages:function(e,t,n){var o="/GET_UNACKED_MESSAGES";_data={from_uuid:r.get("uuid"),device_uuid:r.get("device_uuid")},u(o,_data,null,e,t,n)},get_unacked_message:function(e,t,n,o){var i="/GET_UNACKED_MESSAGE",r={uuid:e};u(i,r,null,t,n,o)},get_latest_app:function(e,t,n){var o="/GET_LATEST_APP";u(o,null,null,e,t,n)},update_gpslocation:function(e,t,n,o,i){var r="/UPDATE_GPS_LOCATION",a={latitude:e,longitude:t};u(r,a,null,n,o,i)},get_history_message:function(e,t,n,o){var i="/PP_GET_HISTORY_MESSAGE";u(i,e,null,t,n,o)},get_page_history_message:function(e,t,n,o){var i="/PP_PAGE_HISTORY_MESSAGE";u(i,e,null,t,n,o)},get_app_version:function(e,t,n,o){var i="/GET_APP_VERSION";u(i,e,null,t,n,o)},get_single_card:function(e,t,n,o){var i="/GET_SINGLE_CARD";u(i,{uuid:e},null,t,n,o)},get_multiple_card:function(e,t,n,o){var i="/GET_MULTIPLE_CARD";u(i,{uuid:e},null,t,n,o)},download_txt:function(e){return v(e)},download_html:function(e,t){return m(e,t)},download_file:function(e,t,n,o){var i=null,r=null;e.startsWith("http")?(i=e,r=t||hex_sha1(e)):(i=T.pcapp_url+"/download/"+e,r=t||e),f(i,r,n,o)},upload_file:function(e,t,n,o){var i=T.upload_url;return p(i,e,t,n,o)},is_file_existed:function(e,t,n,o){var i="/FILE_IS_EXISTED";u(i,{digest:e},null,t,n,o)},get_icon_url:function(e){var t=T.pcapp_url+"/icon/"+e;return t},get_image_url:function(e,t){var n=T.pcapp_url+"/material/"+e+"?file_name="+e+"."+t;return n},get_audio_url:function(e,t){var n=T.pcapp_url+"/material/"+e+"?file_name="+e+"."+t;return n},get_card_url:function(e){var t=T.pcapp_url+"/material/"+e+"?file_name="+e+".html";return t},download_card_content:function(e){var t=this.get_card_url(e),o=E(),i={method:"GET",url:t,headers:o};return n(i)},get_amap_url:function(e){var t="http://restapi.amap.com/v3/staticmap?scale=2&location="+e.lng+","+e.lat+"&zoom="+e.zoom+"&size=150*110&markers=large,,A:"+e.lng+","+e.lat+"&key=ee95e52bf08006f63fd29bcfbcf21df0";return t},download_web_material:function(e,t){var n=T.pcapp_url+"/material/"+e+"?file_name="+t;i.click_download(n,t)},get_service_user_list:function(e,t,n){var o="/PP_GET_APP_SERVICE_USER_LIST";return u(o,null,null,e,t,n)},get_service_user_conversation_list:function(e,t,n){var o="/PP_GET_USER_CONVERSATION_LIST",i={user_uuid:r.get("uuid"),app_uuid:r.get("app").uuid};return u(o,i,null,e,t,n)},create_conversation:function(e,t,n,o){var i="/PP_CREATE_CONVERSATION";return e.user_uuid=r.get("uuid"),u(i,e,null,t,n,o)},close_conversation:function(e,t,n,o){var i="/PP_CLOSE_CONVERSATION",a={user_uuid:r.get("uuid"),conversation_uuid:e};return u(i,a,null,t,n,o)},get_conversation:function(e,t,n,o){var i="/PP_GET_CONVERSATION_INFO",a={app_uuid:r.get("app").uuid,conversation_uuid:e,user_uuid:r.get("uuid")};return u(i,a,null,t,n,o)},assign_conversation:function(e,t,n,o,i){var r="/PP_UPDATE_CONVERSATION",a={conversation_uuid:e,assigned_uuid:t};return u(r,a,null,n,o,i)},update_conversation_member:function(e,t,n,o){var i="/PP_UPDATE_CONVERSATION_MEMBER";return u(i,e,null,t,n,o)},get_app_org_group_list:function(e,t,n,o){var i="/PP_GET_APP_ORG_GROUP_LIST",r=e?{app_uuid:e}:{};return u(i,r,null,t,n,o)},get_conversation_user_list:function(e,t,n,o){var i="/PP_GET_CONVERSATION_USER_LIST",r={conversation_uuid:e};return u(i,r,null,t,n,o)},get_selected_group_user:function(e,t,n,o){var i="/PP_SELECT_USERS_BY_GROUP_ALGORITHM";return u(i,e,null,t,n,o)},get_conversation_page:function(e,t,n,o){var i="/PP_PAGE_USER_CONVERSATION";return e.user_uuid=r.get("uuid"),u(i,e,null,t,n,o)},test_api:function(e,t,n){var o="/PP_GET_USER_INFO",i={user_uuid:r.get("uuid")},a={timeout:1e4};u(o,i,a,e,t,n)},validate_online_device:function(e,t,n){var o="/PP_VALIDATE_ONLINE_DEVICE",i={};u(o,i,null,e,t,n)},set_user_status:function(e,t,n,o){var i="/PPKEFU_SET_SERVICE_USER_STATUS",r={user_status:e};u(i,r,null,t,n,o)}}}]),ppmessageModule.factory("yvType",["yvConstants",function(e){function t(e){return e.subtype?e.subtype:e.ms?e.ms:null}return{is_logout:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.LOGOUT},is_document:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.DOCUMENT},is_file:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.DOCUMENT?!0:o===e.MESSAGE_SUBTYPE.FILE},is_video:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.VIDEO},is_single_card:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.SINGLE_CARD},is_multiple_card:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.MULTIPLE_CARD},is_text:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.TEXT},is_txt:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.TXT},is_image:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.IMAGE},is_gps_location:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.GPS_LOCATION},is_audio:function(n){var o=t(n);return o===e.MESSAGE_SUBTYPE.AUDIO},is_left:function(t){return t.direction===e.MESSAGE_DIR.DIR_IN},is_right:function(t){return t.direction===e.MESSAGE_DIR.DIR_OUT},is_left_audio:function(e){return!(!this.is_left(e)||!this.is_audio(e))},is_right_audio:function(e){return!(!this.is_right(e)||!this.is_audio(e))}}}]),ppmessageModule.factory("yvDB",["$rootScope","$timeout","yvAPI","yvSys","yvNav","yvUser","yvConstants",function(e,t,n,o,i,r,a){"use strict";function s(e){return o.in_mobile_app()?window.sqlitePlugin.openDatabase({name:e,location:0}):window.openDatabase(e,"1.0",e,12582912)}function u(){var t=s("yvdb");t.transaction(function(e){var t="UPDATE yvdb_login_users SET is_online = 0, logout_time = ? WHERE id = ?",n=[Math.round(Date.now()/1e3),r.get("id")];e.executeSql(t,n,null,function(e,t){console.log(t)})}),e.$broadcast("event:reset-base"),i.exit_app(!0)}function c(e,t,n,o,i){function r(e,t){}function a(e,o){console.error(o),console.error("error SQL statement",t),console.error("error SQL value",n)}return e?(o=o||r,i=i||a,void e.transaction(function(e){e.executeSql(t,n,o,i)},function(e){console.error(e)})):void u()}function l(){try{re=s("yvdb")}catch(e){console.error("encount error when init yvdb",e)}return re}function _(e){ae.id=e.id,ae.name=e.name,ae.host=e.host,ae.port=e.port,ae.protocol=e.protocol,n.set_server(ae)}function d(e,t){function n(){t&&t(r.get())}b(e,function(){var t="SELECT * FROM userdb_objects WHERE uuid = ?";c(ie,t,[e],function(e,t){return 0===t.rows.length?n():(r.mset(t.rows.item(0)),void n())},function(e,t){n()})})}function p(e){var t="SELECT * FROM yvdb_servers WHERE is_selected = 1 LIMIT 1",n="SELECT * FROM yvdb_login_users WHERE server_id = ? ORDER BY login_time DESC LIMIT 1";c(re,t,[],function(t,o){if(0===o.rows.length)return void(e&&e(null));var i=o.rows.item(0);_(i),c(re,n,[i.id],function(t,n){if(0===n.rows.length)return void(e&&e(null));var o=n.rows.item(0);r.update_user_from_db(o),d(o.user_uuid,e)},function(t,n){e&&e(null)})})}function f(e){var t="CREATE TABLE IF NOT EXISTS yvdb_servers (id integer primary key, name text,  host text UNIQUE, port text, protocol text, is_selected integer)",n="SELECT * FROM yvdb_servers WHERE host=?",o="UPDATE yvdb_servers SET is_selected = 0",i="INSERT INTO yvdb_servers (name, host, port, protocol, is_selected) VALUES (?, ?, ?, ?, ?)",r=[ppmessage.server.name,ppmessage.server.host,ppmessage.server.port,ppmessage.server.protocol,1];c(re,t,[],null,null),c(re,n,[ppmessage.server.host],function(t,n){return 0===n.rows.length?void c(re,o,[],function(t,n){c(re,i,r,function(t,n){e&&e()},null)},null):void(e&&e())},null)}function E(){var e="CREATE TABLE IF NOT EXISTS yvdb_login_users (id integer primary key, server_id integer,  user_uuid text, device_uuid text, access_token text, app_uuid text, app_name text, app_key text,  app_secret text, show_badge integer, mute_notification integer, silence_notification integer,  is_distributor_user integer, android_notification_type text, login_time integer, logout_time integer, is_online integer)";c(re,e,[],null,null)}function m(e){var t="PRAGMA user_version",n="PRAGMA user_version = 1";return o.in_electron()?(f(e),void E()):void c(re,t,[],function(t,o){var i=o.rows.item(0).user_version;f(e),0===i?(console.log("NO DB -> create now."),E(),c(re,n,[],null,null)):1===i&&console.log("HAS DB and updated.")},null)}function v(e){l(),m(function(){p(e)})}function g(e,t,n){function o(e){r.set("id",e),n&&n()}var i="SELECT id FROM yvdb_login_users WHERE server_id = ? AND user_uuid = ?",a="INSERT INTO yvdb_login_users (server_id, user_uuid, device_uuid, access_token, app_uuid,  app_name, app_key, app_secret, show_badge, mute_notification, silence_notification, is_distributor_user,  android_notification_type, login_time, is_online) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",s="UPDATE yvdb_login_users SET device_uuid = ?, access_token = ?, app_uuid = ?, app_name = ?,  app_key = ?, app_secret = ?, show_badge = ?, mute_notification = ?, silence_notification = ?,  is_distributor_user = ?, login_time = ?, is_online = ? WHERE id = ?",u=Math.round(Date.now()/1e3),l=e.show_badge?1:0,_=e.mute_notification?1:0,d=e.silence_notification?1:0,p=e.is_distributor_user?1:0,f=r.get("android_notification_type"),E=[ae.id,e.uuid],m=[ae.id,e.uuid,e.device_uuid,e.access_token,t.uuid,t.app_name,t.app_key,t.app_secret,l,_,d,p,f,u,1];c(re,i,E,function(n,i){if(0===i.rows.length)return void c(re,a,m,function(e,t){o(t.insertId)},null);var r=i.rows.item(0).id,f=[e.device_uuid,e.access_token,t.uuid,t.app_name,t.app_key,t.app_secret,l,_,d,p,u,1,r];c(re,s,f,function(e,t){o(r)},null)},null)}function T(e){var t="UPDATE yvdb_login_users SET is_online = 0, logout_time = ? WHERE id = ?",n=[Math.round(Date.now()/1e3),r.get("id")];c(re,t,n,function(t,n){e&&e()},null)}function S(e,t){var n="update yvdb_login_users set "+e+" = ? where id = ?",o=[t?1:0,r.get("id")];c(re,n,o,null,null)}function A(e){var t="update yvdb_login_users set android_notification_type = ? where id = ?",n=[e,r.get("id")];c(re,t,n,null,null)}function y(){var e="SELECT * FROM yvdb_servers WHERE is_selected = ?";c(re,e,[1],function(e,t){var o=null;1===t.rows.length?(o=t.rows.item(0),_(o)):(ae={id:-1},n.set_server(ae))},null)}function O(e){var t="select * from yvdb_servers";c(re,t,[],function(t,n){var o,i,r=n.rows.length,a=[];for(i=0;r>i;i++)o=angular.copy(n.rows.item(i)),a.push(o);e&&e(a)},null)}function h(e,t){var n="update yvdb_servers set is_selected = case when id=? then 1 else 0 end";c(re,n,[e.id],t,null)}function I(e,t){var n="delete from yvdb_servers where id=?";c(re,n,[e.id],t,null)}function N(e,t){var n="insert into yvdb_servers (name, host, port, protocol, is_selected) values (?, ?, ?, ?, ?)",o="update yvdb_servers set is_selected = case when id=? then 1 else 0 end",i=e.select?1:0,r=[e.name,e.host,e.port,e.protocol,i];c(re,n,r,function(n,i){e.select?c(re,o,[i.insertId],function(e,n){t&&t()},null):t&&t()},null)}function R(e){var t=r.get("app").app_key,n=hex_sha1(e+t);try{ie=s(n)}catch(o){console.error("encount error when init userdb",o)}return ie}function C(e){var t="CREATE TABLE IF NOT EXISTS userdb_objects (id integer primary key, type text, uuid text unique,  name text, fullname text, signature text, email text, icon text, updatetime integer)",n="CREATE TABLE IF NOT EXISTS userdb_messages (id integer primary key, conversation_uuid text, task_uuid text,  push_uuid text, from_uuid text, to_uuid text, to_type text, type text, subtype text, title text, body text, file text,  size integer, name text, mime text, duration integer, thumbnail text, direction text, status text, timestamp integer)",o="CREATE TABLE IF NOT EXISTS userdb_conversations (id integer primary key, uuid text unique,  name text, icon text, type text, assigned_uuid text, user_uuid text, group_uuid text, unread integer)",i="CREATE TABLE IF NOT EXISTS userdb_contacts (id integer primary key, uuid text unique,  is_portal_user boolean, is_service_user boolean)";c(ie,t,[],null,null),c(ie,n,[],null,null),c(ie,o,[],null,null),c(ie,i,[],null,null),e&&e()}function L(e){var t="PRAGMA user_version",n="PRAGMA user_version = 1";return o.in_electron()?void C(e):void c(ie,t,[],function(t,o){var i=o.rows.item(0).user_version;return 0===i?(console.log("NO USERDB -> create now."),C(e),void c(ie,n,[],null,null)):1===i?(console.log("HAS USERDB and updated."),void(e&&e())):void 0},null)}function b(e,t){R(e),L(t)}function w(e,t,n){var o="SELECT uuid FROM userdb_conversations WHERE uuid = ?";c(ie,o,[e],function(e,o){o.rows.length?t&&t():n&&n()})}function G(e,t){var n="INSERT INTO userdb_conversations (uuid, name, icon, type, assigned_uuid, user_uuid, group_uuid, unread)  VALUES (?, ?, ?, ?, ?, ?, ?, ?)",o=[e.uuid,e.name,e.icon,e.type,e.assigned_uuid,e.user_uuid,e.group_uuid,e.unread];c(ie,n,o,t,null)}function D(e,t){var n="UPDATE userdb_conversations SET unread = ? WHERE uuid = ?",o=[e.unread,e.uuid];c(ie,n,o,t,null)}function P(e,t){var n="UPDATE userdb_conversations SET group_uuid = ? WHERE uuid = ?",o=[e.group_uuid,e.uuid];c(ie,n,o,t,null)}function U(e){w(e.uuid,function(){console.log("conversation already exists in database, will not add.",e)},function(){G(e)})}function M(e){var t="DELETE FROM userdb_messages WHERE conversation_uuid = ?",n="DELETE FROM userdb_conversations WHERE uuid = ?";c(ie,t,[e.uuid],null,null),c(ie,n,[e.uuid],null,null)}function x(e){var t="DELETE FROM userdb_conversations";c(ie,t,[],e,e)}function k(e){var t="DELETE FROM userdb_contacts";c(ie,t,[],e,e)}function B(e,t){var n=null,o=null;0===arguments.length?(n="UPDATE userdb_objects SET fullname = ?, icon = ?, signature = ? WHERE uuid = ?",o=[r.get("fullname"),r.get("icon"),r.get("signature"),r.get("uuid")]):(n="UPDATE userdb_objects SET "+e+" = ? WHERE uuid = ?",o=[t,r.get("uuid")]),c(ie,n,o,null,null)}function F(e,t,n){var o="SELECT * FROM userdb_objects WHERE uuid = ?";c(ie,o,[e],function(e,o){o.rows.length?t&&t():n&&n()},null)}function $(e){var t="UPDATE userdb_objects SET icon = ?, fullname = ?, signature = ?,  name = ?, email = ?, updatetime = ? WHERE uuid = ?",n=[e.icon,e.fullname,e.signature,e.name,e.email,e.updatetime,e.uuid];c(ie,t,n,null,null)}function V(e){var t="INSERT INTO userdb_objects (uuid, type, icon, signature,  fullname, name, email, updatetime) VALUES (?, ?, ?, ?, ?, ?, ?, ?)",n=e.type||a.YVOBJECT.DEVICE_USER,o=[e.uuid,n,e.icon,e.signature,e.fullname,e.name,e.email,e.updatetime];c(ie,t,o,null,null)}function H(e){F(e.uuid,function(){$(e)},function(){V(e)})}function Y(e){var t="SELECT id FROM userdb_contacts WHERE uuid = ?",n="INSERT INTO userdb_contacts (uuid, is_portal_user, is_service_user) VALUES (?, 0, 1)";c(ie,t,[e.uuid],function(t,o){0===o.rows.length&&c(ie,n,[e.uuid],null,null)},null)}function W(e,t,n){var o="SELECT * FROM userdb_messages WHERE conversation_uuid = ? ORDER BY timestamp, id LIMIT 12";c(ie,o,[e],function(e,n){t&&t(n)},function(e,t){n&&n(t)})}function K(e,t){var n="SELECT task_uuid FROM userdb_messages WHERE task_uuid = ? AND direction = ?",o="INSERT INTO userdb_messages ( conversation_uuid, task_uuid, push_uuid, from_uuid, to_uuid, to_type, type,  subtype, title, body, file, size, mime, name, duration, thumbnail, direction, status, timestamp)  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",i=[e.task_uuid,e.direction],r=[e.conversation_uuid,e.task_uuid,e.push_uuid,e.from_uuid,e.to_uuid,e.to_type,e.type,e.subtype,e.title,e.body,e.file,e.size,e.mime,e.name,e.duration,e.thumbnail,e.direction,e.status,e.timestamp];c(ie,n,i,function(n,i){return i.rows.length?(console.log("msg is duplicated task_uuid: "+e.task_uuid),e.id=i.rows.item(0).id,void(t&&t(e))):void c(ie,o,r,function(n,o){e.id=o.insertId,t&&t(e)},null)},null)}function z(e){var t="DELETE FROM userdb_messages WHERE id = ?";c(ie,t,[e.id],null,null)}function j(e){var t="UPDATE userdb_messages SET status = ?, task_uuid = ?, timestamp = ? WHERE id = ?",n=[e.status,e.task_uuid,e.timestamp,e.id];c(ie,t,n,null,null)}function q(e){var t="UPDATE userdb_messages SET status = ? WHERE id = ?";c(ie,t,[e.status,e.id],null,null)}function X(e){var t="UPDATE userdb_messages SET file = ? WHERE id = ?";c(ie,t,[e.file,e.id],null,null)}function J(e){var t="UPDATE userdb_conversations SET unread = 0 WHERE uuid = ?",n="UPDATE userdb_messages SET status = ? WHERE conversation_uuid = ? AND status = ?",o=[a.RECV_STATUS.RECV_OPEN,e,a.RECV_STATUS.RECV_NEW];c(ie,t,[e],null,null),c(ie,n,o,null,null)}function Q(e,t){var n="UPDATE userdb_messages SET status = ? WHERE id = ?";c(ie,n,[a.RECV_STATUS.RECV_PLAY,e],t,null)}function Z(e,t){var n="SELECT * FROM userdb_messages WHERE conversation_uuid = ? ORDER BY TIMESTAMP DESC LIMIT 1";c(ie,n,[e.uuid],function(n,o){t&&t(o.rows.item(0),e)},null)}function ee(e,t,n){c(ie,e,[],function(e,n){t&&t(e,n)},function(e,t){n&&n(e,t)})}function te(e,t){var n="SELECT * FROM userdb_contacts LEFT JOIN userdb_objects WHERE userdb_contacts.uuid = userdb_objects.uuid";ee(n,e,t)}function ne(e,t){var n="SELECT * FROM userdb_objects ORDER BY fullname";ee(n,e,t)}function oe(e,t){var n=o.page_size(),i="SELECT * FROM userdb_conversations ORDER BY unread DESC limit "+n;ee(i,e,t)}var ie=null,re=null,ae={id:-1};return{init_yvdb:function(e){return v(e)},init_userdb:function(e,t){return b(e,t)},query_server:function(){return y()},query_servers:function(e){return O(e)},select_server:function(e,t){return h(e,t)},add_server:function(e,t){return N(e,t)},delete_server:function(e,t){return I(e,t)},logout_user:function(e){return T(e)},add_login_user:function(e,t,n){return g(e,t,n)},add_conversation:function(e){return U(e)},update_conversation_unread:function(e){return D(e)},update_conversation_group:function(e){return P(e)},add_contact:function(e){return Y(e)},add_object:function(e){return H(e)},load_contacts:function(e,t){return te(e,t)},load_objects:function(e,t){return ne(e,t)},load_conversations:function(e,t){return oe(e,t)},query_messages:function(e,t,n){return W(e,t,n)},insert_message:function(e,t){K(e,t)},delete_message:function(e){return z(e)},delete_conversation:function(e){return M(e)},delete_all_conversations:function(e){return x(e)},delete_all_contacts:function(e){return k(e)},update_message_all:function(e){return j(e)},update_message_status:function(e){return q(e)},update_message_file:function(e){return X(e)},set_audio_read:function(e,t){return Q(e,t)},get_latest_message:function(e,t){return Z(e,t)},update_current_user:function(e,t){return B(e,t)},update_noti_settings:function(e,t){return S(e,t)},update_android_notification_type:function(e,t){return A(e,t)},unread_zero:function(e){return J(e)}}}]),ppmessageModule.factory("yvNoti",["$timeout","$rootScope","yvAPI","yvSys","yvSSL","yvUser","yvLink","yvType","yvAlert","yvLocal","yvBase","yvPush","yvMessage","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l,_,d,p){function f(){e(function(){_.retry(),A(),t.$broadcast("event:get_unack_all")})}function E(){e(function(){y()})}function m(){null==P&&(P=e(function(){P=null},1500),b({type:"typing"}))}function v(){new Date,C()}function g(e){return void 0!==e.type}function T(e){return"ONLINE"==e.type||"TYPING"==e.type?void t.$broadcast("event:"+e.type.toLowerCase(),e):"MSG"==e.type?void S(e.msg):"ACK"==e.type?(console.log("ws ack message: %o",e),void t.$broadcast("event:receive_ack_message",e)):void console.error("unknown ws message: %o",e)}function S(e){return console.log("incoming message: %o",e),t.$broadcast("event:add_message",e),o.in_pc_browser()?void O(e):void 0}function A(){R(),U=setInterval(v,1e4)}function y(){console.log("closing socket..... %o",D),null!=D&&(D.close(),D=null),null!=U&&(clearInterval(U),U=null)}function O(e){if(!s.is_logout(e)&&e.fi!=r.get("uuid")){var t=null,n=null,i=l.get("object",e.fi),u=c.translate("app.GLOBAL.TITLE_DESKTOP"),_=d.get_localized_title(e.bo,e.ms);i?(n=i.fullname+": "+_,t=a.get_user_icon(i.icon)):(n="...: "+_,t=a.default_user_icon()),o.desktop_notification(u,n,t)}}function h(){if(!D)return void console.error("there is no pc socket");var e=D.readyState,t={type:"auth",is_service_user:!0,api_token:r.get("access_token"),user_uuid:r.get("uuid"),device_uuid:r.get("device_uuid"),
app_uuid:r.get("app").uuid};return e===WebSocket.OPEN?(console.log("pc socket is open, will send auth type message to server..."),D.send(JSON.stringify(t)),angular.forEach(M,function(e){console.log("-------send pending message",e),D.send(JSON.stringify(e))}),void(M.length=0)):void console.error("pc socket is not open, current state is: ",G[e])}function I(){console.log("======WS closed==========")}function N(e){var t=JSON.parse(e.data);return console.log("ws message: ",t),g(t)?void T(t):void console.error("unknown message: ",t)}function R(){var e=n.get_server(),t="https://"==e.protocol?"wss://":"ws://",o=e.port?e.host+":"+e.port:e.host,i=t+o+"/pcsocket/WS";D=new WebSocket(i),D.onopen=h,D.onmessage=N,D.onclose=I}function C(){if(!D)return R(),"NO_SOCKET";var e=D.readyState;return e!==WebSocket.CLOSING&&e!==WebSocket.CLOSED||(console.log("socket_reconnect, socket is closing or closed, will reconnect"),R()),G[e]}function L(){o.in_mobile_app()&&(document.removeEventListener("resume",f,!1),document.removeEventListener("pause",E,!1)),o.in_android_app()&&r.get("android_notification_type")===p.NOTIFICATION_TYPE.MQTT&&_.disconnect_mqtt(),y()}function b(e){return D&&D.readyState==WebSocket.OPEN?void D.send(JSON.stringify(e)):void console.error("send type message failed for socket not open")}function w(e,t,n,n){return D&&D.readyState==WebSocket.OPEN?(D.send(JSON.stringify(e)),void(t&&t())):(console.error("send type message failed for socket not open, push it to pending list"),M.push(e),void(n&&n()))}var G=["CONNECTING","OPEN","CLOSING","CLOSED"],D=null,P=null,U=null,M=[];return{init:function(e,t){o.in_mobile_app()&&(document.addEventListener("resume",f,!1),document.addEventListener("pause",E,!1)),o.in_android_app()&&r.get("android_notification_type")===p.NOTIFICATION_TYPE.MQTT&&_.connect_mqtt(),y(),A()},exit:function(){L()},watch_typing:function(e){var t={type:"typing_watch",conversation_uuid:e};b(t)},unwatch_typing:function(e){var t={type:"typing_unwatch",conversation_uuid:e};b(t)},typing:function(){m()},get_ios_token:function(e,t){_real_ios_register(e,t)},send_message:function(e,t,n,n){w(e,t,n,n)}}}]),ppmessageModule.factory("yvPush",["yvAPI","yvSys","yvLog","yvUser","yvConstants",function(e,t,n,o,i){function r(e,o,i){return t.in_mobile_app()?device.isVirtual?(_="YOU-GOT-A-FAKE-IOS-TOKEN-IN-EMULATOR",e&&e(_),void(i&&i())):(l=PushNotification.init({ios:{sound:!0,badge:!0,alert:!0},android:{senderID:ppmessage.sender_id},windows:{}}),l.on("registration",function(t){_=t.registrationId,e&&e(_),i&&i()}),l.on("notification",function(e){n.green("notification arrive",e)}),void l.on("error",function(e){o&&o(e),i&&i()})):void(i&&i())}function a(e,t,o){l&&l.unregister?l.unregister(function(){n.green("unregister push success"),e&&e(),o&&o()},function(e){n.red("unregister push error",t),t&&t(),o&&o()}):(n.yellow("unregister push: no push instance found"),e&&e(),o&&o())}function s(t,i){var r="tcp://"+e.get_server().host+":1883",a={timeout:5,keepAliveInterval:1200,userName:o.get("uuid"),password:o.get("access_token"),notificationTitle:"PPMessage"};mqttPlugin.connect(r,o.get("device_uuid"),a,function(){n.green("mqtt connection is established."),t&&t()},function(e){n.red("---->connect mqtt failed:",e),i&&i()}),mqttPlugin.setOnMessageArrivedCallback(function(e){n.green("receive mqtt message: ",e)})}function u(e){mqttPlugin.disconnect(function(){n.green("disconnect mqtt successful."),e&&e()})}function c(){if(t.in_ios_app())return void r();if(t.in_android_app()){if(o.get("android_notification_type")===i.NOTIFICATION_TYPE.MQTT)return void s();l&&_||r()}}var l=null,_=null;return{register_push:function(e,t,n){r(e,t,n)},unregister_push:function(e,t,n){a(e,t,n)},get_token:function(){return _},connect_mqtt:function(e,t){s(e,t)},disconnect_mqtt:function(e){u(e)},retry:function(){c()}}}]),ppmessageModule.factory("yvUser",["yvSys","yvConstants",function(e,t){function n(t){return r.uuid=t.uuid,r.icon=t.user_icon,r.name=t.user_name,r.email=t.user_email,r.fullname=t.user_fullname,r.signature=t.user_signature,r.updatetime=t.updatetime,r.is_online=!0,e.in_mobile_app()?r.device_uuid=t.mobile_device_uuid:r.device_uuid=t.browser_device_uuid,r}function o(n){return r.app=n.app,r.uuid=n.uuid,r.icon=n.user_icon,r.name=n.user_name,r.email=n.user_email,r.fullname=n.user_fullname,r.signature=n.user_signature,r.updatetime=n.updatetime,r.is_online=!0,r.status=n.service_user_status||t.USER_STATUS.READY,e.in_mobile_app()?r.device_uuid=n.mobile_device_uuid:r.device_uuid=n.browser_device_uuid,r.show_badge=!!n.user_show_badge,r.is_distributor_user=!!n.is_distributor_user,r.mute_notification=!!n.user_mute_notification,r.silence_notification=!!n.user_silence_notification,r.mute_other_mobile_device=!!n.user_mute_other_mobile_device,r}function i(e){return r.id=e.id,r.uuid=e.user_uuid,r.is_online=!!e.is_online,r.device_uuid=e.device_uuid,r.access_token=e.access_token,r.app={uuid:e.app_uuid,app_key:e.app_key,app_name:e.app_name,app_secret:e.app_secret},r.show_badge=!!e.show_badge,r.is_distributor_user=!!e.is_distributor_user,r.mute_notification=!!e.mute_notification,r.silence_notification=!!e.silence_notification,r.android_notification_type=e.android_notification_type||t.NOTIFICATION_TYPE.GCM,r}var r={id:null,icon:null,name:null,uuid:null,email:null,fullname:null,signature:null,device_uuid:null,updatetime:null,is_online:!1,access_token:null,status:t.USER_STATUS.READY,app:{uuid:"",app_key:"",app_name:"",app_secret:""},show_badge:null,mute_notification:null,is_distributor_user:null,silence_notification:null,mute_other_mobile_device:null,android_notification_type:t.NOTIFICATION_TYPE.GCM};return{update_user_from_login:function(e){return o(e)},update_user_from_api:function(e){return n(e)},update_user_from_db:function(e){return i(e)},set:function(e,t){r.hasOwnProperty(e)&&(r[e]=t)},mset:function(e){angular.forEach(e,function(e,t){r.hasOwnProperty(t)&&(r[t]=e)})},get:function(e){return 0===arguments.length?r:r.hasOwnProperty(e)?r[e]:null}}}]),ppmessageModule.factory("yvSend",["$rootScope","yvConstants","yvNoti","yvMessage",function(e,t,n,o){function i(i,r){function a(){var n=t.SEND_STATUS.SEND_SUCCESS;e.$broadcast("event:update_message_status",i,n)}function s(){var n=t.SEND_STATUS.SEND_ERROR;e.$broadcast("event:update_message_status",i,n)}var u=null;if(r===!0)u=o.create_api_forward_message(i),yvAPI.forward_message(u,a,s);else{u=o.create_api_send_message(i);var c={type:"send",send:u};n.send_message(c,a,s)}}return{send_message:function(e,t){i(e,t)}}}]),ppmessageModule.factory("yvMessage",["$timeout","yvSys","yvUser","yvFile","yvType","yvLocal","yvConstants",function(e,t,n,o,i,r,a){function s(e){this.task_uuid=e,"string"!=typeof this.from_uuid&&(s.prototype.to_uuid="",s.prototype.to_type="",s.prototype.from_uuid="",s.prototype.push_uuid="",s.prototype.conversation_uuid="",s.prototype.is_history=!1,s.prototype.id=0,s.prototype.size=0,s.prototype.type="",s.prototype.body="",s.prototype.file="",s.prototype.name="",s.prototype.mime="",s.prototype.title="",s.prototype.status="",s.prototype.duration=0,s.prototype.subtype="",s.prototype.timestamp=0,s.prototype.thumbnail="",s.prototype.direction="")}function u(e){e||(e=t.get_uuid());var n=new s(e);return n}function c(e,t){var o=a.MESSAGE_DIR.DIR_IN;return e===n.get("uuid")&&(o=a.MESSAGE_DIR.DIR_OUT),o}function l(e,t){var o=a.RECV_STATUS.RECV_NEW;return e===n.get("uuid")&&(o=a.SEND_STATUS.SEND_SUCCESS),o}function _(e,t){var n=a.MESSAGE_SUBTYPE;switch(t){case n.TEXT:return e;case n.TXT:return"app.GLOBAL.TITLE_TXT";case n.IMAGE:return"app.GLOBAL.TITLE_IMAGE";case n.FILE:return"app.GLOBAL.TITLE_FILE";case n.AUDIO:return"app.GLOBAL.TITLE_AUDIO";case n.GPS_LOCATION:return"app.GLOBAL.TITLE_GPS_LOCATION";case n.SINGLE_CARD:return"app.GLOBAL.TITLE_SINGLE_CARD";case n.MULTIPLE_CARD:return"app.GLOBAL.TITLE_MULTIPLE_CARD";case n.ACCEPT_CONTACT:return"app.GLOBAL.TITLE_ACCEPT_CONTACT";case n.INVITE_CONTACT:return e;case n.DG_INVITED:return"app.GLOBAL.TITLE_DG_INVITED";case n.REQUEST_JOIN_OG:return"app.GLOBAL.BODY_REQUEST_JOIN_OG";case n.APPROVE_JOIN_OG:return"app.GLOBAL.BODY_APPROVE_JOIN_OG";case n.LOGOUT:return"app.GLOBAL.TITLE_LOGOUT";default:return console.error("unknown message subtype",t),"app.GLOBAL.TITLE_UNKNOWN"}}function d(e){var t=u(e.ci);return t.to_uuid=e.ti,t.to_type=e.tt,t.from_uuid=e.fi,t.from_type=e.ft,t.task_uuid=e.id,t.push_uuid=e.pid,t.from_user=e.from_user,t.conversation_uuid=e.ci,t.body=e.bo,t.type=e.mt,t.subtype=e.ms,t.timestamp=e.ts,t.title=_(e.bo,e.ms),t.status=l(e.fi,e.ti),t.direction=c(e.fi,e.ti),t.from_unack=!!e.from_unack,t}function p(e){return i.is_file(e)?E(e):i.is_image(e)?v(e):i.is_text(e)?g(e):i.is_txt(e)?T(e):i.is_gps_location(e)?S(e):i.is_audio(e)?m(e):(console.log("create_api_message can not handle message: ",e),null)}function f(e,t){var o={uuid:e.task_uuid,app_uuid:n.get("app").uuid,to_uuid:e.to_uuid,to_type:e.to_type,from_uuid:n.get("uuid"),from_type:a.YVOBJECT.DEVICE_USER,device_uuid:n.get("device_uuid"),message_type:e.type,message_subtype:e.subtype,conversation_uuid:e.conversation_uuid,conversation_type:e.conversation_type,message_body:t?JSON.stringify(t):e.body};return o}function E(e){var t={fid:e.file,mime:e.mime,name:e.name};return f(e,t)}function m(e){var n={fid:null,mime:e.mime,dura:e.duration};return t.in_mobile_app()?n.fid=e.fid:n.fid=e.file,f(e,n)}function v(e){var n={fid:null,mime:e.mime};return t.in_mobile_app()?n.fid=e.fid:n.fid=e.file,f(e,n)}function g(e){return f(e)}function T(e){var n={fid:null};return t.in_mobile_app()?n.fid=e.fid:n.fid=e.file,f(e,n)}function S(e){return f(e)}function A(e){var t="yyyy/MM/dd HH:mm:ss",n=e.slice(0,t.length).replace(/-/g,"/");return Date.parse(n)/1e3}function y(e){var o=u(e.uuid);return body=angular.fromJson(e.message_body),body?(o.is_history=!0,o.body=body.bo,o.type=body.mt,o.subtype=body.ms,o.to_uuid=body.ti,o.to_type=body.tt,o.from_uuid=body.fi,o.id=t.get_uuid(),o.conversation_uuid=body.ci,o.timestamp=body.ts,o.title=_(body.bo,body.ms),body.fi===n.get("uuid")&&body.tt!==a.CONVERSATION_TYPE.P2S?(o.direction=a.MESSAGE_DIR.DIR_OUT,o.status=a.SEND_STATUS.SEND_SUCCESS):(o.direction=a.MESSAGE_DIR.DIR_IN,o.status=a.RECV_STATUS.RECV_OPEN,o.subtype===a.MESSAGE_SUBTYPE.AUDIO&&(o.status=a.RECV_STATUS.RECV_PLAY)),o):o}function O(e,t){var o=u(),r=t.data,s=t.type;return o.subtype=s,o.type=a.MESSAGE_TYPE.NOTI,o.title=_(r,s),o.timestamp=Date.now()/1e3,o.direction=a.MESSAGE_DIR.DIR_OUT,o.status=a.SEND_STATUS.SEND_PENDING,o.from_uuid=n.get("uuid"),o.to_uuid=e.user_uuid,o.conversation_uuid=e.uuid,o.conversation_type=e.type,o.to_type=a.YVOBJECT.DEVICE_USER,e.type==a.CONVERSATION_TYPE.P2S&&(o.conversation_type=a.CONVERSATION_TYPE.S2P),e.latest_message&&e.latest_message.timestamp>o.timestamp&&(o.timestamp=e.latest_message.timestamp+1),i.is_text(o)?h(o,r):i.is_txt(o)?I(o,r):i.is_gps_location(o)?L(o,r):i.is_audio(o)?N(o,r):i.is_image(o)?R(o,r):i.is_file(o)?C(o,r):(console.error("unknown message:",t),null)}function h(e,t){return e.body=t,e}function I(e,t){return e.file=t.fid,e.mime="text/plain",e}function N(e,n){if(e.duration=n.dura,e.file=n.url,t.in_ios_app())e.mime="audio/m4a";else{if(!t.in_android_app())return console.error("pc not support recording..."),null;e.mime="audio/amr"}return e}function R(e,n){return t.in_mobile_app()?(e.mime="image/jpeg",e.file=n.file):(e.file=n.file,e.name=n.name,e.size=n.size,e.mime=n.mime),e}function C(e,n){return t.in_ios_app()?(console.error("mobile txt should not create here."),null):(e.name=n.name,e.size=n.size,e.mime=n.mime,e)}function L(e,t){return e.file=t.file,e.body=t.body,e.mime="image/jpeg",e}return{create_slack_message:function(e,t,n,o,i){var r=u();return r.direction=a.MESSAGE_DIR.DIR_OUT,r.status=a.SEND_STATUS.SEND_PENDING,r.from_id=e,r.to_id=t,r.from_name=n,r.loop_id=o,r.type=a.MESSAGE_TYPE.NOTI,r.name=i.name,r.size=i.size,r.mime=i.mimetype,r.subtype=a.MESSAGE_SUBTYPE.FILE,r},create_api_send_message:function(e){return p(e)},history_message:function(e){return y(e)},get_raw_title:function(e,t){return _(e,t)},localize_title:function(e){return r.translate(e)},get_localized_title:function(e,t){var n=_(e,t),o=a.MESSAGE_SUBTYPE;return t===o.TEXT?e:r.translate(n)},create_forward_message:function(e){var t=e.message,o={from_uuid:n.get("uuid"),to_uuid:e.conv_uuid,to_type:e.conv_type,task_uuid:t.task_uuid,conversation_uuid:e.conv_uuid,timestamp:Date.now()/1e3,direction:a.DIR.DIR_OUT,status:a.SEND_STATUS.SEND_PENDING,type:t.type,subtype:t.subtype,title:t.title,body:t.body,duration:t.duration,file:t.file,name:t.name,mime:t.mime,size:t.size,thumbnail:t.thumbnail};return o.conversation_type=a.CONVERSATION_TYPE.S2S,e.conv_type==a.CONVERSATION_TYPE.P2S&&(o.to_type=a.CONVERSATION_TYPE.S2P,o.conversation_type=a.CONVERSATION_TYPE.S2P),o},create_sending_message:function(e,t){return O(e,t)},get_standard_message:function(e){return d(e)},create_api_forward_message:function(e){var t={to_uuid:e.to_uuid,to_type:e.to_type,conversation_type:e.conversation_type,task_uuid:e.task_uuid};return t},string_to_ts:function(e){return A(e)},create:function(e){return u(e)},check_prototype:function(e){return!!s.prototype.isPrototypeOf(messsage)}}}]),ppmessageModule.factory("yvSys",["$state","$timeout","$cookies","$window","yvLog","yvConstants",function(e,t,n,o,i,r){function a(){return void 0===window.Notification?void console.error("No Notification support."):void("granted"!==Notification.permission&&Notification.requestPermission(function(e){Notification.permission!==e&&(Notification.permission=e)}))}function s(e,t,n){var o=null,i=null;if(a(),window.Notification&&"granted"!==Notification.permission)return void console.error("Needs Notification permission.");if(window.Notification&&"granted"===Notification.permission){if(o={body:t},n&&(o.icon=n),console.log(o),document.hidden===!1)return;i=new Notification(e,o),setTimeout(i.close.bind(i),3e3)}}function u(){var e,t;return e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:7&n|8).toString(16)})}function c(e){var t=new Date,o=u();return t.setDate(t.getDate()+"30"),n.put(e,o,{expires:t}),o}function l(e,t){var n=document.createElement("a"),o=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});t&&(n.download=t),n.href=e,n.dispatchEvent(o)}function _(e,n,o){reader=new FileReader,reader.onload=function(e){t(function(){n&&n(e.target.result)})},reader.onerror=function(e){o&&o(e)},reader.readAsDataURL(e)}var d=15,p=216,f=!0,E={id:"",display_name:r.DEFAULT_BUNDLE_NAME},m=ionic.Platform,v={isWebView:m.isWebView(),isIPad:m.isIPad(),isIOS:m.isIOS()||m.isIPad(),isAndroid:m.isAndroid(),isWindowsPhone:m.isWindowsPhone(),platform:m.platform(),version:m.version(),device:m.device()};return(v.isIOS||v.isAndroid||v.isWindowsPhone)&&(d=Math.floor(screen.height/72)),{in_mobile:function(){return this.in_mobile_app()||this.in_mobile_browser()},in_mobile_app:function(){return v.isWebView},in_mobile_browser:function(){return jscd.mobile&&!v.isWebView},in_browser:function(){return this.in_pc_browser()||this.in_mobile_browser()},in_pc_browser:function(){return!jscd.mobile&&!window.require},in_pc:function(){return this.in_pc_browser()||this.in_electron()},has_db:function(){return this.in_mobile_app()||this.in_electron()},in_electron:function(){return window.require&&process&&process.versions&&process.versions.electron},in_ios_app:function(){return this.in_mobile_app()&&v.isIOS},in_android_app:function(){return this.in_mobile_app()&&v.isAndroid},in_wp_app:function(){return this.in_mobile_app()&&v.isWindowsPhone},in_ios_browser:function(){return this.in_mobile_browser()&&v.isIOS},in_android_browser:function(){return this.in_mobile_browser()&&v.isAndroid},in_wp_browser:function(){return this.in_mobile_browser()&&v.isWindowsPhone},in_win_browser:function(){return this.in_pc_browser()&&0===jscd.os.indexOf("Win")},in_mac_browser:function(){return this.in_pc_browser()&&0===jscd.os.indexOf("Mac")},in_linux_browser:function(){return this.in_pc_browser()&&0===jscd.os.indexOf("Lin")},in_mac_electron:function(){return this.in_electron()&&"darwin"===process.platform},in_win32_electron:function(){return this.in_electron()&&"win32"===process.platform},in_win64_electron:function(){return this.in_electron()&&"win64"===process.platform},in_linux_electron:function(){return this.in_electron()&&"linux"===process.platform},in_nw:function(){return window.require&&process&&process.versions&&!process.versions.electron},in_node:function(){return window.require&&process},get_bundle_info:function(){return E},set_bundle_info:function(){cordova.getAppVersion.getPackageName(function(e){E.id=e},null),cordova.getAppVersion.getAppName(function(e){E.display_name=e},null)},get_device_info:function(){return v.device},get_device_uuid:function(e){if(this.in_mobile_app())return v.device.uuid;if(this.in_browser()||this.in_electron()){var t="ppkefu-device-uuid:"+e;t=hex_sha1(t).toLowerCase();var o=n.get(t);return o||(o=c(t)),o}return null},get_device_platform:function(){var e=r.PLATFORM;return this.in_ios_app()?e.IOS:this.in_android_app()?e.ANDROID:this.in_wp_app()?e.WIP:this.in_ios_browser()?e.IOS_BROWSER:this.in_android_browser()?e.ANDROID_BROWSER:this.in_wp_browser()?e.WIP_BROWSER:this.in_win32_electron()?e.WIN32:this.in_win64_electron()?e.WIN64:this.in_mac_electron()?e.MAC:this.in_linux_electron()?e.LINUX:this.in_win_browser()?e.WIN_BROWSER:this.in_mac_browser()?e.MAC_BROWSER:this.in_linux_browser()?e.LINUX_BROWSER:v.platform.substring(0,3).toUpperCase()},get_device_model:function(){return v.device.model},get_device_fullname:function(){if(this.in_mobile_app()){var e=cordova.plugins.deviceName;return e.name}return v.platform+" "+v.version+" "+jscd.browser+" "+jscd.browserVersion},get_device_version:function(){return v.version},request_desktop_notification:function(){return a()},desktop_notification:function(e,t,n){return s(e,t,n)},get_app_body_style:function(){if(this.in_mobile()||this.in_electron())return{};var e="0%",t="100%",n=0,o=1068,i=window.innerWidth,r=window.innerHeight,a={width:"100%",minHeight:"600px",maxWidth:o+"px"};return i>=o&&(n=(i-o)/2),r>667&&(e="7%",t="83%"),a.left=n+"px",a.height=t,a.top=e,a},set_keyboard_height:function(e){if(this.in_android_app()){var t=screen.height-window.innerHeight;p=e-t}else this.in_ios_app()&&(p=e)},get_keyboard_height:function(){var e=p;return v.isAndroid&&e>400&&(e-=50),e},get_uuid:function(){return u()},encode_utf8:function(e){return unescape(encodeURIComponent(e))},page_size:function(){return d},device_online:function(){f=!0},device_offline:function(){f=!1},is_device_online:function(){return f},get_device_network:function(){return navigator.connection.type},click_download:function(e,t){return l(e,t)},hide_statusbar:function(e){ionic.Platform.isFullScreen&&t(function(){ionic.Platform.showStatusBar(!1)})},read_image_file:function(e,t,n){_(e,t,n)},is_file:function(e){return angular.isObject(e)&&e instanceof o.File},is_image_file:function(e){if(!this.is_file(e))return!1;var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(t)}}}]),ppmessageModule.factory("yvMime",[function(){function e(e){var t="img/document-word.png",n="img/document-xls.png",o="img/document-pdf.png",i="img/document-ppt.png",r="img/document-plain.png",a={"application/vnd.openxmlformats-officedocument.wordprocessingml.document":t,"application/msword":t,"application/vnd.ms-excel":n,"application/x-excel":n,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":n,"application/vnd.ms-powerpoint":i,"application/vnd.openxmlformats-officedocument.presentationml.presentation":i,"application/vnd.openxmlformats-officedocument.presentationml.slideshow":i,"application/pdf":o};return a.hasOwnProperty(e)?a[e]:r}function t(e){var t={"application/msword":"doc","application/x-excel":"xls","application/vnd.ms-excel":"xls","application/vnd.ms-powerpoint":"ppt","application/vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","application/vnd.openxmlformats-officedocument.presentationml.slideshow":"ppsx","application/vnd.openxmlformats-officedocument.presentationml.presentation":"pptx","application/pdf":"pdf","image/jpeg":"jpeg","image/png":"png","image/tiff":"tiff","image/gif":"gif"};return t.hasOwnProperty(e)?t[e]:"bin"}return{mime_icon:function(t){return e(t)},mime_ext:function(e){return t(e)}}}]),ppmessageModule.factory("yvUploader",["$timeout","FileUploader","yvLog","yvAPI","yvSys","yvUser","yvMain","yvBase","yvSend","yvConstants",function(e,t,n,o,i,r,a,s,u,c){function l(e){var t=e.type,n=null,o=new RegExp("^image/*");return n=o.test(t)&&!i.in_mobile_app()?c.MESSAGE_SUBTYPE.IMAGE:c.MESSAGE_SUBTYPE.FILE,{type:n,data:{file:e,size:e.size,name:e.name,mime:e.type||"application/octet-stream"}}}function _(t,i,a,s){var u=i.localURL,c=new FileUploadOptions,l=o.get_server(),_=encodeURI(l.upload_url);c.fileKey="file",c.mimeType=t.mime,c.fileName=t.name,c.params={user_uuid:r.get("uuid")},"https://"==l.protocol&&(c.chunkedMode=!1),t.ft=new FileTransfer,t.ft.onprogress=function(n){n.lengthComputable&&e(function(){t.upload_progress=n.loaded/n.total*100})},t.ft.upload(u,_,function(e){var t=angular.fromJson(e.response);t&&t.fuuid?a&&a(t.fuuid):(n.error("FileTransfer return invalid response",e),s&&s())},function(e){return 4==e.code?void n.log("File Transfer canceled",e):(n.error("FileTransfer _err: %o.",e),void(s&&s()))},c,!0)}function d(t,o,i,r){o.onProgress=function(n){e(function(){t.upload_progress=n})},o.onSuccess=function(e){i&&i(e.fuuid)},o.onCancel=function(e){n.log("file item upload canceled",o)},o.onError=function(e){n.error("file item upload error",e),r&&r()},t.fileItem=o,t.fileItem.upload()}function p(e){function t(){a.update_message_status(r,c.SEND_STATUS.SEND_ERROR)}function n(e){a.update_message_status(r,c.SEND_STATUS.SEND_SENDING),a.update_message_file(r,e),u.send_message(r,!1)}function o(){a.update_message_status(r,c.SEND_STATUS.SEND_UPLOADING),i.in_android_app()?_(r,e,n,t):d(r,e,n,t)}var r=null,p=i.in_android_app()?e:e._file,f=s.active("conversation"),E=l(p);a.prepare_send(f,E,function(e){r=e,a.update_message_status(r,c.SEND_STATUS.SEND_CHECKING),o()})}function f(){t.FileSelect.prototype.isEmptyAfterSelection=function(){return!0};var e=new t;return e.onAfterAddingFile=function(e){p(e)},e}return{get_uploader:function(){return f()},send_file:function(e){return p(e)}}}]),ppmessageModule.factory("yvLogin",["$state","$timeout","$ionicLoading","yvSys","yvAPI","yvNav","yvLog","yvNoti","yvUser","yvMain","yvLink","yvPush","yvAlert","yvLogout","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l,_,d,p,f){function E(){this.user_email=null,this.user_password=null,this.access_token=null,this.user_status=null,"string"!=typeof this.device_token&&(E.prototype.device_uuid=o.get_device_uuid(),E.prototype.device_token=null,E.prototype.ios_app_development=!0,E.prototype.device_model=o.get_device_model(),E.prototype.device_version=o.get_device_version(),E.prototype.device_platform=o.get_device_platform(),E.prototype.device_fullname=o.get_device_fullname(),E.prototype.login=function(){var e=this;i.token(e,function(t){i.login(e,function(t){e._login_success(t)},function(){e._login_error("app.GLOBAL.ERR_NET")},function(){e._login_error("app.GLOBAL.ERR_LOGIN")})},function(){e._login_error("app.GLOBAL.ERR_NET")},function(){e._login_error("app.GLOBAL.ERR_USERPASS")})},E.prototype._login_error=function(e){m(),d.tip(e)},E.prototype._login_success=function(e){e.access_token=this.access_token,c.add_login_user(e,g)})}function m(){n.hide()}function v(){n.show({delay:100,duration:15e4,template:"<ion-spinner></ion-spinner>"})}function g(e){s.init(),c.reload(e,function(){t(function(){r.go_conversation_list(),m()})})}function T(e){y||(y=new E),y.user_email=e.email,y.access_token=e.access_token,y.device_uuid=e.device_uuid,i.test_api(function(e){e.mobile_device_uuid!==u.get("device_uuid")?p.local_logout():(u.update_user_from_api(e),g())},function(){g(!0)},function(){r.login_with_user()})}function S(e){var t=i.get_server();if(y||(y=new E),v(),!e.user_email||!e.user_password)return void y._login_error("app.GLOBAL.ERR_NO_ENOUGH_INFO");if(y.user_email=e.user_email,y.user_password=e.user_password,y.user_status=e.user_status,console.log("-------user status",e.user_status),!t||-1===t.id)return void y._login_error("app.GLOBAL.ERR_NO_SERVER");if(o.in_mobile_app()){var n=_.get_token();return y.device_token=n,o.in_ios_app()&&(y.ios_app_development=!!ppmessage.developer_mode),o.in_android_app()&&u.get("android_notification_type")===f.NOTIFICATION_TYPE.MQTT&&(y.device_token=null),void y.login()}y.device_uuid=o.get_device_uuid(y.user_email),console.log("session device_uuid is %s",y.device_uuid),y.login()}function A(){y||p.logout_reset()}var y=null;return{login:function(e){return S(e)},login_with_session:function(e){return T(e)},after_login:function(){return _after_login()},enter_app:function(e){return g(e)},check_session:function(){return A()},current_session:function(){return y}}}]),ppmessageModule.factory("yvLogout",["$rootScope","yvDB","yvSys","yvNav","yvAPI","yvNoti","yvBase",function(e,t,n,o,i,r,a){function s(e){n.has_db()&&t.logout_user(),r.exit(),a.reset(),o.exit_app(e)}function u(){i.logout(),s(!1)}var c=e.$new();return c.$on("event:logout",function(e){s()}),{logout:function(){u()},local_logout:function(){s(!1)},logout_reset:function(){s(!0)}}}]),ppmessageModule.factory("yvNav",["$ionicHistory","$timeout","$state","yvSys","yvUser","yvConstants",function(e,t,n,o,i,r){return{go_back:function(t){var n=e.currentHistoryId(),o=e.viewHistory().histories[n],i=o.stack.length-1-t;e.backView(o.stack[i]),e.goBack()},return_to:function(t){var n=e.currentHistoryId(),o=e.viewHistory().histories[n],i=o.stack.length-1;for(i;i>=0;i--)o.stack[i].stateName===t&&(e.backView(o.stack[i]),e.goBack())},clear:function(n){t(function(){e.clearHistory(),e.clearCache().then(n)})},disable_next:function(){e.nextViewOptions({disableAnimate:!0,disableBack:!0})},disable_back:function(){e.nextViewOptions({disableBack:!0})},login_no_user:function(){this.disable_next(),n.go("noapp.login-no-user")},login_with_user:function(e){return this.disable_next(),0!==arguments.length&&e||(e=i.get()),e.email?void n.go("noapp.login-with-user",{icon:e.icon,email:e.email,fullname:e.fullname}):this.login_no_user()},go_conversation_list:function(){this.disable_next();var e="app.conversation-list";o.in_mobile()&&(e="app.conversation-list-mobile"),t(function(){n.go(e)})},exit_app:function(e){return this.disable_next(),e?void n.go("main-with-logo"):void this.login_with_user()}}}]),ppmessageModule.factory("yvLink",["$window","yvAPI","yvSys","yvUser","yvMime","yvFile","yvLocal","yvConstants",function(e,t,n,o,i,r,a,s){return{default_user_icon:function(){return"img/default_user.png"},default_image_pic:function(){return"img/default_pic.png"},default_card_cover:function(){return"img/default_card_cover.png"},current_user_avatar:function(){var e=o.get("icon");return this.get_user_icon(e)},get_user_icon:function(e){if(e&&0===e.indexOf("http"))return e;var o=null;return e&&(o=n.in_mobile_app()?r.get_root_dir()+e:t.get_icon_url(e)),null===o&&(o=this.default_user_icon()),o},get_real_icon:function(e,o){return e?n.in_mobile_app()?void t.download_file(e,null,function(e){o(e.name)},function(){o(null)}):o(e):o(null)},get_message_image:function(o){if(o.file instanceof e.File)return o.file;var a=o.file||o.thumbnail;return a?n.in_mobile_app()?0===a.indexOf("file://")?a:r.get_root_dir()+a:t.get_image_url(a,i.mime_ext(o.mime)):this.default_image_pic()},get_message_location_image:function(e){if(n.in_mobile_app()){if(e.file)return r.get_root_dir()+e.file}else if(e.file)return e.file;return this.default_image_pic()},get_card_cover:function(e){if(n.in_mobile_app()){if(e&&e.cover_local_file)return r.get_root_dir()+e.cover_local_file}else if(e&&e.cover_server_uuid)return t.get_image_url(e.cover_server_uuid,"png");return this.default_card_cover()},open_link:function(e,t){e.preventDefault();var o=e.target.href,i="location=yes,closebuttoncaption="+a.translate("app.GLOBAL.CLOSE");return o?n.in_mobile_app()?void window.open(o,"_blank",i):void window.open(o,"_blank"):void(t&&t())}}}]),ppmessageModule.factory("yvLocal",["$filter","$cookies","$translate","yvSys","yvAPI",function(e,t,n,o,i){function r(){var e=require("electron").remote.getCurrentWindow(),t=e.webContents.session;return t}function a(e){if(o.in_electron()){var n=r(),a=i.get_server(),s={url:a.protocol+a.host,name:"current_language"};n.cookies.get(s,function(t,n){t&&console.error(t);var o=navigator.language;n.length>0&&n[0].value&&(o=n[0].value),e(o)})}else{var u=t.get("current_language")||navigator.language;e(u)}}function s(e){var n=new Date;if(n.setDate(n.getDate()+"365"),o.in_electron()){var a=r(),s=i.get_server(),u={url:s.protocol+s.host,name:"current_language",value:e,expirationDate:n/1e3};a.cookies.set(u,function(e){e&&console.error(e)})}else t.put("current_language",e,{expires:n})}function u(t){return t&&"string"==typeof t?e("translate")(t):t}function c(e,t){if(!e)return"";var n=moment(),o=n.clone().startOf("day"),i=n.clone().endOf("day"),r=moment.unix(e);return r.isBetween(o,i)?r.format("HH:mm"):r.isAfter(i)?t?r.format("MM-DD"):r.format("MM-DD HH:mm"):(o.subtract(1,"day"),i.subtract(1,"day"),r.isBetween(o,i)?t?u("app.GLOBAL.YESTERDAY")+r.format(" HH:mm"):u("app.GLOBAL.YESTERDAY"):t?r.format("MM-DD HH:mm"):r.format("MM-DD"))}function l(){var e=u("app.GLOBAL.TIMESTAMP_LANGUAGE");moment.locale(e)}function _(e){var t=e.toLowerCase();return 0===t.indexOf("zh")?"zh-Hans":0===t.indexOf("en")?"en":e}return{localize:function(e){return o.in_mobile_app()?void navigator.globalization.getPreferredLanguage(function(t){var o=_(t.value);n.use(o).then(function(){l(),e&&e()})}):void a(function(t){n.use(t).then(function(){l(),e&&e()})})},localize_by_language:function(e){n.use(e).then(function(){l(),s(e)})},filter_language:function(e){return _(e)},get_current_language:function(e){return a(e)},set_current_language:function(e){return s(e)},translate:function(e){return u(e)},format_timestamp:function(e,t){return c(e,t)}}}]),ppmessageModule.factory("FileChooser",["$window",function(e){function t(){this.filesMap={}}return t.ROOT_RELATIVE_PATH="",t.prototype._errorHandler=function(e){var t="",n=window.FileError;switch(e.code){case n.QUOTA_EXCEEDED_ERR:t="QUOTA_EXCEEDED_ERR";break;case n.NOT_FOUND_ERR:t="NOT_FOUND_ERR";break;case n.SECURITY_ERR:t="SECURITY_ERR";break;case n.INVALID_MODIFICATION_ERR:t="INVALID_MODIFICATION_ERR";break;case n.INVALID_STATE_ERR:t="INVALID_STATE_ERR";break;default:t="Unknown Error"+e.code}console.log("Error: "+t)},t.prototype._fillDirectorys=function(e,t){if(console.log("fill directorys : "+t),this.onBeforeFileClick(t,!0),this.filesMap[t])return console.log("[FileChooser]---->use Cache--->",t),void this.onDirectoryFilesLoadComplected(this.filesMap[t]);var n=this;e.root.getDirectory(t,{create:!1},function(e){function o(o){var i,r=e.fullPath.slice(1,e.fullPath.length-1),a=""===t,s=o.length,u=[];for(r=-1!==r.indexOf("/")?e.fullPath+"../":"",i=0;s>i;i++)o[i].name&&0==o[i].name.indexOf(".")||u.push({name:o[i].name,isDirectory:o[i].isDirectory,fullPath:o[i].fullPath,url:o[i].toURL()});u.sort(function(e,t){return e.name<t.name?-1:1}),a||u.unshift({name:"..",isDirectory:!0,fullPath:r,url:null}),n.filesMap[t]={files:u,folder:e,root:a},n.onDirectoryFilesLoadComplected(n.filesMap[t])}function i(e){console("Failed to list directory contents: "+e.code),n.onDirectoryFilesLoadComplected([])}var r=e.createReader();r.readEntries(o,i)},this._errorHandler)},t.prototype.fillDirectorys=function(t){if(this.fileSystem)this._fillDirectorys(this.fileSystem,t);else{var n=this;e.requestFileSystem=e.requestFileSystem||e.webkitRequestFileSystem,e.requestFileSystem(LocalFileSystem.PERSISTENT,1048576,function(e){n.fileSystem=e,n._fillDirectorys(e,t)},this._errorHandler)}},t.prototype.getFile=function(e,t,n){this.fileSystem?this.fileSystem.root.getFile(e,{},function(e){
e.file(function(e){t&&t(e)})},this._errorHandler):n("no filesystem")},t.prototype.onBeforeFileClick=function(e,t){},t.prototype.onDirectoryFilesLoadComplected=function(e){},t}]),ppmessageModule.factory("yvDelegate",["$ionicListDelegate","$ionicScrollDelegate","$ionicSideMenuDelegate",function(e,t,n){function o(e,t){var n;return s[t]?s[t]:(n=e.$getByHandle(t),s[t]=n||null,n)}var i="conversation-scroll",r="left-sidemenu",a="conversation-list",s={};return{get_scroll_delegate:function(e){return 0!==arguments.length&&e||(e=i),o(t,e)},scroll_bottom:function(e,t){var n=this.get_scroll_delegate(e);n&&n.scrollBottom(!!t)},scroll_top:function(e,t){var n=this.get_scroll_delegate(e);n&&n.scrollTop(!!t)},scroll_resize:function(e){var t=this.get_scroll_delegate(e);t&&t.resize()},scroll_down:function(e,t,n){var o=this.get_scroll_delegate(t);o&&o.scrollBy(0,e,!!n)},get_sidemenu_delegate:function(e){return 0!==arguments.length&&e||(e=r),o(n,e)},get_list_delegate:function(t){return 0!==arguments.length&&t||(t=a),o(e,t)}}}]),ppmessageModule.factory("yvUpdater",["yvSys","yvAPI","yvLocal","yvAlert","yvConstants",function(e,t,n,o,i){function r(t){if(e.in_android_app()&&t.download_url)return void window.open(t.download_url,"_system");if(e.in_electron()&&t.download_url){var n=document.createElement("a");return n.href=t.download_url,void n.click()}if(e.in_ios_app()&&t.plist_url){var n=document.createElement("a");return n.href=t.plist_url,void n.click()}}function a(e){var t=n.translate("app.GLOBAL.UPDATE_TITLE"),i=n.translate("app.GLOBAL.UPDATE_CONTENT1")+_+n.translate("app.GLOBAL.UPDATE_CONTENT2")+e.newest_version+n.translate("app.GLOBAL.UPDATE_CONTENT3");o.confirm(t,i,function(){r(e)},null)}function s(e,t){for(var n=e.split("."),o=t.split("."),i=o.length,r=0;i>r;r++){if(!n[r])return!0;if(parseInt(o[r])>parseInt(n[r]))return!0}return!1}function u(t){return e.in_mobile_app()?void window.cordova.getAppVersion(function(e){t&&t(e)}):e.in_electron()?void(t&&t(d.getVersion())):void 0}function c(){var t={},n=i.PLATFORM;if(e.in_mobile_app())return t.app_platform=e.get_device_platform(),t.app_distinct_name=e.get_bundle_info().id,t;if(e.in_electron()){var o=d.getName(),r=e.get_device_platform();return r===n.MAC?t.app_distinct_name=o+".dmg":r!==n.WIN32&&r!==n.WIN64||(t.app_distinct_name=[o,r.toLowerCase(),"setup.exe"].join("-")),t.app_platform=r,t}return t}function l(n,o,i){(e.in_mobile_app()||e.in_electron())&&t.get_app_version(c(),function(e){var t={newest_version:e.app_version_name,download_url:e.app_file_url,plist_url:e.app_plist_url};s(_,t.newest_version)?n&&n(t):o&&o(t)},i,i)}var _=null,d=null;return e.in_electron()&&(d=require("remote").require("app")),u(function(e){_=e}),{confirm_update:function(e){a(e)},check_version:function(e,t,n){l(e,t,n)},check_update:function(){l(a,null)},download_update:function(e){r(e)},current_version:function(){return _}}}]),ppmessageModule.factory("yvObject",[function(){function e(t){this.uuid=t,"string"!=typeof this.name&&(e.prototype.name="",e.prototype.icon="",e.prototype.email="",e.prototype.type="DU",e.prototype.updatetime=0,e.prototype.fullname="",e.prototype.signature="",e.prototype.need_update=!1,e.prototype.mobile_online=!1,e.prototype.browser_online=!1,e.prototype.extra_data=null)}return{check_prototype:function(t){return e.prototype.isPrototypeOf(t)},create:function(t){var n=new e(t);return n}}}]),ppmessageModule.factory("yvContact",[function(){function e(t){this.uuid=t,"string"!=typeof this.name&&(e.prototype.name="",e.prototype.icon="",e.prototype.email="",e.prototype.fullname="",e.prototype.signature="",e.prototype.is_portal_user=!1,e.prototype.is_service_user=!0,e.prototype.online=!1,e.prototype.active=!1)}return{check_prototype:function(t){return e.prototype.isPrototypeOf(t)},create:function(t){var n=new e(t);return n}}}]),ppmessageModule.factory("yvConversation",["$rootScope",function(e){function t(n){function o(e,t){return e.timestamp-t.timestamp}function i(){e.$broadcast("event:reorder-conversations")}this.uuid=n,this.messages=[],"string"!=typeof this.type&&(t.prototype.type="",t.prototype.name="",t.prototype.icon="",t.prototype.unread=0,t.prototype.user_uuid="",t.prototype.group_uuid="",t.prototype.assigned_uuid="",t.prototype.last_chat_text="",t.prototype.latest_message=null,t.prototype.need_update=!1,t.prototype.active=!1,t.prototype.show=!0,t.prototype.has_message=function(e){if(-1!=this.messages.indexOf(e))return!0;var t=this.get_message_by_tid(e.task_uuid);return!!t},t.prototype.get_message_by_tid=function(e){for(var t=0,n=this.messages.length;n>t;t++)if(this.messages[t].task_uuid==e)return this.messages[t];return null},t.prototype.add_message=function(e){this.has_message(e)||(this.messages.push(e),this._refresh())},t.prototype.delete_message=function(e){var t=this.messages.indexOf(e);-1!==t&&(this.messages.splice(t,1),this._refresh())},t.prototype._reorder_messages=function(){var e=this.messages.length;return this.messages.sort(o),this.messages[e-1]||null},t.prototype._refresh=function(){this.latest_message=this._reorder_messages(),i()})}return{check_prototype:function(e){return t.prototype.isPrototypeOf(e)},create:function(e){var n=new t(e);return n}}}]),ppmessageModule.factory("yvBase",["$timeout","$rootScope","yvDB","yvSys","yvAPI","yvLog","yvLink","yvObject","yvMessage","yvContact","yvConversation",function(e,t,n,o,i,r,a,s,u,c,l){function _(){y.conversations.list.sort(function(e,t){return e.latest_message||t.latest_message?!e.latest_message&&t.latest_message?1:e.latest_message&&!t.latest_message?-1:t.latest_message.timestamp-e.latest_message.timestamp:t.$$hashKey<e.$$hashKey?1:-1})}function d(){y.contacts.list.sort(function(e,t){return e.fullname<=t.fullname?1:-1})}function p(e){y.conversations.list.length=0,angular.forEach(e,function(e){y.conversations.list.push(e)}),_()}function f(e){y.contacts.list.length=0,angular.forEach(e,function(e){y.contacts.list.push(e)}),d()}function E(e){angular.forEach(e,function(e,t){e.need_update&&(e.need_update=!1,i.get_user_info(t,function(t){m(e,t)},function(){e.need_update=!0},function(){e.need_update=!0}))})}function m(t,i,r){t.name=i.user_name,t.email=i.user_email,t.updatetime=i.updatetime,t.fullname=i.user_fullname,t.signature=i.user_signature,a.get_real_icon(i.user_icon,function(i){e(function(){t.icon=i}),r&&r(t),o.has_db()&&n.add_object(t)})}function v(e){angular.forEach(e,function(e,t){e.need_update&&(e.need_update=!1,i.get_conversation(t,function(t){if(t.user_uuid&&!y.objects.dict[t.user_uuid]){var n=s.create(t.user_uuid);n.need_update=!0,y.objects.dict[t.user_uuid]=n}e.show=!0,g(e,t)},function(){e.need_update=!0},function(){e.need_update=!0}))})}function g(t,i,r){var s=i.conversation_icon,c=i.conversation_name;i.conversation_data&&i.conversation_data.conversation_icon&&(s=i.conversation_data.conversation_icon),i.conversation_data&&i.conversation_data.conversation_name&&(c=i.conversation_data.conversation_name),i.latest_message&&(t.latest_message=u.history_message(i.latest_message)),t.name=c,t.user_uuid=i.user_uuid,t.group_uuid=i.group_uuid,t.type=i.conversation_type,_(),r&&r(t),a.get_real_icon(s,function(i){e(function(){t.icon=i}),o.has_db()&&n.add_conversation(t)})}function T(){y.objects.dict={},y.contacts.dict={},y.conversations.dict={}}function S(e,t){var n=O[e];return n?n.create(t):null}function A(e,t){var n=O[e];return n?n.check_prototype(t):!1}var y=t.$new(),O=null,h=null,I=null;return y.objects={dict:{},list:[]},y.conversations={dict:{},list:[],page:0,current_active:null},y.contacts={dict:{},list:[],current_active:null},I={object:y.objects,contact:y.contacts,conversation:y.conversations},O={object:s,contact:c,conversation:l},h={object:m,conversation:g},y.$watchCollection("conversations.dict",function(e,t){p(e),v(e)}),y.$watchCollection("contacts.dict",function(e,t){f(e)}),y.$watchCollection("objects.dict",function(e,t){E(e)}),y.$on("event:reset-base",function(){T()}),y.$on("event:reorder-conversations",function(){_()}),{reset:function(){T()},get:function(e,t,n){var o=I[e];if(o&&o.dict.hasOwnProperty(t)){var i=o.dict[t];if(2===arguments.length)return i;if(i.hasOwnProperty(n))return i[n]}return null},get_scope:function(e){var t=I[e];return t?t:null},get_list:function(e){var t=I[e];return t?t.list:null},set:function(e,t,n,o){var i={};i[n]=o,this.mset(e,t,i)},mset:function(e,t,n){var o=I[e];if(o){var i=o.dict[t];i||(i=S(e,t),o.dict[t]=i),angular.forEach(n,function(e,t){i[t]=e})}},active:function(e,t){var n=I[e];if(!n)return null;if(1===arguments.length)return n.current_active;var o=null,i=n.current_active;return A(e,t)||!t?o=t:n.dict.hasOwnProperty(t)&&(o=n.dict[t]),i&&(i.active=!1),o&&(o.active=!0),n.current_active=o,n.current_active},remove:function(e,t){var n=I[e];if(n){var o=n.dict[t];o&&delete n.dict[t]}},create:function(e,t){var n=this.get(e,t);return n?n:S(e,t)},add:function(e,t){var n=I[e];n.dict[t.uuid]||A(e,t)&&(n.dict[t.uuid]=t)},update:function(e,t,n,o){var i=h[e];i&&i(t,n,o)}}}]),ppmessageModule.factory("yvMain",["$q","$timeout","$rootScope","yvDB","yvLog","yvSys","yvAPI","yvNav","yvNoti","yvMime","yvSend","yvUser","yvLink","yvFile","yvType","yvBase","yvLogout","yvMessage","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l,_,d,p,f,E,m,v,g){function T(e){i.log("receive online message",e);var n=E.get("object",e.user_uuid);n&&t(function(){switch(n.extra_data=e.extra_data,e.browser){case g.ONLINE_STATUS.ONLINE:n.browser_online=!0;break;case g.ONLINE_STATUS.OFFLINE:n.browser_online=!1}switch(e.mobile){case g.ONLINE_STATUS.ONLINE:n.mobile_online=!0;break;case g.ONLINE_STATUS.OFFLINE:n.mobile_online=!1}})}function S(e){return r.has_db()?o.init_yvdb(e):(O(),void(e&&e(null)))}function A(e,t){return r.has_db()?o.init_userdb(e,t):void(t&&t())}function y(e,t){var n=_.update_user_from_login(e);d.get_real_icon(n.icon,function(i){return n.icon=i,E.mset("object",n.uuid,{name:n.name,icon:n.icon,email:n.email,fullname:n.fullname,signature:n.signature,updatetime:n.updatetime}),r.has_db()?void o.add_login_user(n,e.app,function(){o.init_userdb(n.uuid,function(){o.add_object(n),t&&t()})}):void(t&&t())})}function O(){if(r.has_db())return o.query_server();var e={id:0,name:"web",host:window.location.hostname,port:window.location.port,protocol:window.location.protocol+"//"};a.set_server(e)}function h(e){e.unread=0,r.has_db()&&o.unread_zero(e.uuid)}function I(e,t){e.delete_message(t),r.has_db()&&o.delete_message(t)}function N(e){e.status=g.RECV_STATUS.RECV_PLAY,r.has_db()&&o.set_audio_read(e.id)}function R(e){E.remove("conversation",e.uuid),r.has_db()&&o.delete_conversation(e)}function C(e){E.get_scope("conversation").page=0,E.get_scope("conversation").dict={},r.has_db()?o.delete_all_conversations(e):e&&e()}function L(e){E.get_scope("contact").dict={},r.has_db()?o.delete_all_contacts(e):e&&e()}function b(e,t){-1!==["icon","fullname","signature"].indexOf(e)&&(_.set(e,t),E.set("object",_.get("uuid"),e,t),r.has_db()&&o.update_current_user(e,t))}function w(e,t){-1!==["show_badge","mute_notification","silence_notification","is_distributor_user"].indexOf(e)&&(_.set(e,t),r.has_db()&&o.update_noti_settings(e,t))}function G(e){r.in_android_app()&&-1!==[g.NOTIFICATION_TYPE.GCM,g.NOTIFICATION_TYPE.MQTT].indexOf(e)&&(_.set("android_notification_type",e),r.has_db()&&o.update_android_notification_type(e))}function D(e,t){if(e){var n=E.get("object",e.uuid);if(n&&n.updatetime>=parseInt(e.updatetime))return void(t&&t(n));var o=E.create("object",e.uuid);E.add("object",o),E.update("object",o,e,function(e){t&&t(e)})}}function P(e){var t=E.get("object",e);console.log("check object: %o, by uuid: %s.",t,e),t||E.set("object",e,"need_update",!0)}function U(e){E.mset("contact",e.uuid,{name:e.user_name,email:e.user_email,fullname:e.user_fullname,signature:e.user_signature,is_portal_user:!!e.is_portal_user,is_service_user:!!e.is_service_user}),D(e,function(t){E.set("contact",e.uuid,"icon",t.icon)}),r.has_db()&&o.add_contact(e)}function M(e){switch(e.type){case g.CONVERSATION_TYPE.S2S:return!0;case g.CONVERSATION_TYPE.P2S:var t=E.get("object",e.user_uuid);if(!t)return!1;if(t.mobile_online||t.browser_online)return!0;default:return!1}}function x(e,t){var n=E.create("conversation",e.uuid);E.add("conversation",n),E.update("conversation",n,e,t)}function k(e,t){var n=E.get_list("conversation"),o=null;for(var i in n)if(o=n[i],o.type===e.conversation_type&&o.name===e.conversation_name)return E.active("conversation",o),void(t&&t(o));a.create_conversation(e,function(e){x(e,function(e){E.active("conversation",e),t&&t(e)})})}function B(e,t,n){var i=E.active("conversation");(!i||i.uuid!=e.uuid&&t.direction===g.MESSAGE_DIR.DIR_IN)&&(e.unread+=1),!t.from_unack&&e.latest_message&&e.latest_message.timestamp>t.timestamp&&(t.timestamp=e.latest_message.timestamp+1),e.add_message(t),n&&n(),r.has_db()&&(o.insert_message(t),o.update_conversation_unread(e))}function F(e,t){if(!e)return void(t&&t());var n=E.get("conversation",e.conversation_uuid);return n?void B(n,e,t):(n=E.create("conversation",e.conversation_uuid),n.need_update=!0,n.show=!1,E.add("conversation",n),void B(n,e,t))}function $(e,t){var n=null,o=null,i=angular.fromJson(e.body);r.in_ios_app()?n="m4a":r.in_android_app()&&(n="amr"),o=i[n],a.download_file(o.fid,null,function(){e.file=o.fid,e.mime="audio/"+n,e.duration=o.dura,cb(e)})}function V(e,t){var n=null,o=null;return f.is_text(e)?t(e):f.is_gps_location(e)?(o=angular.fromJson(e.body),o.zoom=Math.round(o.zoom),n=a.get_amap_url(o),r.in_mobile_app()?void a.download_file(n,null,function(n){e.file=n.name,e.mime="image/jpeg",t(e)}):(e.file=n,t(e))):f.is_txt(e)?(o=angular.fromJson(e.body),e.mime="text/plain",r.in_mobile_app()?void a.download_file(o.fid,null,function(n){e.file=o.fid,t(e)}):(e.file=o.fid,t(e))):f.is_audio(e)?r.in_mobile_app()?$(e,t):(o=angular.fromJson(e.body),e.duration=o.mp3.dura,e.file=o.mp3.fid,e.mime="audio/mp3",t(e)):f.is_image(e)?(o=angular.fromJson(e.body),e.mime=o.mime,r.in_mobile_app()?void a.download_file(o.thum,null,function(){e.thumbnail=o.thum,t(e)}):(e.thumbnail=o.thum,e.file=o.orig,t(e))):f.is_file(e)?(o=angular.fromJson(e.body),e.mime=o.mime,e.name=o.name,e.size=o.size,e.file=o.fid,t(e)):void console.error("download message file can't handle message --> %o",e)}function H(e){if(e&&0!=e.code){i.error("receive ack message error",e.reason,e);var t=E.get("conversation",e.extra.conversation_uuid);if(t){var n=t.get_message_by_tid(e.extra.uuid);n&&Q(n,g.SEND_STATUS.SEND_ERROR)}}}function Y(e,t,n){var o=[e.push_uuid];W(o,t,n)}function W(e,t,n){var o={list:e};a.ack_message(o,t,n,n)}function K(e,t){var n=_.get("device_uuid");e.body===n&&m.local_logout(),t&&t()}function z(e){V(e,function(e){F(e)})}function j(e,t){var n=v.get_standard_message(e);return f.is_logout(n)?void(t&&K(n)):n.conversation_uuid?(z(n),t&&Y(n),void(n.from_user?D(n.from_user):P(n.from_uuid))):void(t&&Y(n))}function q(){a.get_unacked_messages(function(e){console.log("get unack all:",e.list.length,e.list,e.message),e.list.length&&(angular.forEach(e.message,function(e,t){e=angular.fromJson(e),e&&(e.pid=t,e.from_unack=!0,j(e,!1))}),W(e.list))})}function X(e,t){return r.has_db()?void o.query_messages(e.uuid,function(n){for(var o=null,i=null,r=0,a=n.rows.length;a>r;r++)o=n.rows.item(r),i=v.create(o.task_uuid),i.id=o.id,angular.forEach(o,function(e,t){i[t]=e}),e.messages.push(i);e._refresh(),t&&t(a)}):void(t&&t(0))}function J(e,n){t(function(){e.status=n.status,e.timestamp=n.timestamp,e.task_uuid=n.task_uuid}),r.has_db()&&o.update_message_status(e)}function Q(e,n){t(function(){e.status=n}),r.has_db()&&o.update_message_status(e)}function Z(e,t){e.file=t,r.has_db()&&o.update_message_file(e)}function ee(e,t){return r.in_android_app()&&f.is_file(e)||!r.in_mobile_app()?void(t&&t(e)):f.is_text(e)||!e.mime?(Q(e,g.SEND_STATUS.SEND_SENDING),void(t&&t(e))):(Q(e,g.SEND_STATUS.SEND_UPLOADING),console.log("upload message file",e.mime,e.subtype,e),void a.upload_file(e.file,e.mime,function(n){return null===n?(Q(e,g.SEND_STATUS.SEND_ERROR),void console.error("upload message file error",e)):(e.fid=JSON.parse(n).fuuid,Q(e,g.SEND_STATUS.SEND_SENDING),void(t&&t(e)))}))}function te(e,t,n){var i=v.create_sending_message(e,t);e.add_message(i),n&&n(i),r.has_db()&&o.insert_message(i)}function ne(e,t,n){te(e,t,function(e){var t="function"==typeof n?n:ee;t(e,function(e){l.send_message(e,!1)})})}function oe(){function t(){n.reject("error in update contacts from server")}var n=e.defer();return a.get_service_user_list(function(e){console.log("updating contacts from server..., total count: %d.",e.list.length),L(function(){angular.forEach(e.list,function(e){U(e)}),n.resolve("finish update contacts from server")})},t,t),n.promise}function ie(e){var t={};angular.forEach(e,function(e){!E.get("conversation",e.uuid)&&e.latest_message&&(x(e,null),t[e.user_uuid]=e.from_user)}),angular.forEach(t,function(e){D(e)})}function re(){function t(){n.reject("error in update conversations from server")}var n=e.defer(),o={page_offset:0,page_size:r.page_size()};return a.get_conversation_page(o,function(e){console.log("updating conversations from server..., total count: %d.",e.list.length,e.list),C(function(){ie(e.list),n.resolve("finish update conversations from server")})},t,t),n.promise}function ae(){var t=e.defer();return o.load_objects(function(e,n){for(var o=null,i=0,r=n.rows.length;r>i;i++)o=n.rows.item(i),E.mset("object",o.uuid,o);t.resolve("finish load objects")},function(e,n){t.reject("error in load objects")}),t.promise}function se(){var t=e.defer();return o.load_conversations(function(e,n){for(var i=null,r=0,a=n.rows.length;a>r;r++)i=n.rows.item(r),o.get_latest_message(i,function(e,t){t.latest_message=e,E.mset("conversation",t.uuid,t)});t.resolve("finish load conversations")},function(e,n){t.reject("error in load conversations")}),t.promise}function ue(){var t=e.defer();return o.load_contacts(function(e,n){for(var o=null,i=0,r=n.rows.length;r>i;i++)o=n.rows.item(i),o.is_portal_user=!!o.is_portal_user,o.is_service_user=!!o.is_service_user,E.mset("contact",o.uuid,o);t.resolve("finish load contacts")},function(e,n){t.reject("error in load contacts")}),t.promise}function ce(t,n){var o=oe(),r=re();E.reset(),e.all([o,r]).then(function(e){t&&t()},function(e){i.log("update all from server error:",e),n&&n()})}function le(t){var n=ae(),o=ue(),i=se();E.reset(),e.all([n,o,i])["finally"](function(){t&&t()})}function _e(e){ce(function(){q(),e&&e()},function(){de(e)})}function de(e){r.has_db()&&le(function(){e&&e()})}var pe=n.$new();return pe.$on("event:get_unack_all",function(e){q()}),pe.$on("event:add_message",function(e,t){j(t,!0,null)}),pe.$on("event:receive_ack_message",function(e,t){H(t)}),pe.$on("event:update_message_all",function(e,t,n){J(t,n)}),pe.$on("event:update_message_status",function(e,t,n){Q(t,n)}),pe.$on("event:online",function(e,t){T(t)}),{init_yvdb:function(e){S(e)},init_userdb:function(e,t){A(e,t)},add_login_user:function(e,t){y(e,t)},set_server:function(){O()},unread_zero:function(e){h(e)},delete_message:function(e,t){I(e,t)},set_audio_read:function(e){N(e)},delete_conversation:function(e){R(e)},update_conversations_from_server:function(){return re()},reload:function(e,t){e?de(t):_e(t)},open_conversation:function(e,t){k(e,t)},is_conversation_online:function(e){return M(e)},add_conversation_from_api_reserve:function(e,t){ie(e,t)},add_message:function(e,t,n){j(e,t,n)},prepare_send:function(e,t,n){te(e,t,n)},send_message:function(e,t,n){ne(e,t,n)},get_unack_all:function(){q()},load_conversation_messages:function(e,t){X(e,t)},update_message_status:function(e,t){Q(e,t)},update_message_file:function(e,t){Z(e,t)},update_message_all:function(e,t){J(e,t)},update_current_user:function(e,t){b(e,t)},update_noti_settings:function(e,t){w(e,t)},update_android_notification_type:function(e){G(e)}}}]),ppmessageModule.factory("yvTest",["yvAPI","yvSys","yvUser","yvLog",function(e,t,n,o){function i(){e.validate_online_device(function(e){o.green("success",e)},function(e){o.red("error",e)},function(e){o.yellow("api error",e)})}return{api_validate_online_device:function(){i()}}}]),ppmessageModule.factory("yvMonitor",["yvBase","yvMain","yvTest",function(e,t,n){var o={yvBase:e,yvMain:t,yvTest:n};return o}]),ppmessageModule.factory("yvMenu",["yvLog","yvSys",function(e,t){function n(){var e=[{label:"Edit",submenu:[{label:"Undo",accelerator:"CmdOrCtrl+Z",role:"undo"},{label:"Redo",accelerator:"Shift+CmdOrCtrl+Z",role:"redo"},{type:"separator"},{label:"Cut",accelerator:"CmdOrCtrl+X",role:"cut"},{label:"Copy",accelerator:"CmdOrCtrl+C",role:"copy"},{label:"Paste",accelerator:"CmdOrCtrl+V",role:"paste"},{label:"Select All",accelerator:"CmdOrCtrl+A",role:"selectall"}]},{label:"View",submenu:[{label:"Reload",accelerator:"CmdOrCtrl+R",click:function(e,t){t&&t.reload()}},{label:"Toggle Full Screen",accelerator:function(){return"darwin"==process.platform?"Ctrl+Command+F":"F11"}(),click:function(e,t){t&&t.setFullScreen(!t.isFullScreen())}}]},{label:"Window",role:"window",submenu:[{label:"Minimize",accelerator:"CmdOrCtrl+M",role:"minimize"},{label:"Close",accelerator:"CmdOrCtrl+W",role:"close"}]},{label:"Help",role:"help",submenu:[{label:"Learn More",click:function(){require("electron").shell.openExternal("https://ppmessage.com")}}]}];if("darwin"==process.platform){var t=require("electron").remote.app.getName();e.unshift({label:t,submenu:[{label:"About "+t,role:"about"},{type:"separator"},{label:"Services",role:"services",submenu:[]},{type:"separator"},{label:"Hide "+t,accelerator:"Command+H",role:"hide"},{label:"Hide Others",accelerator:"Command+Alt+H",role:"hideothers"},{label:"Show All",role:"unhide"},{type:"separator"},{label:"Quit",accelerator:"Command+Q",click:function(){var e=require("electron").remote.app;e.quit()}}]}),e[3].submenu.push({type:"separator"},{label:"Bring All to Front",role:"front"})}return e}function o(){var e=require("electron").remote,t=e.Menu,o=n(),i=t.buildFromTemplate(o);t.setApplicationMenu(i)}return{init:function(){t.in_electron()&&o()}}}]),ppmessageModule.directive("yvMessage",["$rootScope","$timeout","$ionicLoading","$ionicActionSheet","yvDB","yvAPI","yvSys","yvLog","yvUser","yvMain","yvFile","yvBase","yvMime","yvType","yvLink","yvAlert","yvLocal","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l,_,d,p,f,E,m,v){function g(i,d,g){function T(){i.message.show_profile=!1}i.copyMessage=function(e){var t="";return p.is_text(e)?t=e.body:p.is_txt(e)&&(t=e.txt_content),a.in_mobile_app()?void cordova.plugins.clipboard.copy(t):void!a.in_mobole()},i.deleteMessage=function(e){i.$parent.deleteMessage(e)},i.hold=function(e){s.log("holding.....");var n="<center style='color: #007aff'>"+m.translate("app.GLOBAL.COPY")+"</center>",r="<center style='color: #007aff'>"+m.translate("app.GLOBAL.FORWARD")+"</center>",u="<center style='color: #ff3b30'>"+m.translate("app.GLOBAL.DELETE")+"</center>",c="<center style='color: #007aff'>"+m.translate("app.GLOBAL.CANCEL")+"</center>",l=null,_=null;return i.$parent.conversation.history?void s.log("converstion.history is true, don't show hold options"):(a.in_mobile_app()&&cordova.plugins.Keyboard.isVisible&&cordova.plugins.Keyboard.close(),l=(p.is_text(e)||p.is_txt(e))&&a.in_mobile_app()?[{text:n}]:[],_=o.show({buttons:l,destructiveText:u,destructiveButtonClicked:function(){return i.deleteMessage(e),!0},cancelText:c,cancel:function(){s.log()},buttonClicked:function(t){return s.log(l[t]),l[t].text===r&&i.$parent.showForwardModal(e),l[t].text===n&&i.copyMessage(e),!0}}),void t(function(){_()},5e3))},i.dbclick=function(e){s.log("dbclick ..."),p.is_text(e)?i.$parent.showTextModal(e.body_linky):p.is_txt(e)&&i.$parent.showTextModal(e.txt_content_linky)},i.openFile=function(e){e=decodeURI(e),cordova.plugins.disusered.open(e,function(){n.hide()},function(e){n.hide(),E.toast(m.translate("app.GLOBAL.CANT_OPEN_FILE"))})},i.handleNormalFile=function(e){var o=e.name||e.file+"."+a.mime_ext(e.mime);return a.in_mobile_app()?(n.show(),void l.has_file(o,function(e){i.openFile(e.toURL())},function(){r.download_file(e.file,o,function(e){i.openFile(e.toURL())})})):void t(function(){r.download_web_material(e.file,e.name)},300)},i.click=function(t,n){s.log("click .....",t);var o=t.status,r=v.SEND_STATUS;if(p.is_audio(t))return void e.$broadcast("event:toggle-play-audio",i.message);if(p.is_image(t))return void i.viewImage(t);if(p.is_gps_location(t))return void i.viewLocation(t);if(p.is_text(t)||p.is_txt(t))return void f.open_link(n);if(p.is_file(t)){if(t.direction===v.MESSAGE_DIR.DIR_IN)return void i.handleNormalFile(t);if(o===r.SEND_SUCCESS||o===r.SEND_SENDING)return void i.handleNormalFile(t)}else;},i.isFileMessage=function(e){return p.is_file(e)},i.isVideoMessage=function(e){return p.is_video(e)},i.isGPSLocationMessage=function(e){return p.is_gps_location(e)},i.isTextMessage=function(e){return p.is_text(e)},i.isTxtMessage=function(e){return p.is_txt(e)},i.isImageMessage=function(e){return p.is_image(e)},i.isAudioMessage=function(e){return p.is_audio(e)},i.isCardMessage=function(e){return p.is_single_card(e)||p.is_multiple_card(e)},i.viewImage=function(e){function t(){var t=f.get_message_image(e);n.hide(),i.$parent.showImageModal(t)}function o(n){e.file=n,t(),i.message.in_history||c.update_message_file(e,n)}function u(){if(a.in_mobile_app()){var t=JSON.parse(e.body);n.show(),l.has_file(t.orig,function(){o(t.orig)},function(){r.download_file(t.orig,null,function(){o(t.orig)})})}}function _(){e.file?t():u()}s.log(e.id,e.mime),_()},i.viewLocation=function(e){i.$parent.showLocationModal({position:e.body,address:e.address})},i.viewCard=function(e){},i.showAlertIcon=function(e){return!(!p.is_right(e)||e.status!==v.SEND_STATUS.SEND_ERROR)},i.showMouth=function(e){return!p.is_image(e)&&!p.is_gps_location(e)},i.viewProfile=function(e){i.message.show_profile=!0},i.viewUserinfo=function(e){"DIR_OUT"!=e.direction&&i.$parent.showUserinfoModal(e.from_uuid)},i.getUserIcon=function(e){var t=e.from_uuid,n=null;return p.is_right(e)&&(t=u.get("uuid")),n=_.get("object",t,"icon"),f.get_user_icon(n)},i.getMessageClass=function(e){var t="";return p.is_left(e)?t+=" yv-left ":p.is_right(e)&&(t+=" yv-right "),t+=a.in_mobile()?" yv-mobile ":"yv-pc"},i.shouldShowTimestamp=function(e){var t=i.$parent.timestamp.pre;return e.show_timestamp?(i.$parent.timestamp.pre=e.timestamp,!0):(e.show_timestamp=Math.abs(e.timestamp-t)>60,e.show_timestamp&&(i.$parent.timestamp.pre=e.timestamp),e.show_timestamp)},i.getTimestamp=function(e){return m.format_timestamp(e.timestamp,!0)},i.getFontStyle=function(){return{"font-size":"14px"}},i.$on("$destroy",function(){e.$broadcast("event:stop-play-audio")}),T()}return{restrict:"E",scope:{message:"=",isLast:"="},link:g,controller:"MessageCtrl",templateUrl:"templates/directives/message.html"}}]),ppmessageModule.directive("yvTextMessage",[function(){function e(e,t,n,o){var i;e.message.body_linky?t.html(e.message.body_linky):(i=o.getTrustedText(e.message.body),e.message.body_linky=i,t.html(i)),o.scrollBottom()}return{restrict:"E",replace:!0,require:"^yvMessage",scope:{message:"="},link:e,template:"<pre class='yv-chat-text'></pre>"}}]),ppmessageModule.directive("yvTxtMessage",["yvSys","yvFile","yvAPI","yvLog",function(e,t,n,o){function i(o,i,r,a){function s(e){var t=a.getTrustedText(e);o.message.txt_content=e,o.message.txt_content_linky=t,i.html(t),a.scrollDownByElement(i[0]),a.scrollBottom()}function u(e){t.read_as_text(e,function(e){s(e)})}function c(o){var r={},a=null;return o.body&&(r=angular.fromJson(o.body)),a=o.file||r.fid,e.in_mobile_app()?void t.has_file(a,function(e){u(e.toURL())},function(){return r.fid?void n.download_file(r.fid,null,function(e){u(e.toURL())}):(console.error("TXT MESSAGE MISSING MESSAGE FILE",o),void i.html("..."))}):void n.download_txt(a).success(function(e){s(e)})}c(o.message)}return{restrict:"E",replace:!0,require:"^yvMessage",scope:{message:"="},link:i,template:"<pre class='yv-chat-text'></pre>"}}]),ppmessageModule.directive("yvFileMessage",["yvMime","yvSys","yvMain","yvUploader","yvConstants","yvLocal",function(e,t,n,o,i,r){function a(o,a,s,u){function c(e){if(0==e)return"0 B";var t=1e3,n=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],o=Math.floor(Math.log(e)/Math.log(t));return(e/Math.pow(t,o)).toPrecision(3)+" "+n[o]}function l(t){var n={};t.body&&(n=angular.fromJson(t.body)),null!==n&&(t.mime=t.mime||n.mime||"",t.size=t.size||n.size||"",t.name=t.name||n.name||"",t.file=t.file||n.fid||""),o.fileName=t.name,o.fileSize=c(t.size),o.fileIcon=e.mime_icon(t.mime),u.scrollBottom()}o.getMessageStatus=function(e){switch(e.status){case i.SEND_STATUS.SEND_CHECKING:return r.translate("app.GLOBAL.CHECKING_FILE");case i.SEND_STATUS.SEND_UPLOADING:return r.translate("app.GLOBAL.UPLOADING_FILE");case i.SEND_STATUS.SEND_SENDING:return r.translate("app.GLOBAL.SENDING");case i.SEND_STATUS.SEND_CANCELED:return r.translate("app.GLOBAL.CANCELED");default:return""}},o.shouldShowProgress=function(e){var n=e.direction,o=e.status;return t.in_ios_app()?!1:n===i.MESSAGE_DIR.DIR_OUT&&o===i.SEND_STATUS.SEND_UPLOADING},o.cancelUpload=function(e){return n.update_message_status(e,i.SEND_STATUS.SEND_CANCELED),t.in_android_app()?e.ft.abort():e.fileItem.cancel(),{width:"0%"}},o.getFileProgress=function(e){var t=(e.upload_progress||0)+"%";return{width:t}},l(o.message)}return{restrict:"E",replace:!0,require:"^yvMessage",scope:{message:"="},link:a,templateUrl:"templates/directives/file-message.html"}}]),ppmessageModule.directive("yvImageMessage",["$window","yvLink","yvSys","yvFile","yvMime","yvAPI",function(e,t,n,o,i,r){function a(e,i,a,u){function c(n){var o=t.default_image_pic(),r=i.find("img")[0],a=null;return 0!==arguments&&n||(n=e.message.file||e.message.thumbnail),u.isLast&&(r.onload=function(e){u.scrollBottom()}),s.isFile(n)?s.isImage(n)?s.support?(a=new FileReader,a.onload=function(e){r.src=e.target.result||o},void a.readAsDataURL(n)):void(r.src=o):void 0:void(r.src=t.get_message_image(e.message))}function l(t){e.message.thumbnail=t,e.message.file=null,c(t)}function _(t){var i={},a=null;return t.body&&(i=angular.fromJson(t.body)),i.mime&&null===t.mime&&(t.mime=i.mime),n.in_mobile_app()?(a=e.$watch("message.file",function(e,t){e&&e!==t&&(c(e),a())}),t.file||t.thumbnail?void c():void o.has_file(i.orig,function(){t.file=i.orig,c()},function(){o.has_file(i.thum,function(){l(i.thum)},function(){r.download_file(i.thum,null,function(){l(i.thum)})})})):(t.file=t.file||i.orig,void c())}_(e.message)}var s={support:!!e.FileReader,isFile:function(t){return angular.isObject(t)&&t instanceof e.File},isImage:function(e){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(t)}};return{restrict:"E",replace:!0,require:"^yvMessage",scope:{message:"="},link:a,template:'<div class="yv-chat-image"><img></div>'}}]),ppmessageModule.directive("yvAudioMessage",["$interval","yvType","yvFile","yvSys","yvAPI","yvMain","yvConstants","yvDB",function(e,t,n,o,i,r,a,s){function u(s,u,c,l){function _(){var e=s.message.status;t.is_left(s.message)&&e!==a.RECV_STATUS.RECV_PLAY&&r.set_audio_read(s.message)}function d(){s.playCount+=1,s.playCount%=4,s.play_flag_0=!1,s.play_flag_1=!1,s.play_flag_2=!1,s.play_flag_3=!1,s["play_flag_"+s.playCount]=!0}function p(t){s.isPlaying=!1,null!==s.playInterval&&(e.cancel(s.playInterval),s.playInterval=null),s.play_flag_0=!1,s.play_flag_1=!1,s.play_flag_2=!1,s.play_flag_3=!0}function f(){s.isPlaying=!0,null===s.playInterval&&(s.playInterval=e(d,500)),_()}function E(){var e;return s.audio?void s.audio.play():(e=u.append("<audio>").find("audio")[0],e.canPlayType&&""!==e.canPlayType("audio/mp3")?(e.autoplay="autoplay",e.onplay=f,e.onended=e.onerror=e.onpause=p,e.src=i.get_audio_url(s.message.file,"mp3"),void(s.audio=e)):(console.error("This browser doesn't support playing audio"),void u.remove("audio")))}function m(){var e,t;return s.audio?(s.audio.play(),void f()):(o.in_ios_app()?e="documents://"+s.message.file:o.in_android_app()&&(e=n.get_root_dir()+s.message.file),(t=new Media(e,p,function(e){console.error(e)},function(e){console.log("===========audio play status: ",e)}))?(s.audio=t,s.audio.play(),void f()):void console.error("============New Media() error ?"));
}function v(){return o.in_mobile_app()?void m():void E()}function g(){if(s.audio){if(o.in_mobile_app())return s.audio.stop(),void s.audio.release();s.audio.pause()}}function T(e){s.message.file=e.fid,s.message.duration=e.dura,l.scrollBottom()}function S(e){n.has_file(e.fid,function(){T(e)},function(){i.download_file(e.fid,null,function(){T(e)})})}function A(e){var t={},n=null;return s.play_flag_0=!1,s.play_flag_1=!1,s.play_flag_2=!1,s.play_flag_3=!0,s.audio=null,s.isPlaying=!1,s.playInterval=null,s.playCount=-1,e.file&&e.duration?void l.scrollBottom():(e.body&&(t=angular.fromJson(e.body)),o.in_ios_app()?(n=t.m4a,S(n),void(e.mime="audio/m4a")):o.in_android_app()?(n=t.amr,S(n),void(e.mime="audio/amr")):(n=t.mp3,T(n),void(e.mime="audio/mp3")))}s.$on("event:toggle-play-audio",function(e,t){return t===s.message?s.isPlaying===!0?void g():void v():s.isPlaying===!0?void g():void 0}),s.$on("event:stop-play-audio",function(e){s.isPlaying===!0&&g()}),s.$on("$destory",function(e){s.isPlaying===!0&&g()}),s.isAudioUnread=function(e){return t.is_right(e)?!1:e.status!==a.RECV_STATUS.RECV_PLAY},s.getAudioDuration=function(e){return e.duration+"''"},s.isLeftAudioMessage=function(e){return t.is_left_audio(e)},s.isRightAudioMessage=function(e){return t.is_right_audio(e)},s.getAudioWidth=function(){var e=.5*s.message.duration+100;return{width:e+"px"}},A(s.message)}return{restrict:"E",replace:!0,require:"^yvMessage",scope:{message:"="},link:u,templateUrl:"templates/directives/audio-message.html"}}]),ppmessageModule.directive("yvDoubleClick",["$timeout",function(e){return{restrict:"A",link:function(t,n,o){var i=0;n.bind("click",function(n){i++,1===i&&e(function(){1!==i&&t.$apply(function(){t.$eval(o.yvDoubleClick)}),i=0},300)})}}}]),ppmessageModule.directive("yvClick",["$parse","yvSys",function(e,t){function n(n,o,i){function r(){o[0].onmousedown=function(e){var t=e.button;0===t&&u(n,{$event:e}),2===t&&s(n,{$event:e})},o.bind("contextmenu",function(e){n.$apply(function(){e.preventDefault()})})}function a(){$element.bind("click",function(){u(n,{$event:event})})}var s=e(i.yvRightClick),u=e(i.yvLeftClick);t.in_pc()?r():a()}return{restrict:"A",link:n}}]),ppmessageModule.directive("yvChatTool",["$timeout","$ionicGesture","yvLog","yvSys","yvNoti","yvFile","yvDelegate","yvConstants",function(e,t,n,o,i,r,a,s){function u(n,u,c){function l(e){S.status===A.TEXTING&&i.typing()}function _(){var e=u.find("iframe")[0];e&&(e.onload=function(){var t=e.contentDocument.getElementsByTagName("pre")[0];t&&(t=JSON.parse(t.innerHTML),n.sendMessage({type:y.TXT,data:{fid:t.fid}}))})}function d(){null!==T&&(t.off(T,"tap",p),T=null)}function p(t){var n=u.children()[0].offsetTop;if(!(t.gesture.touches[0].pageY>=n))return console.log("SWITCH STATUS WHEN TAPPING. STATUS: "+S.status+", touch_y: "+t.gesture.touches[0].pageY+" < tool_y: "+n),S.status===A.RECORDING_PRE||S.status===A.ADDING?(e(function(){S.status=A.NULL,a.scroll_resize()}),void d()):void 0}function f(){e(function(){null===T&&(T=t.on("tap",p,angular.element(document)))},300)}function E(){console.log("keyboardhide"),S.scroll=!0,o.in_mobile_app()&&e(function(){S.status!=A.TEXTING||cordova.plugins.Keyboard.isVisible||(S.status=A.NULL)},100)}function m(t){console.log("keyboard show",t.keyboardHeight),o.set_keyboard_height(t.keyboardHeight),e(function(){S.status=A.TEXTING,S.scroll=!0})}function v(t){if(n.chatStatus.status==t)return n.chatStatus.status=A.NULL,void a.scroll_bottom();if(n.chatStatus.status==A.TEXTING){if(o.in_mobile_browser())return void e(function(){n.chatStatus.status=t,a.scroll_bottom()},400);o.in_ios_app()&&window.cordova&&cordova.plugins.Keyboard.isVisible&&cordova.plugins.Keyboard.close()}n.chatStatus.status=t,a.scroll_bottom()}function g(){return n.textarea={text:"",origin_height:"25px",element:u.find("textarea")},S.status=s.CHAT_STATUS.NULL,S.sending=!1,n.conversation&&n.conversation.last_chat_text&&(n.textarea.text=n.conversation.last_chat_text),n.onKeyPress=l,o.in_mobile_app()?(window.addEventListener("native.keyboardhide",E,!1),void window.addEventListener("native.keyboardshow",m,!1)):o.in_mobile_browser()?void _():void 0}var T=null,S=n.chatStatus,A=s.CHAT_STATUS,y=s.MESSAGE_SUBTYPE;n.$on("event:pause-listen-keyboard",function(){window.removeEventListener("native.keyboardhide",E),window.removeEventListener("native.keyboardshow",m)}),n.$on("event:resume-listen-keyboard",function(){e(function(){window.addEventListener("native.keyboardhide",E),window.addEventListener("native.keyboardshow",m)},1e3)}),n.getPlatformClass=function(){return o.in_mobile_browser()?"yv-mobile-browser":""},n.showMicButton=function(){return S.status===A.RECORDING_PRE||S.status===A.RECORDING||S.status===A.RECORDING_CANCEL},n.showAddingButton=function(){return S.status===A.ADDING},n.getToolbarBottom=function(){var e=0;return S.status===A.NULL?(S.scroll&&(a.scroll_bottom(),S.scroll=!1),{bottom:e+"px"}):S.status===A.TEXTING?o.in_mobile_app()&&cordova.plugins.Keyboard.isVisible?(e=o.get_keyboard_height(),S.scroll&&(a.scroll_bottom(),S.scroll=!1),{bottom:e+"px"}):{bottom:e+"px"}:S.status===A.RECORDING_PRE||S.status===A.ADDING?(e=o.get_keyboard_height(),{bottom:e+"px"}):{bottom:e+"px"}},n.getAddPageStyle=function(){return{height:o.get_keyboard_height()+"px"}},n.selectToAdd=function(){f(),v(A.ADDING)},n.selectToSound=function(){f(),v(A.RECORDING_PRE)},n.onTextareaBlur=function(){if(console.log("INPUT BLURED..... sending "+S.sending+" status:"+S.status),S.status===A.TEXTING&&S.sending===!0)return n.textarea.element[0].style.height=n.textarea.origin_height,n.textarea.element[0].focus(),void(S.sending=!1);if(S.status===A.TEXTING&&S.sending===!1){var t=0;return o.in_android_app()&&(t=300),void e(function(){S.status=A.NULL},t)}},n.focusToText=function(){d(),o.in_mobile_browser()&&e(function(){S.status=A.TEXTING,a.scroll_bottom()})},n.prepareText=function(){if(!n.textarea.text)return void console.log("can't send empty message");console.log("prepare Text Message...");var e=n.textarea.text,t=o.encode_utf8(e).length;t>s.MESSAGE_MAX_TEXT_LEN?o.in_mobile_app()?r.create_random(e,!1,function(e){n.sendMessage({type:y.TXT,data:{fid:e}})}):u.find("form")[0].submit():n.sendMessage({type:y.TEXT,data:e}),n.textarea.text="",n.textarea.element[0].focus(),n.textarea.element[0].style.height=n.textarea.origin_height,S.sending=!0},n.$on("$destroy",function(){d(),n.conversation&&(n.conversation.last_chat_text=n.textarea.text),o.in_mobile_app()&&(window.removeEventListener("native.keyboardhide",E),window.removeEventListener("native.keyboardshow",m))}),g()}return u.$inject=["$scope","$element","$attrs"],{restrict:"EA",templateUrl:"templates/directives/chat-tool.html",controller:u}}]),ppmessageModule.directive("yvAddingButton",["$rootScope","yvLocal","yvSys","yvAPI","yvUser","yvFile","yvUploader","yvConstants",function(e,t,n,o,i,r,a,s){function u(u,c,l){function _(e){console.log("camera success: %s",e),r.copy(e,n.get_uuid(),function(e){u.prepareImage(e.name)})}function d(e){console.error("camera error %o",e)}function p(e,t){var n={quality:50,sourceType:e,destinationType:Camera.DestinationType.FILE_URL,encodingType:Camera.EncodingType.JPEG,targetWidth:600,targetHeight:800};t&&(n.mediaType=t),navigator.camera.getPicture(_,d,n)}function f(){n.in_mobile_app()&&p(Camera.PictureSourceType.PHOTOLIBRARY,Camera.MediaType.PICTURE)}function E(){n.in_mobile_app()&&p(Camera.PictureSourceType.CAMERA)}function m(){n.in_android_app()&&e.$broadcast("event:show-filechooser-modal")}function v(){var e,t,o,i=s.ADDING_TYPE;for(u.adding={buttons:null,buttonrows:[]},n.in_android_app()?u.adding.buttons=[{type:i.FILE,image:"img/adding_file.png",click:m},{type:i.PICTURE,image:"img/adding_picture.png",click:f},{type:i.CAMERA,image:"img/adding_camera.png",click:E}]:n.in_ios_app()?u.adding.buttons=[{type:i.PICTURE,image:"img/adding_picture.png",click:f},{type:i.CAMERA,image:"img/adding_camera.png",click:E}]:u.adding.buttons=[{type:i.FILE,image:"img/adding_file.png",click:m},{type:i.PICTURE,image:"img/adding_picture.png",click:f}],e=angular.copy(u.adding.buttons),t=Math.ceil(u.adding.buttons.length/4),o=0;t>o;o++)u.adding.buttonrows[o]=e.slice(4*o,4*(o+1));n.in_ios_app()||(u.uploader=a.get_uploader())}u.prepareImage=function(e){u.sendMessage({type:s.MESSAGE_SUBTYPE.IMAGE,data:{file:e}})},u.uploaderOption=function(e){if(n.in_mobile_app())return null;var t={url:o.get_server().upload_url,formData:[{upload_type:"file",user_uuid:i.get("uuid")}]};return t},u.clickButton=function(e){return console.log("clicking ... %s",e.type),e.click()},u.buttonName=function(e){var n=s.ADDING_TYPE;switch(e.type){case n.FILE:return t.translate("app.GLOBAL.FILE");case n.PICTURE:return t.translate("app.GLOBAL.PICTURE");case n.CAMERA:return t.translate("app.GLOBAL.CAMERA");case n.LOCATION:return t.translate("app.GLOBAL.LOCATION");case n.SLACK:return t.translate("app.GLOBAL.SLACK");case n.EVERNOTE:return t.translate("app.GLOBAL.EVERNOTE");default:console.error("unknown type: %s",e.type)}return""},u.hasUploader=function(e){var t=s.ADDING_TYPE;switch(e.type){case t.FILE:case t.PICTURE:return!n.in_mobile_app();case t.CAMERA:case t.LOCATION:case t.SLACK:case t.EVERNOTE:return!1;default:console.error("unknown type: %s",e.type)}return!1},v()}return{restrict:"E",templateUrl:"templates/directives/addingbutton.html",link:u}}]),ppmessageModule.directive("yvBigMicButton",["$timeout","$ionicGesture","yvConstants","yvFile","yvSys","yvLocal",function(e,t,n,o,i,r){function a(a,s,u){function c(){var t=null,n=null;e(function(){a.record.duration+=1}),i.in_ios_app()?(n=Math.pow(10,.01*a.record.media._levelMeter),t=null!==n?50*n+5+"px":"5px",e(function(){a.record.pressureHeight={"min-height":t}})):i.in_android_app()&&a.record.media.readAudioLevel(function(o){n=8e-5*o,t=isFinite(n)?40*n+15+"px":"15px",e(function(){console.log("---------height:",t),a.record.pressureHeight={"min-height":t}})})}function l(){var e=null,t=i.get_uuid();if(i.in_ios_app())e="documents://",t+=".m4a";else{if(!i.in_android_app())return void console.error("unsupported platform");e=o.get_root_dir(),t+=".amr"}o.create_nodata(t,function(t){a.record.media_file=t.name,a.record.media=new Media(e+t.name,function(){o.read_as_dataurl(a.record.media_file,function(e){console.log("amr file size:",e.length/1024,"kb")})},function(e){console.log("record error",e),_(!1)},function(e){console.log("record status:",e)}),a.record.media.startRecord()},null)}function _(e){if(a.record.count_interval&&(clearInterval(a.record.count_interval),a.record.count_interval=null),a.record.media&&(a.record.media.stopRecord(),a.record.media.release(),a.record.media=null),i.in_mobile_app()&&e){var t={dura:a.record.duration,url:a.record.media_file};a.prepareAudio(t)}}function d(){a.record.duration=0,a.record.media=null,a.record.media_file=null,a.record.count_interval=setInterval(c,1e3),a.record.note=r.translate("app.GLOBAL.RECORD_CANCEL"),i.in_mobile_app()&&l()}function p(t){a.chatStatus.status===n.CHAT_STATUS.RECORDING&&(t.gesture.deltaY<-30?(_(!1),a.record.note=r.translate("app.GLOBAL.RECORD_RELEASE"),e(function(){a.chatStatus.status=n.CHAT_STATUS.RECORDING_CANCEL})):a.record.note=r.translate("app.GLOBAL.RECORD_CANCEL"))}function f(t){a.chatStatus.status===n.CHAT_STATUS.RECORDING_PRE&&(e(function(){a.chatStatus.status=n.CHAT_STATUS.RECORDING}),d())}function E(t){a.chatStatus.status===n.CHAT_STATUS.RECORDING?(_(!0),console.log("save and send record: "+a.record.duration)):a.chatStatus.status===n.CHAT_STATUS.RECORDING_CANCEL&&(_(!1),console.log("cancel record: "+a.record.duration)),e(function(){a.chatStatus.status=n.CHAT_STATUS.RECORDING_PRE})}function m(){var e=angular.element(document.getElementById("record-btn")),n=t.on("drag",p,e),o=t.on("hold",f,e),i=t.on("release",E,e);a.record={media:null,media_file:null,count_interval:null,duration:0,pressureHeight:{"min-height":"40px"},note:r.translate("app.GlOBAL.RECORD_CANCEL")},a.$on("$destroy",function(){t.off(n,"drag",p),t.off(o,"hold",f),t.off(i,"release",E),n=null,o=null,i=null})}a.prepareAudio=function(e){e&&e.dura>0?a.sendMessage({type:n.MESSAGE_SUBTYPE.AUDIO,data:e}):console.log("speak too short to send.")},a.showRecordStatus=function(){var e=a.chatStatus.status,t=n.CHAT_STATUS;return e===t.RECORDING||e===t.RECORDING_CANCEL},m()}return{restrict:"E",templateUrl:"templates/directives/bigmicbutton.html",link:a}}]),ppmessageModule.directive("yvRecordStatus",["yvConstants",function(e){function t(t,n,o){t.showCancel=function(){return t.chatStatus.status===e.CHAT_STATUS.RECORDING_CANCEL},t.showPressure=function(){return t.chatStatus.status===e.CHAT_STATUS.RECORDING}}return{restrict:"E",templateUrl:"templates/directives/recordingstatus.html",link:t}}]),ppmessageModule.directive("yvDynamicHeight",[function(){function e(e,t,n){function o(e,t,n){function o(t,n){e.addEventListener(t,n,!1)}function i(t){return window.getComputedStyle(e,null)[t]}function r(){var o,r,s=0,u=e.style;e._length!==e.value.length&&(e._length=e.value.length,s=window.parseInt(i("paddingTop"))+window.parseInt(i("paddingBottom")),o=document.body.scrollTop||document.documentElement.scrollTop,e.style.height=a+"px",e.scrollHeight>a&&(t&&e.scrollHeight>t?(r=t-s,u.overflowY="auto"):(r=e.scrollHeight-s,u.overflowY="auto"),u.height=r+n+"px",o+=window.parseInt(u.height)-e.currHeight,document.body.scrollTop=o,document.documentElement.scrollTop=o,e.currHeight=window.parseInt(u.height)))}n=n||0;var a=parseFloat(i("height"));e.style.resize="none",o("input",r)}o(t[0],80)}return{restrict:"C",link:e}}]),ppmessageModule.directive("yvNewChatTool",["$timeout","yvLog","yvSys","yvAPI","yvUser","yvNoti","yvConstants","yvUploader","yvDelegate",function(e,t,n,o,i,r,a,s,u){function c(t,c,l){function _(){var e=c.find("iframe")[0];e&&(e.onload=function(){var n=e.contentDocument.getElementsByTagName("pre")[0];n&&(n=JSON.parse(n.innerHTML),t.sendMessage({type:a.MESSAGE_SUBTYPE.TXT,data:{fid:n.fid}}))})}function d(){t.textarea={text:""};var e=o.get_server();t.uploaderOptions={url:e.upload_url,formData:[{upload_type:"file",user_uuid:i.get("uuid")}]},t.uploader=s.get_uploader(),_()}t.prepareText=function(){if(""===t.textarea.text)return void console.log("can't send empty message");console.log("prepareTextMessage...");var i=t.textarea.text,r=n.encode_utf8(i).length,s=c.find("form")[0];if(r>a.MESSAGE_MAX_TEXT_LEN){if(n.in_electron()){var u=o.get_server();s.action=u.protocol+u.host+"/ppkefu/upload/"}s.submit()}else t.sendMessage({type:a.MESSAGE_SUBTYPE.TEXT,data:i});e(function(){t.textarea.text="",c.find("textarea")[0].focus()})},t.onKeyPress=function(e){var n=e.keyCode||e.which;13!=n&&10!=n||(e.preventDefault(),e.ctrlKey?t.textarea.text+="\n":t.prepareText()),r.typing()},t.onFocus=function(){t.inMobileChrome()&&u.scroll_bottom()},t.uploadFile=function(){angular.element("input#send-file").click()},t.sendLocation=function(){t.$broadcast("event:show-send-location-modal")},t.getPlatformClass=function(){var e="";return e+=n.in_mobile_browser()?" yv-mobile ":" yv-pc "},t.inMobileChrome=function(){return n.in_mobile_browser()},t.$on("event:restore-chat-text",function(e,n){n&&n.last_chat_text?t.textarea.text=n.last_chat_text:t.textarea.text=""}),t.$on("event:save-chat-text",function(e,n){n&&(n.last_chat_text=t.textarea.text)}),d()}return c.$inject=["$scope","$element","$attrs"],{restrict:"E",templateUrl:"templates/directives/new-chat-tool.html",controller:c}}]),ppmessageModule.directive("hideTabBar",["$state","$timeout","yvSys",function(e,t,n){function o(t,o){function i(){var t=e.current.name;return-1!=a.indexOf(t)}var r=document.querySelector(".tab-nav"),a=["app.conversation-list-mobile","app.contact-list-mobile","app.setting-list-mobile"];return function(e,t,o){if(n.in_mobile()){t[0].querySelector(".scroll-content");e.$on("$ionicView.beforeLeave",function(){i()||r.classList.add("slide-away")}),e.$on("$ionicView.beforeEnter",function(){r.classList.remove("slide-away")})}}}return{restrict:"A",compile:o}}]),ppmessageModule.directive("yvCropImage",["yvLink","yvConstants",function(e,t){function n(n,o,i){function r(){n.userIcon=e.current_user_avatar()}function a(e){n.$emit("event:set-dirty",!!e)}function s(){f.Jcrop(g,function(){d=this,p=this.initComponent("Thumbnailer",v),a(!0)})}function u(e){for(var t=e.split(","),n=t[0].match(/:(.*?);/)[1],o=atob(t[1]),i=o.length,r=new Uint8Array(i);i--;)r[i]=o.charCodeAt(i);return new Blob([r],{type:n})}function c(e,t){return{x:Math.round(e.x/t.x),y:Math.round(e.y/t.y),x2:Math.round(e.x2/t.x),y2:Math.round(e.y2/t.y),w:Math.round(e.w/t.x),h:Math.round(e.h/t.y)}}function l(e){if(d){var t=d.container.context,n=d.getSelection(),o=d.getContainerSize(),i={x:o[0]/t.width,y:o[1]/t.height},r=c(n,i),a=document.createElement("canvas");a.width=E,a.height=m;var s=a.getContext("2d");s.drawImage(t,r.x,r.y,r.w,r.h,0,0,E,m);var l=a.toDataURL(),_=u(l);e&&e(_)}}function _(e){d&&(d.destroy(),d=null,a(!1),r(),f.attr("src",null),e&&e())}var d=null,p=null,f=o.find("img#target-image"),E=t.AVATAR.WIDTH,m=t.AVATAR.HEIGHT,v={width:E,height:m},g={boxWidth:600,boxHeight:400,aspectRatio:1,minSize:[E,m],setSelect:[100,100,400,400]};r(),n.$on("event:restore-avatar",function(e,t){_(t)}),n.$on("event:crop-avatar",function(e,t){l(t)}),n.$watch("imgSrc",function(e,t){e&&(d&&d.destroy(),f.attr("src",e),s())})}return{restrict:"E",replace:!0,scope:{imgSrc:"=",isDirty:"="},link:n,templateUrl:"templates/directives/crop-image.html"}}]),ppmessageModule.directive("yvChangeAvatar",["$timeout","$ionicLoading","$ionicActionSheet","yvSys","yvAPI","yvMain","yvUser","yvFile","yvLocal","yvConstants",function(e,t,n,o,i,r,a,s,u,c){function l(a,l,_){function d(){t.show({duration:5e3,template:"<ion-spinner></ion-spinner>"})}function p(){t.hide()}function f(e,t){s.create_random(e,!0,function(e){t&&t(e)})}function E(e,t,n,o,i){var r=document.createElement("canvas"),a=r.getContext("2d");return r.width=c.AVATAR.WIDTH,r.height=c.AVATAR.HEIGHT,a.drawImage(e,t,n,o,i,0,0,r.width,r.height),r.toDataURL("image/jpeg",1)}function m(e,t){var n=document.createElement("img");n.onload=function(o){var i=n.width,r=n.height;return i==c.AVATAR.WIDTH&&r==c.AVATAR.HEIGHT?void f(e,t):(e=E(n,0,0,i,r),e=e.split(",")[1],void f(e,t))},n.src="data:image/jpeg;base64,"+e}function v(t){i.upload_file(t,"image/jpeg",function(n){n&&(n=JSON.parse(n),i.update_user({user_icon:n.fuuid},function(){e(function(){p(),r.update_current_user("icon",t)})}))})}function g(e){var t={quality:100,allowEdit:!0,targetWidth:c.AVATAR.WIDTH,targetHeight:c.AVATAR.HEIGHT,encodingType:Camera.EncodingType.JPEG,destinationType:Camera.DestinationType.DATA_URL,sourceType:e?Camera.PictureSourceType.PHOTOLIBRARY:Camera.PictureSourceType.CAMERA};navigator.camera.getPicture(function(e){d(),m(e,function(e){v(e)})},function(e){console.log("camera fail because: ",e)},t)}function T(t){t&&"number"==typeof t||(t=0),e(function(){A&&(A(),A=null)},t)}function S(){A=n.show({cssClass:"change-avatar-action-sheet",cancelText:u.translate("app.GLOBAL.CANCEL"),cancel:function(){T()},buttons:[{text:u.translate("app.settings.profile_photo.TAKE_PHOTO_TAG")},{text:u.translate("app.settings.profile_photo.CHOOSE_FROM_PHOTOS_TAG")}],buttonClicked:function(e){return T(100),0===e?(g(!1),!1):1===e?(g(!0),!1):!0}})}var A=null;l.on("click",function(e){o.in_mobile_app()&&S()})}return{restrict:"A",replace:!0,scope:!0,link:l}}]),ppmessageModule.directive("yvImageModal",["$timeout","$ionicModal","$ionicActionSheet","$ionicScrollDelegate","yvAlert","yvSys","yvLocal",function(e,t,n,o,i,r,a){function s(s,u,c){function l(){var t=new Image;s.disable.save=!0,t.onload=function(){function n(){e(function(){s.disable.save=!1,i.toast(a.translate("app.GLOBAL.SAVE_PHOTO_SUCCESS"))})}function o(){e(function(){s.disable.save=!1,i.toast(a.translate("app.GLOBAL.SAVE_PHOTO_FAILURE"))})}var r=document.createElement("canvas");r.height=t.height,r.width=t.width,r.getContext("2d").drawImage(t,0,0),window.canvas2ImagePlugin.saveImageDataToLibrary(n,o,r)},t.src=s.imgSrc}function _(){s.hide={bars:!1},s.disable={save:!1},t.fromTemplateUrl("image-modal.html",{scope:s,animation:"slide-in-up"}).then(function(e){s.imageModal=e})}s.showModal=function(){o.$getByHandle("image-scroll").zoomTo(1),s.imageModal.show()},s.closeModal=function(){s.hide.bars=!1,s.imageModal.hide()},s.onHold=function(){if(r.in_mobile_app())var e=n.show({cancelText:a.translate("app.GLOBAL.CANCEL"),cancel:function(){e()},buttons:[{text:a.translate("app.GLOBAL.SAVE")}],buttonClicked:function(e){return 0===e&&l(),!0}})},s.saveImage=function(){l()},s.showSaveButton=function(){return!!r.in_mobile_app()},s.toggleHide=function(){s.hide.bars=!s.hide.bars},s.$on("event:show-image-modal",function(e,t){(r.in_browser()||r.in_electron())&&r.is_image_file(t)?r.read_image_file(t,function(e){s.imgSrc=e}):s.imgSrc=t,s.showModal()}),s.$on("$destroy",function(){s.imageModal.remove()}),_()}return{restrict:"E",scope:!0,templateUrl:"templates/directives/imagemodal.html",link:s}}]),ppmessageModule.directive("yvTextModal",["$ionicModal","yvSys","yvLink",function(e,t,n){function o(o,i,r){e.fromTemplateUrl("text-modal.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.textModal=e,o.inMobile=t.in_mobile()}),o.showModal=function(){o.textModal.show()},o.closeModal=function(e){o.textModal.hide()},o.clickContent=function(e){n.open_link(e)},o.$on("event:show-text-modal",function(e,t){o.content=t,o.showModal()}),o.$on("$destroy",function(){o.textModal.remove()})}return{restrict:"E",scope:!0,templateUrl:"templates/directives/textmodal.html",link:o}}]),ppmessageModule.directive("yvFilechooserModal",["$ionicModal","$timeout","FileChooser","yvUploader",function(e,t,n,o){function i(i,r,a){function s(e,n,o){t(function(){console.log("filechooser",e),i.files=e,i.showProgress=!1,i.title=o?"storage/":"/storage"+n.fullPath})}e.fromTemplateUrl("filechooser-modal.html",{scope:i,animation:"slide-in-up"}).then(function(e){i.modal=e});var u=[],c=new n;i.files=[],i.showProgress=!1,c.onBeforeFileClick=function(e,n){t(function(){i.showProgress=!0})},c.onDirectoryFilesLoadComplected=function(e){u.push(e),s(e.files,e.folder,e.root)},c.fillDirectorys(""),i.onEntryClicked=function(e){c&&(e.isDirectory?c.fillDirectorys(e.fullPath.slice(1,e.fullPath.length-1)):e.url&&(c.getFile(e.fullPath,function(e){o.send_file(e)},function(e){console.log(e)}),i.closeModal()))},i.closeModal=function(){i.modal.hide()},i.$on("event:show-filechooser-modal",function(){i.modal.show()}),i.$on("$destroy",function(){i.modal.remove()})}return{restrict:"E",templateUrl:"templates/directives/filechoosermodal.html",link:i}}]),ppmessageModule.directive("yvSearchModal",["$ionicModal","yvBase","yvUser","yvConstants",function(e,t,n,o){function i(i,r,a){function s(){i.search={searchKey:"",contacts:[],conversations:[]},e.fromTemplateUrl("search-modal.html",{scope:i,animation:"slide-in-up"}).then(function(e){i.modal=e})}i.showModal=function(){i.modal.show()},i.closeModal=function(){i.modal.hide()},i.$on("event:show-search-modal",function(){i.showModal()}),i.$on("$destroy",function(){i.modal.remove()}),i.startSearch=function(){var e=n.get("uuid"),r=new RegExp(i.search.searchKey);i.search.conversations.length=0,i.search.contacts.length=0,i.search.searchKey&&(angular.forEach(t.get_list("conversation"),function(e){if(r.test(e.name))return void i.search.conversations.push(e);if(e.type==o.CONVERSATION_TYPE.P2S){var n=t.get("object",e.user_uuid,"fullname");r.test(n)&&i.search.conversations.push(e)}}),angular.forEach(t.get_list("contact"),function(t){r.test(t.fullname)&&t.uuid!==e&&i.search.contacts.push(t)}))},i.clearSearchKey=function(){i.search.searchKey="",i.startSearch()},i.clickItem=function(){i.closeModal()},s()}return{restrict:"E",scope:!0,link:i,templateUrl:"templates/directives/search-modal.html"}}]),ppmessageModule.directive("yvConversationMember",["$timeout","$rootScope","yvLog","yvAPI","yvUser","yvBase","yvLink",function(e,t,n,o,i,r,a){function s(n,s,u){function c(t){var o=angular.element(t.target);o.hasClass("toggle-conversation-member")||l(o,".conversation-member")||e(function(){n.toggleShowMember()})}function l(e,t){return e.parents(t).length||e.closest(t).length}n.members=[],n.removeMode=!1,document.addEventListener("click",c),document.addEventListener("dragstart",c),o.get_conversation_user_list(n.conversation.uuid,function(e){angular.forEach(e.list,function(e){n.members.push(e.uuid)})}),n.$on("$destroy",function(){document.removeEventListener("click",c),document.removeEventListener("dragstart",c)}),n.toggleRemoveMode=function(){n.removeMode=!n.removeMode},n.isMe=function(e){return e==i.get("uuid")},n.removeMember=function(e){var t={action:"REMOVE",member_list:[e],conversation_uuid:n.conversation.uuid};o.update_conversation_member(t,function(t){var o=n.members.indexOf(e);n.members.splice(o,1)})},n.addMember=function(){n.toggleShowMember(),t.$broadcast("event:add-member-modal",n.conversation,n.members)},n.getAvatar=function(e){var t=r.get("object",e,"icon");return a.get_user_icon(t)},n.getFullname=function(e){return r.get("object",e,"fullname")}}return{restrict:"E",link:s,templateUrl:"templates/directives/conversation-member.html"}}]),ppmessageModule.directive("yvAddMemberModal",["$rootScope","$ionicModal","yvLog","yvAPI","yvLink","yvBase",function(e,t,n,o,i,r){function a(n,o,a){var s=null;n.conversation={},n.ignore_list=[],n.addByGroup=!1,n.addByContact=!1,t.fromTemplateUrl("add-member-modal.html",{scope:n,animation:"slide-in-up"}).then(function(e){s=e}),n.$on("event:add-member-modal",function(e,t,o){n.conversation=t,n.ignore_list=o,n.showModal()}),n.$on("$destroy",function(){s&&s.remove()}),n.$on("modal.shown",function(){e.$broadcast("event:pause-listen-keyboard")}),n.$on("modal.hidden",function(){e.$broadcast("event:resume-listen-keyboard")}),n.showModal=function(){n.addByGroup=!1,n.addByContact=!0,s&&s.show()},n.closeModal=function(){n.addByGroup=!1,n.addByContact=!1,s&&s.hide()},n.toggleAddMode=function(e){return"contact"==e?(n.addByGroup=!1,void(n.addByContact=!0)):"group"==e?(n.addByGroup=!0,void(n.addByContact=!1)):void 0},n.getSubtitleClass=function(e){return"contact"==e?1==n.addByContact?"button-balanced":"button-stable":"group"==e?1==n.addByGroup?"button-balanced":"button-stable":void 0},n.getAvatar=function(e){var t=r.get("object",e.uuid,"icon");return i.get_user_icon(t)},n.getFullname=function(e){return r.get("object",e.uuid,"fullname")},n.getSelectedNumber=function(e){var t=0;return angular.forEach(e,function(e){e.is_selected&&t++}),t},n.disableSave=function(e){return!n.getSelectedNumber(e)},n.getScrollMaxHeight=function(e){var t=angular.element(".modal-content").height(),n=angular.element(e).height(),o=angular.element(".save-button").height(),i=t-n-o;return i?{"max-height":i+"px"}:void 0}}return{restrict:"E",replace:!0,scope:!0,link:a,templateUrl:"templates/directives/add-member-modal.html"}}]),ppmessageModule.directive("yvAddMemberByContact",["yvLog","yvAPI","yvLink","yvBase",function(e,t,n,o){function i(e,n,i){function r(){if(angular.copy(o.get_list("contact"),a),e.ignore_list)for(var t=a.length,n=t-1;n>=0;n--)-1!==e.ignore_list.indexOf(a[n].uuid)&&a.splice(n,1)}var a=[];r(),e.search={search_key:""},e.all_contacts=a,e.display_contacts=a,e.startSearch=function(){var t=new RegExp(e.search.search_key);return t?(e.display_contacts=[],void angular.forEach(a,function(n,o){t.test(n.fullname)&&e.display_contacts.push(n)})):void(e.display_contacts=a)},e.save=function(){var n=[];angular.forEach(a,function(e){e.is_selected&&n.push(e.uuid)});var o={action:"ADD",member_list:n,conversation_uuid:e.conversation.uuid};t.update_conversation_member(o,function(t){e.closeModal()})}}return{restrict:"E",replace:!0,link:i,templateUrl:"templates/directives/add-member-by-contact.html"}}]),ppmessageModule.directive("yvAddMemberByGroup",["yvDB","yvLog","yvAPI","yvLink","yvBase",function(e,t,n,o,i){function r(t,i,r){var a=null,s=t.conversation.group_uuid;t.users=[],t.groups=[],n.get_app_org_group_list(null,function(e){t.groups=e.list}),t.isCurrentGroup=function(e){return e.uuid==s},t.isSelectedGroup=function(e){return e.uuid==a},t.getImageClass=function(e){return e.uuid==a?"selected":""},t.getGroupIcon=function(e){return o.get_user_icon(e.group_icon)},t.getGroupName=function(e){return e.group_name},t.save=function(){var o=[];angular.forEach(t.users,function(e){e.is_selected&&o.push(e.uuid)});var i={action:"ADD",member_list:o,group_uuid:a,conversation_uuid:t.conversation.uuid};n.update_conversation_member(i,function(n){t.conversation.group_uuid=a,e.update_conversation_group(t.conversation),t.closeModal()})},t.setGroup=function(e){if(!t.isCurrentGroup(e)){var o={group_uuid:e.uuid,conversation_uuid:t.conversation.uuid};n.get_selected_group_user(o,function(n){t.users.length=0,a=e.uuid,angular.forEach(n.list,function(e){t.users.push({uuid:e,is_selected:!0})})})}}}return{restrict:"E",replace:!0,link:r,templateUrl:"templates/directives/add-member-by-group.html"}}]),ppmessageModule.directive("yvSidemenuHeader",["$rootScope","yvSys","yvAPI","yvLink","yvUser","yvBase","yvLogin","yvLogout","yvLocal","yvConstants",function(e,t,n,o,i,r,a,s,u,c){function l(t,a,l){function _(e){var n,o=null,i=t.status.options.length;for(n=0;i>n;n++)if(o=t.status.options[n],o.status===e){t.status.selected=o;break}}t.page={show_popover:!1},t.search={searchKey:"",conversations:[],contacts:[]},t.status={options:[{"class":"bg-ready",status:c.USER_STATUS.READY,origin:"app.GLOBAL.READY",content:u.translate("app.GLOBAL.READY")},{"class":"bg-busy",status:c.USER_STATUS.BUSY,origin:"app.GLOBAL.BUSY",content:u.translate("app.GLOBAL.BUSY")},{"class":"bg-rest",status:c.USER_STATUS.REST,origin:"app.GLOBAL.REST",content:u.translate("app.GLOBAL.REST")}]},_(i.get("status")),e.$on("$translateChangeSuccess",function(e){angular.forEach(t.status.options,function(e){e.content=u.translate(e.origin)})}),t.getUserIcon=function(){var e=i.get("icon");return o.get_user_icon(e)},t.getUserFullname=function(){return i.get("fullname")},t.getCurrentAppName=function(){return i.get("app").app_name},t.showPopover=function(){t.page.show_popover=!t.page_show_popover},t.logout=function(){s.logout()},t.clickItem=function(){t.clearSearchKey()},t.onStatusChange=function(){function e(){_(o)}console.log(t.status.selected);var o=i.get("status"),r=t.status.selected.status;n.set_user_status(r,function(e){i.set("status",r),console.log(e)},e,e)},t.selectStatus=function(){var e=angular.element("#user-status");if(document.createEvent){var t=document.createEvent("MouseEvents");t.initMouseEvent("mousedown",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e[0].dispatchEvent(t)}else element.fireEvent&&e[0].fireEvent("onmousedown")},t.startSearch=function(){var e=i.get("uuid"),n=new RegExp(t.search.searchKey);t.search.conversations.length=0,t.search.contacts.length=0,t.search.searchKey&&(angular.forEach(r.get_list("conversation"),function(e){if(n.test(e.name))return void t.search.conversations.push(e);if(e.type==c.CONVERSATION_TYPE.P2S){var o=r.get("object",e.user_uuid,"fullname");n.test(o)&&t.search.conversations.push(e)}}),angular.forEach(r.get_list("contact"),function(o){n.test(o.fullname)&&o.uuid!==e&&t.search.contacts.push(o)}))},t.clearSearchKey=function(){t.search.searchKey=""}}return{restrict:"E",replace:!0,scope:!0,link:l,templateUrl:"templates/directives/sidemenu-header.html"}}]),ppmessageModule.directive("yvConversation",["$state","$timeout","$rootScope","yvSys","yvAPI","yvLog","yvMain","yvLink","yvLocal","yvBase","yvMessage","yvDelegate","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l,_,d){function p(r,p,f){function E(){r.isDesktop=o.in_pc_browser()||o.in_electron()}var m=_.get_list_delegate("conversation-list");r.isOnline=function(e){return a.is_conversation_online(e)},r.getIcon=function(e){var t=null;return t=e.type===d.CONVERSATION_TYPE.P2S?c.get("object",e.user_uuid,"icon"):e.icon,s.get_user_icon(t)},r.getConversationName=function(e){return e.type===d.CONVERSATION_TYPE.P2S?c.get("object",e.user_uuid,"fullname"):e.name},r.getTimestamp=function(e){var t=e.latest_message;return t?u.format_timestamp(t.timestamp)||"":""},r.getTitle=function(e){
var t=e.latest_message;return t?l.localize_title(t.title)||"":""},r.getUnread=function(e){var t=e.unread;return t>99?"99+":t},r.deleteConversation=function(e,t){t.stopPropagation(),m.closeOptionButtons(),e===c.active("conversation")&&(c.active("conversation",null),o.in_pc()&&n.$broadcast("event:open-conversation",null)),a.delete_conversation(e),i.close_conversation(e.uuid)},r.showContextMenu=function(e){console.log("---------right click",e),console.log("broadcast the event"),r.$parent.$parent.$broadcast("event:open-menu",e,r.conversation)},r.markAsRead=function(e,t){t.stopPropagation(),m.closeOptionButtons(),a.unread_zero(e)},r.openConversation=function(i){var r={conv_uuid:i.uuid,conv_type:i.type,user_uuid:i.user_uuid};console.log(">>>>> Click conversaiton: ",i),m.closeOptionButtons(),o.in_pc()&&e.is("app.conversation-list")&&i.active||(c.active("conversation",i),o.in_pc()?e.is("app.conversation-list")?n.$broadcast("event:open-conversation",r):e.go("app.conversation-list",r):(e.go("app.conversation-list-mobile"),t(function(){e.go("app.conversation-mobile",r)})))},E()}return{restirct:"E",replace:!0,scope:{conversation:"="},link:p,templateUrl:"templates/directives/conversation.html"}}]),ppmessageModule.directive("yvContact",["$state","$timeout","$rootScope","yvSys","yvBase","yvLink",function(e,t,n,o,i,r){function a(a,s,u){a.getIcon=function(e){var t=i.get("object",e.uuid,"icon");return r.get_user_icon(t)},a.getFullname=function(e){return e.fullname},a.getContactClass=function(e){return o.in_mobile()?"":e===i.active("contact")?"active":""},a.viewDetail=function(r){r===i.active("contact")&&e.is("app.contact-list")&&o.in_pc()||(i.active("contact",r),o.in_pc()?e.is("app.contact-list")?n.$broadcast("event:view-contact",r.uuid):e.go("app.contact-list",{contact_uuid:r.uuid}):(e.go("app.contact-list-mobile"),t(function(){e.go("app.contact-mobile",{contact_uuid:r.uuid})})))}}return{restrict:"E",replace:!0,scope:{contact:"="},link:a,templateUrl:"templates/directives/contact.html"}}]),ppmessageModule.directive("yvRightclickMenu",["$timeout","yvSys",function(e,t){function n(e,t,n){function o(t){function n(t){e.click_count+=1,1!==e.click_count&&(t.target.hasAttribute("yv-menu")||(e.isShow=!1,document.removeEventListener("click",clickEventLister)))}var o=t||window.event;o.preventDefault?o.preventDefault():o.returnValue=!1;var i=o.pageX||o.clientX+scrollX,r=o.pageY||o.clientY+scrollY;e.isShow=!0,e.startX=i,e.startY=r,e.menuStyle={top:startX,right:startY},document.addEventListener("click",n)}function i(){t.on("contextmenu",o)}i()}return{restrict:"EA",scope:{conversation:"="},link:n,templateUrl:"templates/directives/rightclickmenu.html"}}]),ppmessageModule.directive("yvContextmenu",["$timeout","$document","yvSys","yvAPI","yvDB","yvBase",function(e,t,n,o,i,r){function a(e,t,a){function s(t,n){e.conversation=null,e.conversation=n,e.unread=!!e.conversation.unread;var o=t||window.event,i=o.pageX||o.clientX+scrollX;i-=jQuery("ion-content:last").offset().left;var r=o.pageY||o.clientY+scrollY;r-=jQuery("ion-content:last").offset().top,e.isShow=!0,e.menuStyle={left:i,top:r}}function u(){e.isShow=!1}e.deleteConversation=function(t){$rootScope.$broadcast("event:count"),e.conversation===r.active_conversation()&&(r.active_conversation(null),(n.in_pc_browser()||n.in_electron())&&$rootScope.$broadcast("event:open-conversation",null)),t.stopPropagation(),o.close_conversation(e.conversation.uuid),i.delete_conversation(e.conversation.uuid),e.isShow=!1},e.markAsRead=function(t){var n={unread:0,uuid:_conv_uuid};r.update_conversation(n),$rootScope.$broadcast("event:count"),t.stopPropagation(),i.unread_zero(e.conversation.uuid),e.isShow=!1},e.$on("event:open-menu",function(t,n,o){e.isShow=!1,s(n,o)}),u()}return{restrict:"EA",scope:{},link:a,templateUrl:"templates/directives/contextmenu.html"}}]),ppmessageModule.directive("yvUserinfoModal",["$ionicModal","$timeout","yvSys","yvLink","yvAPI","yvBase",function(e,t,n,o,i,r){function a(n,o,a){e.fromTemplateUrl("userinfo-modal.html",{scope:n,animation:"slide-in-up"}).then(function(e){n.userinfoModal=e}),n.showModal=function(){t(function(){n.userinfo={nickname:"",tel:"",qq:"",remarks:""},i.get_user_info(n.user_uuid,function(e){console.log(e),n.userinfo={nickname:e.user_fullname?e.user_fullname:"",tel:e.user_mobile?e.user_mobile:"",qq:e.user_qq?e.user_qq:"",remarks:e.user_defined?e.user_defined:""}},null,null)}),n.userinfoModal.show()},n.closeModal=function(){n.userinfoModal.hide(),n.$parent.$broadcast("close_userinfo")},n.save=function(){var e={user_uuid:n.user_uuid,user_fullname:n.userinfo.nickname,user_mobile:n.userinfo.tel,user_qq:n.userinfo.qq,user_defined:n.userinfo.remarks};i.update_user(e,null,null,null),n.closeModal()},n.$on("event:show-userinfo-modal",function(e,t){n.user_uuid=t,null===r.get("contact",t)&&n.showModal()}),n.$on("$destroy",function(){n.userinfoModal.remove()})}return{restrict:"E",templateUrl:"templates/directives/userinfo-modal.html",link:a}}]),ppmessageModule.controller("NoAppCtrl",["$scope","yvSys","yvConstants",function(e,t,n){e.showServerButton=function(){return ppmessage.developer_mode&&t.has_db()}}]),ppmessageModule.controller("MainWithLogoCtrl",["$scope","yvSys","yvNav","yvLog","yvMain","yvUser","yvFile","yvPush","yvLogin","yvUpdater","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l){function _(e){n.clear(function(){return e?e.is_online&&t.has_db()?u.login_with_session(e):void n.login_with_user(e):n.login_no_user()})}function d(){i.init_yvdb(function(e){return c.check_update(),t.in_ios_app()?void s.register_push(null,null,function(){_(e)}):t.in_android_app()&&r.get("android_notification_type")===l.NOTIFICATION_TYPE.GCM?void s.register_push(function(){o.green("gcm push init successfully"),i.update_android_notification_type(l.NOTIFICATION_TYPE.GCM)},function(){o.yellow("gcm push failed, downgrade to mqtt "),i.update_android_notification_type(l.NOTIFICATION_TYPE.MQTT)},function(){_(e)}):void _(e)})}function p(){t.in_mobile_app()&&a.init(),d()}p()}]),ppmessageModule.controller("AutoLoginCtrl",["$scope","$state","$stateParams","$ionicHistory","yvNav","yvMain","yvLogin","yvUtil",function(e,t,n,o,i,r,a,s){function u(e){console.log("login error:",e),i.disable_next(),t.go("noapp.login-error")}function c(){if(e.user={request_body:n.request_body},!e.user.request_body||0==e.user.request_body.length)return void u();var t=s.base64_decode(e.user.request_body);console.log("auto login with %o",t),_body=JSON.parse(t),console.log("auto login with %o",_body),e.user.user_email=_body.user_email,e.user.user_password=_body.user_password;var i=a.current_session();return i&&i.user_email==_body.user_email?void o.goBack():void r.init_yvdb(function(t){a.login(e.user)})}e.$on("event:login-error",function(e,t){console.error(t)}),c()}]),ppmessageModule.controller("LoginErrorCtrl",["$scope","$timeout","yvNav",function(e,t,n){e.remainTime=5;var o=setInterval(function(){e.remainTime>0?t(function(){e.remainTime-=1}):e.goToPortal()},1e3);e.goToPortal=function(){o&&clearInterval(o),n.exit_app()}}]),ppmessageModule.controller("LoginNoUserCtrl",["$scope","$state","$timeout","yvNav","yvMain","yvLogin","yvConstants",function(e,t,n,o,i,r,a){e.statusOptions=[{origin:"app.GLOBAL.READY",status:a.USER_STATUS.READY},{origin:"app.GLOBAL.BUSY",status:a.USER_STATUS.BUSY},{origin:"app.GLOBAL.REST",status:a.USER_STATUS.REST}],e.user={user_email:"",user_password:"",user_status:a.USER_STATUS.READY},e.$on("$ionicView.enter",function(){o.clear(),i.set_server()}),e.disableLogin=function(){return!e.user.user_email||!e.user.user_password},e.deviceUserLogin=function(){var t={user_email:e.user.user_email,user_status:e.user.user_status,user_password:hex_sha1(e.user.user_password)};r.login(t)}}]),ppmessageModule.controller("LoginWithUserCtrl",["$scope","$state","$timeout","$stateParams","yvNav","yvMain","yvLink","yvLogin","yvConstants",function(e,t,n,o,i,r,a,s,u){e.statusOptions=[{origin:"app.GLOBAL.READY",status:u.USER_STATUS.READY},{origin:"app.GLOBAL.BUSY",status:u.USER_STATUS.BUSY},{origin:"app.GLOBAL.REST",status:u.USER_STATUS.REST}],e.user={user_password:"",icon:o.icon,user_email:o.email||"",fullname:o.fullname||"",user_status:u.USER_STATUS.READY},e.user.user_email||i.login_no_user(),e.$on("$ionicView.enter",function(){i.clear(),r.set_server()}),e.nouser=function(){i.login_no_user()},e.disableLogin=function(){return!e.user.user_password},e.getDeviceUserIcon=function(){return a.get_user_icon(e.user.icon)},e.deviceUserLogin=function(){var t={user_email:e.user.user_email,user_status:e.user.user_status,user_password:hex_sha1(e.user.user_password)};s.login(t)}}]),ppmessageModule.controller("AddServerCtrl",["$scope","$ionicHistory","yvDB",function(e,t,n){e.server={select:!0,protocol:"",host:"",port:"",name:""},e.shouldDisableAdd=function(){return"https://"!=e.server.protocol&&"http://"!=e.server.protocol?!0:e.server.host?!e.server.name:!0},e.add=function(){n.add_server(e.server,function(){t.goBack()})}}]),ppmessageModule.controller("SwitchServerCtrl",["$scope","$timeout","$state","yvDB",function(e,t,n,o){function i(){o.query_servers(function(n){t(function(){e.serverList=n})})}e.serverList=[],i(),e.getServerPath=function(e){var t=e.protocol+e.host;return e.port&&(t=t+":"+e.port),t},e.select=function(e){o.select_server(e,function(){i()})},e.deleteServer=function(e,t){o.delete_server(e,function(){i()}),t.stopPropagation()}}]),ppmessageModule.controller("AppCtrl",["$scope","yvDB","yvLog","yvSys","yvNav","yvBase","yvLogin",function(e,t,n,o,i,r,a){i.clear(),o.in_pc_browser()&&o.request_desktop_notification(),e.$on("event:reload",function(e,t){i.clear()}),e.$on("$ionicView.unloaded",function(){console.log("appctrl onloaded....")}),e.isInAndroidApp=function(){return o.in_android_app()},e.isInMobileNative=function(){return!!o.in_mobile_app()},e.isInMobile=function(){return!!o.in_mobile()},e.showNavButton=function(){return!(window.innerWidth>=768)},e.getUnread=function(){var e=0,t=r.get_list("conversation");return angular.forEach(t,function(t){e+=t.unread}),e>99?"99+":e},e.openSearchModal=function(){e.$broadcast("event:show-search-modal")}}]),ppmessageModule.controller("ConversationListCtrl",["$scope","$timeout","$rootScope","$stateParams","yvLog","yvSys","yvAPI","yvBase","yvMain","yvAlert","yvLogin","yvDelegate","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l,_,d){var p=_.get_scroll_delegate("conversation-list-scroll");e.showS2S=!0,e.showP2S=!0,e.showOnline=!0,e.showOffline=!0,e.showFilterBar=!1,e.eableInfiniteScroll=!0,e.canShowNoConversation=!0,e.conversations=s.get_scope("conversation"),e.$on("$ionicView.beforeEnter",function(e,i){l.check_session(),r.in_pc()&&o.conv_uuid&&t(function(){n.$broadcast("event:open-conversation",o)})}),e.showConversation=function(t){if(!t.show)return!1;var n=!1,o=!1;switch(t.type){case d.CONVERSATION_TYPE.S2S:e.showOnline&&(o=!0),e.showS2S&&(n=!0);break;case d.CONVERSATION_TYPE.P2S:var i=u.is_conversation_online(t);(e.showOnline&&i||e.showOffline&&!i)&&(o=!0),e.showP2S&&(n=!0)}return n&&o},e.loadMoreConversation=function(){function n(){e.eableInfiniteScroll=!1,e.$broadcast("scroll.infiniteScrollComplete"),c.tip("app.GLOBAL.CANT_GET_MORE_CONVERSATIONS"),t(function(){e.eableInfiniteScroll=!0},5e3)}var o=e.conversations.page+1,i={page_offset:o,page_size:r.page_size()};a.get_conversation_page(i,function(t){t.list.length<r.page_size()&&(e.eableInfiniteScroll=!1),u.add_conversation_from_api_reserve(t.list),e.$broadcast("scroll.infiniteScrollComplete"),e.conversations.page=o},n,n)},e.refreshConversations=function(){e.canShowNoConversation=!1;var t=u.update_conversations_from_server();t.then(function(){_.scroll_resize("conversation-list-scroll"),r.in_pc()&&n.$broadcast("event:open-conversation",null)},function(){c.tip("app.GLOBAL.CANT_REFRESH_CONVERSATIONS")}),t["finally"](function(){e.eableInfiniteScroll=!0,e.canShowNoConversation=!0,e.$broadcast("scroll.refreshComplete")})},e.onScroll=function(){var n=r.in_mobile()?0:-5,o=5,i=p.getScrollPosition();return i.top<=n?void(0==e.showFilterBar&&t(function(){e.showFilterBar=!0,p.resize()})):void(i.top>=o&&1==e.showFilterBar&&t(function(){e.showFilterBar=!1,p.resize()}))},e.toggleShowFilterBar=function(){t(function(){e.showFilterBar=!e.showFilterBar,p.resize()})}}]),ppmessageModule.controller("ConversationCtrl",["$scope","$timeout","$rootScope","$stateParams","$ionicLoading","yvAPI","yvSys","yvLog","yvMain","yvNoti","yvBase","yvAlert","yvLocal","yvMessage","yvDelegate","yvConstants",function(e,t,n,o,i,r,a,s,u,c,l,_,d,p,f,E){function m(){t(function(){f.scroll_bottom("conversation-scroll",!0)}),i.hide()}function v(){e.title="",e.messages=[],e.valid=!1,e.api_uuid=null,e.titleClass="",e.conversation={},e.showMember=!1,e.timestamp={pre:0},e.max_display_count=O}function g(){e.typingAnimateIndex=0,e.typingAnimate=[d.translate("app.GLOBAL.TYPING")+".",d.translate("app.GLOBAL.TYPING")+"..",d.translate("app.GLOBAL.TYPING")+"..."],e.typingInterval=setInterval(function(){if(e.typingValue>0){e.typingValue--;var t=e.typingAnimateIndex%3;e.$apply(function(){e.typingTitle=e.typingName+e.typingAnimate[t]}),0==e.typingValue?(e.$apply(function(){e.typingTitle=null}),e.typingName=null,e.typingAnimateIndex=0):e.typingAnimateIndex++}},1e3)}function T(t){e.valid=!0,e.timestamp.pre=0,e.showMember=!1,e.titleClass="arrow-down",e.api_uuid=a.get_uuid(),e.conversation=t,e.max_display_count=O,e.messages=t.messages,t.type===E.CONVERSATION_TYPE.S2S?e.title=t.name:t.type===E.CONVERSATION_TYPE.P2S&&(e.title=l.get("object",t.user_uuid,"fullname")),A(),u.unread_zero(t),c.watch_typing(t.uuid),e.$broadcast("event:restore-chat-text",t)}function S(e){if(!e||!e.conv_uuid)return v(),void m();var t=l.get("conversation",e.conv_uuid);return null===t?(v(),void m()):void T(t)}function A(){function t(){u.load_conversation_messages(o,function(t){n==e.api_uuid&&m()})}var n=e.api_uuid,o=e.conversation,i={page_offset:0,page_size:O,conversation_uuid:o.uuid};return o.messages.length?void m():void r.get_page_history_message(i,function(t){angular.forEach(t.list,function(e){o.messages.unshift(p.history_message(e))}),o._refresh(),n==e.api_uuid&&m()},t,t)}function y(){function t(){n==e.api_uuid&&_.tip("app.GLOBAL.CANT_GET_MORE_HISTORY_MESSAGES")}var n=e.api_uuid,o=e.conversation,i={page_size:O,conversation_uuid:o.uuid};0==o.messages.length?i.page_offset=0:i.max_uuid=o.messages[0].task_uuid,r.get_page_history_message(i,function(t){var i=0;angular.forEach(t.list,function(e){return e=p.history_message(e),o.has_message(e)?void(i+=1):(e.disableScroll=!0,void o.messages.unshift(e))}),o._refresh(),n==e.api_uuid&&(e.$broadcast("scroll.refreshComplete"),e.max_display_count+=t.list.length-i,t.list.length==i&&_.tip("app.GLOBAL.NO_MORE_HISTORY_MESSAGES"))},t,t)}var O=12;e.inMobile=a.in_mobile(),e.chatStatus={status:E.CHAT_STATUS.NULL},v(),g(),e.$on("$ionicView.beforeEnter",function(){a.in_mobile()&&i.show({duration:5e3})}),e.$on("$ionicView.enter",function(){a.in_mobile()&&S(o)}),e.$on("$destroy",function(){clearInterval(e.typingInterval),l.active("conversation",null),e.$broadcast("event:save-chat-text",e.conversation),e.conversation&&e.conversation.uuid&&c.unwatch_typing(e.conversation.uuid)}),e.$on("event:open-conversation",function(t,n){e.conversation&&e.conversation.uuid&&c.unwatch_typing(e.conversation.uuid),e.$broadcast("event:save-chat-text",e.conversation),i.show({duration:5e3}),S(n)}),e.$on("event:typing",function(n,o){console.log("receiving typing message in conversation."),t(function(){var t=l.get("object",o.user_uuid,"fullname");e.typingName=t,0==e.typingAnimateIndex&&(e.typingTitle=t+d.translate("app.GLOBAL.TYPING")),e.typingValue=3})}),e.showMessage=function(t){var n=e.messages.length-e.messages.indexOf(t);return n<=e.max_display_count},e.getContentBottomStyle=function(){var t=e.chatStatus.status,n=E.CHAT_STATUS,o=49;return e.conversation&&e.valid?a.in_pc()?{bottom:"180px"}:t===n.NULL?{bottom:o+"px"}:t===n.TEXTING?(a.in_mobile_app()&&cordova.plugins.Keyboard.isVisible&&(o+=a.get_keyboard_height()),{bottom:o+"px"}):t===n.RECORDING_PRE||t===n.RECORDING||t===n.RECORDING_CANCEL||t===n.ADDING?(o+=a.get_keyboard_height(),{bottom:o+"px"}):{bottom:o+"px"}:{bottom:"0px"}},e.deleteMessage=function(t){u.delete_message(e.conversation,t)},e.doRefresh=function(){e.timestamp.pre=0;var t=e.messages.length-e.max_display_count;if(0>=t)return void y();var n=O>t?t:O;e.max_display_count+=n,e.$broadcast("scroll.refreshComplete")},e.sendMessage=function(t){u.send_message(e.conversation,t)},e.showImageModal=function(e){n.$broadcast("event:show-image-modal",e)},e.showTextModal=function(e){n.$broadcast("event:show-text-modal",e)},e.toggleShowMember=function(){e.showMember=!e.showMember,e.titleClass=e.showMember?"arrow-up":"arrow-down"}}]),ppmessageModule.controller("MessageCtrl",["$scope","$filter","$sce","yvDelegate",function(e,t,n,o){function i(e){var t=0;return e.getBoundingClientRect&&(t=e.getBoundingClientRect().height),t}var r=this;r.isLast=e.isLast,r.scrollBottom=function(){e.isLast!==!0||e.message.disableScroll||o.scroll_bottom()},r.scrollDownByElement=function(t){var n=i(t);e.isLast===!0||e.message.disableScroll||o.scroll_down(n)},r.getTrustedText=function(e){var o=t("linky")(e,"_blank");return n.trustAsHtml(o)}}]),ppmessageModule.controller("ContactListCtrl",["$scope","$timeout","$rootScope","$stateParams","yvSys","yvUser","yvLink","yvBase","yvLogin",function(e,t,n,o,i,r,a,s,u){function c(){e.contacts=s.get_list("contact"),i.in_pc()&&t(function(){n.$broadcast("event:view-contact",o.contact_uuid)})}e.$on("event:reload",function(){c()}),e.$on("$ionicView.beforeEnter",function(e,t){u.check_session()}),e.showContact=function(e){return e.uuid!==r.get("uuid")},c()}]),ppmessageModule.controller("ContactCtrl",["$scope","$state","$timeout","$stateParams","yvSys","yvLink","yvMain","yvUser","yvBase","yvConstants",function(e,t,n,o,i,r,a,s,u,c){function l(e){var o={conv_uuid:e.uuid,conv_type:e.type,user_uuid:e.user_uuid};i.in_pc()?t.go("app.conversation-list",o):(t.go("app.conversation-list-mobile"),n(function(){t.go("app.conversation-mobile",o)}))}function _(t){t?e.contact=u.get("contact",t):e.contact={}}e.chatWithContact=function(){var t={member_list:[e.contact.uuid],conversation_name:e.contact.fullname,conversation_type:c.CONVERSATION_TYPE.S2S};a.open_conversation(t,l)},e.getIcon=function(){var t=u.get("object",e.contact.uuid,"icon");return r.get_user_icon(t)},e.$on("event:view-contact",function(e,t){_(t)}),_(o.contact_uuid)}]),ppmessageModule.controller("SettingListCtrl",["$scope","$state","yvSys","yvUser","yvLink","yvLogin","yvLogout",function(e,t,n,o,i,r,a){e.uiPostfix=n.in_mobile()?"-mobile":"",e.$on("$ionicView.beforeEnter",function(e,t){r.check_session()}),e.logoutDeviceUser=function(){a.logout()},e.getDeviceUserIcon=function(){return i.current_user_avatar()},e.getDeviceUserFullName=function(){return o.get("fullname")},e.getSignature=function(){return o.get("signature")},e.changeAvatar=function(){n.in_mobile_app()||t.go("app.change-avatar"+e.uiPostfix)},e.showImageModal=function(){var t=e.$on("$stateChangeStart",function(n){n.preventDefault(),e.$broadcast("event:show-image-modal"),t()})}}]),ppmessageModule.controller("SwitchLanguageCtrl",["$scope","$state","$timeout","$ionicHistory","yvNav","yvSys","yvAlert","yvLocal",function(e,t,n,o,i,r,a,s){function u(n){e.active_language=n,a.success(),r.in_mobile()&&i.clear(function(){i.disable_back(),t.go("app.setting-list-mobile")})}function c(t){t=s.filter_language(t),angular.forEach(e.languageList,function(n){n.language===t&&(e.active_language=n.language,n.is_selected=!0)})}function l(){return e.languageList=[{display_name:"app.settings.language.ENGLISH_TAG",language:"en",is_selected:!1},{display_name:"app.settings.language.CHINESE_TAG",language:"zh-Hans",is_selected:!1}],r.in_mobile_app()?void navigator.globalization.getPreferredLanguage(function(e){n(function(){c(e.value)})}):void s.get_current_language(c)}e.select=function(t){if(e.active_language!==t.language){if(r.in_mobile_app())return void navigator.globalization.setPreferredLanguage(t.language,function(){s.localize(function(){u(t.language)})});s.localize_by_language(t.language),u(t.language)}},l()}]),ppmessageModule.controller("SwitchAppCtrl",["$scope","$state","$timeout","$rootScope","$ionicHistory","yvDB","yvAPI","yvSys","yvMain","yvUser","yvAlert",function(e,t,n,o,i,r,a,s,u,c,l){function _(e,t){return e.app_name<t.app_name?-1:e.app_name===t.app_name?0:1}function d(){e.apps=[],e.active_app_key=c.get("app").app_key,a.get_app_list(c.get("uuid"),function(t){angular.forEach(t.list,function(t,n){(t.is_service_user||t.is_owner_user)&&e.apps.push(t)}),e.apps.sort(_)})}e.isAppChecked=function(t){return t.app_key===e.active_app_key},e.selectApp=function(n){e.active_app_key!==n.app_key&&(e.active_app_key=n.app_key,c.set("app",n),r.set_active_app(n),r.init_userdb(c.get("uuid"),function(){u.reload(),l.success(),o.$broadcast("event:reload"),t.go("app.conversation-list")}))},e.$on("$ionicView.enter",function(e){d()})}]),ppmessageModule.controller("AboutCtrl",["$scope","$filter","yvSys","yvUpdater",function(e,t,n,o){function i(t){e.plist_url=t.plist_url,e.download_url=t.download_url,e.newest_version=t.newest_version}function r(){o.check_version(function(t){e.is_newest=!1,i(t),e.button_text="app.settings.about.UPGRADE_TO_VERSION_TAG"},function(t){e.is_newest=!0,i(t),e.button_text="app.settings.about.IS_NEWEST_VERSION_TAG"},function(t){e.button_text="app.settings.about.CANT_GET_NEWEST_VERSION_TAG"})}function a(){return e.is_newest=!0,e.button_text="",e.local_version="",e.newest_version="",e.app_name=n.get_bundle_info().display_name,n.has_db()?(e.local_version=o.current_version(),void r()):void(e.local_version="v"+ppmessage.version)}e.downloadUpdate=function(){var t={download_url:e.download_url,plist_url:e.plist_url};o.download_update(t)},e.getButtonText=function(){var n=t("translate")(e.button_text);return!e.is_newest&&e.newest_version?n+e.newest_version:n},e.showUpdateButton=function(){return!n.in_browser()},a()}]),ppmessageModule.controller("ChangeAvatarCtrl",["$scope","$timeout","FileUploader","$ionicLoading","yvSys","yvAPI","yvUser","yvMain","yvFile","yvLocal","yvDelegate",function(e,t,n,o,i,r,a,s,u,c,l){function _(t){var n=c.translate("app.settings.profile_photo.LOADING_TAG"),i="<p>"+n+"</p>";o.show({delay:100,scope:e,duration:1e4,noBackdrop:!0,template:i})}function d(e){o.hide()}function p(n){t(function(){e.imgSrc=n.target.result})}function f(e){}function E(e){return e&&e.readyState===FileReader.LOADING?(e.abort(),!0):!1}function m(e){O&&(y=e,E(O),O.readAsDataURL(e._file))}function v(t,n,o,i){if(t===y){var a=n.fuuid;r.update_user({user_icon:a},function(t){s.update_current_user("icon",a),e.restore()})}}function g(e,t,n,o){console.error("upload item error",e,t)}function T(e){y&&(y._file=e,y.upload())}function S(){e.imgSrc=null,E(O),e.uploader.clearQueue(),l.scroll_top("change-avatar",!0)}function A(n,o){n.stopPropagation(),e.isDirty===!o&&t(function(){e.isDirty=o})}var y=null,O=new FileReader;e.imgSrc=null,e.isDirty=!1,e.uploader=new n,e.uploaderOptions={url:r.get_server().upload_url,formData:[{user_uuid:a.get("uuid")}]},O.onloadstart=_,O.onprogress=f,O.onloadend=d,O.onload=p,e.uploader.onAfterAddingFile=m,e.uploader.onSuccessItem=v,e.uploader.onErrorItem=g,e.$on("event:set-dirty",A),e.choosePhoto=function(){if(!E(O)&&(i.in_browser()||i.in_electron())){var e=document.querySelector("input#upload-avatar");return void(e&&e.click())}},e.save=function(){e.$broadcast("event:crop-avatar",T)},e.restore=function(){e.$broadcast("event:restore-avatar",S)}}]),ppmessageModule.controller("ChangeFullnameCtrl",["$scope","$ionicHistory","yvAPI","yvUser","yvMain","yvAlert","yvConstants",function(e,t,n,o,i,r,a){e.fullname={},e.fullname.text=o.get("fullname");var s=function(e){n.update_user({user_fullname:e},function(n){i.update_current_user("fullname",e),r.success(),t.goBack()},function(){r.fail()},function(){r.fail()})};e.shouldShowSave=function(){return 0==e.fullname.text.length},e.save=function(){var t=e.fullname.text.length;return 0==t?void r.tip("app.changefullnamectrl.FULLNAME_EMPTY"):t>32?void r.tip("app.changefullnamectrl.FULLNAME_TOO_LARGE"):t>0&&32>=t?void s(e.fullname.text):void 0}}]),ppmessageModule.controller("ChangeSignatureCtrl",["$scope","$ionicLoading","$ionicHistory","yvSys","yvAPI","yvUser","yvMain","yvLocal",function(e,t,n,o,i,r,a,s){function u(e){t.show({duration:1e3,noBackdrop:!0,template:s.translate(e)})}function c(){u("app.GLOBAL.UPDATE_FAILED")}e.data={signature:r.get("signature")||""},e.save=function(){var t=e.data.signature;i.update_user({user_signature:t},function(e){a.update_current_user("signature",t),u("app.GLOBAL.UPDATE_SUCCESS"),o.in_mobile()&&n.goBack()},c,c)},e.disableSave=function(){var t=e.data.signature;return!!(t&&t.length>50||t===r.get("signature"))}}]),ppmessageModule.controller("PushNotificationCtrl",["$scope","$ionicLoading","yvSys","yvAPI","yvUser","yvLog","yvMain","yvPush","yvAlert","yvConstants",function(e,t,n,o,i,r,a,s,u,c){function l(){return null!==T.show_badge?_():void o.get_user_info(T.uuid,function(e){T.show_badge=!!e.user_show_badge,T.is_distributor_user=!!reponse.is_distributor_user,T.mute_notification=!!e.user_mute_notification,T.silence_notification=!!e.user_silence_notification,T.mute_other_mobile_device=!!e.user_mute_other_mobile_device,_()})}function _(){return n.in_mobile_app()?void(e.settings=[S,A,O,y]):void(e.settings=[h,y])}function d(e){return{key:e,value:T[e],on_change:p,title:"app.GLOBAL."+e.toUpperCase(),note:"app.GLOBAL."+e.toUpperCase()+"_NOTE"}}function p(){var e=this.key,t=!!this.value;"mute_notification"===e&&1==t&&(O.value&&(O.value=!1),f(O.key,!1)),"silence_notification"===e&&1==t&&(A.value&&(A.value=!1),f(A.key,!1)),f(e,t)}function f(e,t){var n={};"is_distributor_user"===e?n[e]=t:n["user_"+e]=t,o.update_user(n,function(){a.update_noti_settings(e,t)})}function E(){r.red("set up failed",e.notification.new_type),e.notification.new_type=e.notification.type,t.hide(),u.tip("app.GLOBAL.NOTIFICATION_CHANGE_FAIL")}function m(){r.green("set up successfully",e.notification.new_type),e.notification.type=e.notification.new_type,a.update_android_notification_type(e.notification.type),t.hide(),u.tip("app.GLOBAL.NOTIFICATION_CHANGE_SUCCESS")}function v(){t.show({duration:3e4}),s.register_push(function(e){s.disconnect_mqtt(function(){var t={device_android_gcmpush:!0,device_android_gcmtoken:e};o.update_device_info(t,m,E,E)},E)},E)}function g(){t.show({duration:3e4}),s.connect_mqtt(function(){s.unregister_push(null,null,function(){var e={device_android_gcmpush:!1};o.update_device_info(e,m,E,E)},E)},E)}var T=i.get(),S=d("show_badge"),A=d("mute_notification"),y=d("is_distributor_user"),O=d("silence_notification"),h=d("mute_other_mobile_device");e.notification={type:i.get("android_notification_type"),new_type:i.get("android_notification_type")},e.showNotification=n.in_android_app(),l(),e.chooseNotification=function(){var t=c.NOTIFICATION_TYPE.GCM,n=c.NOTIFICATION_TYPE.MQTT;switch(e.notification.new_type){case t:e.notification.type!==t&&v();break;case n:e.notification.type!==n&&g()}}}]);